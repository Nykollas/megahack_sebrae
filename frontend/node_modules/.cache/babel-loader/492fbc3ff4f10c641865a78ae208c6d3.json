{"ast":null,"code":"'use strict';\n\nvar _createClass = function () {\n  function defineProperties(target, props) {\n    for (var i = 0; i < props.length; i++) {\n      var descriptor = props[i];\n      descriptor.enumerable = descriptor.enumerable || false;\n      descriptor.configurable = true;\n      if (\"value\" in descriptor) descriptor.writable = true;\n      Object.defineProperty(target, descriptor.key, descriptor);\n    }\n  }\n\n  return function (Constructor, protoProps, staticProps) {\n    if (protoProps) defineProperties(Constructor.prototype, protoProps);\n    if (staticProps) defineProperties(Constructor, staticProps);\n    return Constructor;\n  };\n}();\n\nfunction _toConsumableArray(arr) {\n  if (Array.isArray(arr)) {\n    for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) {\n      arr2[i] = arr[i];\n    }\n\n    return arr2;\n  } else {\n    return Array.from(arr);\n  }\n}\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _possibleConstructorReturn(self, call) {\n  if (!self) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n\n  return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self;\n}\n\nfunction _inherits(subClass, superClass) {\n  if (typeof superClass !== \"function\" && superClass !== null) {\n    throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass);\n  }\n\n  subClass.prototype = Object.create(superClass && superClass.prototype, {\n    constructor: {\n      value: subClass,\n      enumerable: false,\n      writable: true,\n      configurable: true\n    }\n  });\n  if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass;\n}\n\nvar DefaultBackoff = require('backoff');\n\nvar _require = require('@twilio/webrtc'),\n    DefaultMediaStream = _require.MediaStream,\n    DefaultRTCIceCandidate = _require.RTCIceCandidate,\n    DefaultRTCPeerConnection = _require.RTCPeerConnection,\n    DefaultRTCSessionDescription = _require.RTCSessionDescription,\n    getStatistics = _require.getStats;\n\nvar _require2 = require('@twilio/webrtc/lib/util'),\n    guessBrowser = _require2.guessBrowser;\n\nvar _require3 = require('@twilio/webrtc/lib/util/sdp'),\n    getSdpFormat = _require3.getSdpFormat;\n\nvar _require4 = require('../../util/constants'),\n    DEFAULT_ICE_GATHERING_TIMEOUT_MS = _require4.DEFAULT_ICE_GATHERING_TIMEOUT_MS,\n    DEFAULT_LOG_LEVEL = _require4.DEFAULT_LOG_LEVEL,\n    DEFAULT_SESSION_TIMEOUT_SEC = _require4.DEFAULT_SESSION_TIMEOUT_SEC,\n    iceRestartBackoffConfig = _require4.iceRestartBackoffConfig;\n\nvar _require5 = require('../../util/sdp'),\n    createCodecMapForMediaSection = _require5.createCodecMapForMediaSection,\n    getMediaSections = _require5.getMediaSections,\n    revertSimulcastForNonVP8MediaSections = _require5.revertSimulcastForNonVP8MediaSections,\n    setBitrateParameters = _require5.setBitrateParameters,\n    setCodecPreferences = _require5.setCodecPreferences,\n    setSimulcast = _require5.setSimulcast,\n    unifiedPlanAddOrRewriteNewTrackIds = _require5.unifiedPlanAddOrRewriteNewTrackIds,\n    unifiedPlanAddOrRewriteTrackIds = _require5.unifiedPlanAddOrRewriteTrackIds,\n    unifiedPlanFilterLocalCodecs = _require5.unifiedPlanFilterLocalCodecs;\n\nvar DefaultTimeout = require('../../util/timeout');\n\nvar _require6 = require('../../util/twilio-video-errors'),\n    MediaClientLocalDescFailedError = _require6.MediaClientLocalDescFailedError,\n    MediaClientRemoteDescFailedError = _require6.MediaClientRemoteDescFailedError;\n\nvar _require7 = require('../../util'),\n    buildLogLevels = _require7.buildLogLevels,\n    isChromeScreenShareTrack = _require7.isChromeScreenShareTrack,\n    oncePerTick = _require7.oncePerTick;\n\nvar IceBox = require('./icebox');\n\nvar DefaultIceConnectionMonitor = require('./iceconnectionmonitor.js');\n\nvar DataTrackReceiver = require('../../data/receiver');\n\nvar MediaTrackReceiver = require('../../media/track/receiver');\n\nvar StateMachine = require('../../statemachine');\n\nvar Log = require('../../util/log');\n\nvar IdentityTrackMatcher = require('../../util/sdp/trackmatcher/identity');\n\nvar OrderedTrackMatcher = require('../../util/sdp/trackmatcher/ordered');\n\nvar MIDTrackMatcher = require('../../util/sdp/trackmatcher/mid');\n\nvar workaroundIssue8329 = require('../../util/sdp/issue8329');\n\nvar guess = guessBrowser();\nvar isChrome = guess === 'chrome';\nvar isFirefox = guess === 'firefox';\nvar isSafari = guess === 'safari';\nvar isRTCRtpSenderParamsSupported = typeof RTCRtpSender !== 'undefined' && typeof RTCRtpSender.prototype.getParameters === 'function' && typeof RTCRtpSender.prototype.setParameters === 'function';\nvar nInstances = 0;\n/*\nPeerConnectionV2 States\n-----------------------\n\n    +------+    +--------+\n    |      |    |        |\n    | open |--->| closed |\n    |      |    |        |\n    +------+    +--------+\n      |  ^          ^\n      |  |          |\n      |  |          |\n      v  |          |\n  +----------+      |\n  |          |      |\n  | updating |------+\n  |          |\n  +----------+\n\n*/\n\nvar states = {\n  open: ['closed', 'updating'],\n  updating: ['closed', 'open'],\n  closed: []\n};\n/**\n * @extends StateMachine\n * @property {id}\n * @emits PeerConnectionV2#connectionStateChanged\n * @emits PeerConnectionV2#iceConnectionStateChanged\n * @emits PeerConnectionV2#candidates\n * @emits PeerConnectionV2#description\n */\n\nvar PeerConnectionV2 = function (_StateMachine) {\n  _inherits(PeerConnectionV2, _StateMachine);\n  /**\n   * Construct a {@link PeerConnectionV2}.\n   * @param {string} id\n   * @param {EncodingParametersImpl} encodingParameters\n   * @param {PreferredCodecs} preferredCodecs\n   * @param {object} [options]\n   */\n\n\n  function PeerConnectionV2(id, encodingParameters, preferredCodecs, options) {\n    _classCallCheck(this, PeerConnectionV2);\n\n    var _this = _possibleConstructorReturn(this, (PeerConnectionV2.__proto__ || Object.getPrototypeOf(PeerConnectionV2)).call(this, 'open', states));\n\n    options = Object.assign({\n      enableDscp: false,\n      dummyAudioMediaStreamTrack: null,\n      isChromeScreenShareTrack: isChromeScreenShareTrack,\n      iceServers: [],\n      isRTCRtpSenderParamsSupported: isRTCRtpSenderParamsSupported,\n      logLevel: DEFAULT_LOG_LEVEL,\n      offerOptions: {},\n      revertSimulcastForNonVP8MediaSections: revertSimulcastForNonVP8MediaSections,\n      sessionTimeout: DEFAULT_SESSION_TIMEOUT_SEC * 1000,\n      setBitrateParameters: setBitrateParameters,\n      setCodecPreferences: setCodecPreferences,\n      setSimulcast: setSimulcast,\n      Backoff: DefaultBackoff,\n      IceConnectionMonitor: DefaultIceConnectionMonitor,\n      MediaStream: DefaultMediaStream,\n      RTCIceCandidate: DefaultRTCIceCandidate,\n      RTCPeerConnection: DefaultRTCPeerConnection,\n      RTCSessionDescription: DefaultRTCSessionDescription,\n      Timeout: DefaultTimeout\n    }, options);\n    var configuration = getConfiguration(options);\n    var sdpFormat = getSdpFormat(configuration.sdpSemantics);\n    var isUnifiedPlan = sdpFormat === 'unified';\n    var localMediaStream = isUnifiedPlan ? null : new options.MediaStream();\n    var logLevels = buildLogLevels(options.logLevel);\n    var RTCPeerConnection = options.RTCPeerConnection;\n\n    if (options.enableDscp === true) {\n      options.chromeSpecificConstraints = options.chromeSpecificConstraints || {};\n      options.chromeSpecificConstraints.optional = options.chromeSpecificConstraints.optional || [];\n      options.chromeSpecificConstraints.optional.push({\n        googDscp: true\n      });\n    }\n\n    var log = options.log ? options.log.createLog('signaling', _this) : new Log('webrtc', _this, logLevels);\n    var peerConnection = new RTCPeerConnection(configuration, options.chromeSpecificConstraints);\n\n    if (options.dummyAudioMediaStreamTrack) {\n      peerConnection.addTrack(options.dummyAudioMediaStreamTrack, localMediaStream || new options.MediaStream());\n    }\n\n    Object.defineProperties(_this, {\n      _appliedTrackIdsToAttributes: {\n        value: new Map(),\n        writable: true\n      },\n      _dataChannels: {\n        value: new Map()\n      },\n      _dataTrackReceivers: {\n        value: new Set()\n      },\n      _descriptionRevision: {\n        writable: true,\n        value: 0\n      },\n      _didGenerateLocalCandidates: {\n        writable: true,\n        value: false\n      },\n      _enableDscp: {\n        value: options.enableDscp\n      },\n      _encodingParameters: {\n        value: encodingParameters\n      },\n      _isChromeScreenShareTrack: {\n        value: options.isChromeScreenShareTrack\n      },\n      _iceGatheringFailed: {\n        value: false,\n        writable: true\n      },\n      _iceGatheringTimeout: {\n        value: new options.Timeout(function () {\n          return _this._handleIceGatheringTimeout();\n        }, DEFAULT_ICE_GATHERING_TIMEOUT_MS, false)\n      },\n      _iceRestartBackoff: {\n        value: options.Backoff.exponential(iceRestartBackoffConfig)\n      },\n      _instanceId: {\n        value: ++nInstances\n      },\n      _isIceConnectionInactive: {\n        writable: true,\n        value: false\n      },\n      _isIceLite: {\n        writable: true,\n        value: false\n      },\n      _isIceRestartBackoffInProgress: {\n        writable: true,\n        value: false\n      },\n      _isRestartingIce: {\n        writable: true,\n        value: false\n      },\n      _isUnifiedPlan: {\n        value: isUnifiedPlan\n      },\n      _isRTCRtpSenderParamsSupported: {\n        value: options.isRTCRtpSenderParamsSupported\n      },\n      _lastIceConnectionState: {\n        writable: true,\n        value: null\n      },\n      _lastStableDescriptionRevision: {\n        writable: true,\n        value: 0\n      },\n      _localCandidates: {\n        writable: true,\n        value: []\n      },\n      _localCodecs: {\n        value: new Set()\n      },\n      _localCandidatesRevision: {\n        writable: true,\n        value: 1\n      },\n      _localDescriptionWithoutSimulcast: {\n        writable: true,\n        value: null\n      },\n      _localDescription: {\n        writable: true,\n        value: null\n      },\n      _localMediaStream: {\n        value: localMediaStream\n      },\n      _localUfrag: {\n        writable: true,\n        value: null\n      },\n      _log: {\n        value: log\n      },\n      _remoteCodecMaps: {\n        value: new Map()\n      },\n      _rtpSenders: {\n        value: new Map()\n      },\n      _iceConnectionMonitor: {\n        value: new options.IceConnectionMonitor(peerConnection)\n      },\n      _mediaTrackReceivers: {\n        value: new Set()\n      },\n      _needsAnswer: {\n        writable: true,\n        value: false\n      },\n      _negotiationRole: {\n        writable: true,\n        value: null\n      },\n      _offerOptions: {\n        writable: true,\n        value: options.offerOptions\n      },\n      _peerConnection: {\n        value: peerConnection\n      },\n      _preferredAudioCodecs: {\n        value: preferredCodecs.audio\n      },\n      _preferredVideoCodecs: {\n        value: preferredCodecs.video\n      },\n      _shouldApplySimulcast: {\n        value: (isChrome || isSafari) && preferredCodecs.video.some(function (codecSettings) {\n          return codecSettings.codec.toLowerCase() === 'vp8' && codecSettings.simulcast;\n        })\n      },\n      _queuedDescription: {\n        writable: true,\n        value: null\n      },\n      _iceReconnectTimeout: {\n        value: new options.Timeout(function () {\n          log.debug('ICE reconnect timed out');\n\n          _this.close();\n        }, options.sessionTimeout, false)\n      },\n      _recycledTransceivers: {\n        value: {\n          audio: [],\n          video: []\n        }\n      },\n      _replaceTrackPromises: {\n        value: new Map()\n      },\n      _remoteCandidates: {\n        writable: true,\n        value: new IceBox()\n      },\n      _sdpFormat: {\n        value: sdpFormat\n      },\n      _setBitrateParameters: {\n        value: options.setBitrateParameters\n      },\n      _setCodecPreferences: {\n        value: options.setCodecPreferences\n      },\n      _setSimulcast: {\n        value: options.setSimulcast\n      },\n      _revertSimulcastForNonVP8MediaSections: {\n        value: options.revertSimulcastForNonVP8MediaSections\n      },\n      _RTCIceCandidate: {\n        value: options.RTCIceCandidate\n      },\n      _RTCPeerConnection: {\n        value: options.RTCPeerConnection\n      },\n      _RTCSessionDescription: {\n        value: options.RTCSessionDescription\n      },\n      _shouldOffer: {\n        writable: true,\n        value: false\n      },\n      _shouldRestartIce: {\n        writable: true,\n        value: false\n      },\n      _trackIdsToAttributes: {\n        value: new Map(),\n        writable: true\n      },\n      _trackMatcher: {\n        writable: true,\n        value: null\n      },\n      id: {\n        enumerable: true,\n        value: id\n      }\n    });\n    encodingParameters.on('changed', oncePerTick(function () {\n      if (_this._isRTCRtpSenderParamsSupported) {\n        if (!_this._needsAnswer) {\n          updateEncodingParameters(_this);\n        }\n\n        return;\n      }\n\n      _this.offer();\n    }));\n    peerConnection.addEventListener('connectionstatechange', _this._handleConnectionStateChange.bind(_this));\n    peerConnection.addEventListener('datachannel', _this._handleDataChannelEvent.bind(_this));\n    peerConnection.addEventListener('icecandidate', _this._handleIceCandidateEvent.bind(_this));\n    peerConnection.addEventListener('iceconnectionstatechange', _this._handleIceConnectionStateChange.bind(_this));\n    peerConnection.addEventListener('icegatheringstatechange', _this._handleIceGatheringStateChange.bind(_this));\n    peerConnection.addEventListener('signalingstatechange', _this._handleSignalingStateChange.bind(_this));\n    peerConnection.addEventListener('track', _this._handleTrackEvent.bind(_this));\n\n    _this._iceRestartBackoff.on('ready', function () {\n      return _this._initiateIceRestart();\n    });\n\n    var self = _this;\n\n    _this.on('stateChanged', function stateChanged(state) {\n      if (state !== 'closed') {\n        return;\n      }\n\n      self.removeListener('stateChanged', stateChanged);\n\n      self._dataChannels.forEach(function (dataChannel, dataTrackSender) {\n        self.removeDataTrackSender(dataTrackSender);\n      });\n    });\n\n    return _this;\n  }\n\n  _createClass(PeerConnectionV2, [{\n    key: 'toString',\n    value: function toString() {\n      return '[PeerConnectionV2 #' + this._instanceId + ': ' + this.id + ']';\n    }\n    /**\n     * The {@link PeerConnectionV2}'s underlying RTCPeerConnection's RTCPeerConnectionState\n     * if supported by the browser, its RTCIceConnectionState otherwise.\n     * @property {RTCPeerConnectionState}\n     */\n\n  }, {\n    key: '_addIceCandidate',\n\n    /**\n     * Add an ICE candidate to the {@link PeerConnectionV2}.\n     * @private\n     * @param {object} candidate\n     * @returns {Promise<void>}\n     */\n    value: function _addIceCandidate(candidate) {\n      var _this2 = this;\n\n      return Promise.resolve().then(function () {\n        candidate = new _this2._RTCIceCandidate(candidate);\n        return _this2._peerConnection.addIceCandidate(candidate);\n      }).catch(function (error) {\n        // NOTE(mmalavalli): Firefox 68+ now generates an RTCIceCandidate with an\n        // empty candidate string to signal end-of-candidates, followed by a null\n        // candidate. As of now, Chrome and Safari reject this RTCIceCandidate. Since\n        // this does not affect the media connection between Firefox 68+ and Chrome/Safari\n        // in Peer-to-Peer Rooms, we suppress the Error and log a warning message.\n        //\n        // Chrome bug: https://bugs.chromium.org/p/chromium/issues/detail?id=978582\n        //\n        _this2._log.warn('Failed to add RTCIceCandidate ' + (candidate ? '\"' + candidate.candidate + '\"' : 'null') + ': ' + error.message);\n      });\n    }\n    /**\n     * Add ICE candidates to the {@link PeerConnectionV2}.\n     * @private\n     * @param {Array<object>} candidates\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_addIceCandidates',\n    value: function _addIceCandidates(candidates) {\n      return Promise.all(candidates.map(this._addIceCandidate, this)).then(function () {});\n    }\n    /**\n     * Add a new RTCRtpTransceiver or update an existing RTCRtpTransceiver for the\n     * given MediaStreamTrack.\n     * @private\n     * @param {MediaStreamTrack} track\n     * @returns {RTCRtpTransceiver}\n     */\n\n  }, {\n    key: '_addOrUpdateTransceiver',\n    value: function _addOrUpdateTransceiver(track) {\n      var _this3 = this;\n\n      var transceiver = takeRecycledTransceiver(this, track.kind);\n\n      if (transceiver && transceiver.sender) {\n        var oldTrackId = transceiver.sender.track ? transceiver.sender.track.id : null;\n\n        if (oldTrackId) {\n          this._log.warn('Reusing transceiver: ' + transceiver.mid + '] ' + oldTrackId + ' => ' + track.id);\n        } // NOTE(mpatwardhan):remember this transceiver while we replace track.\n        // we recycle transceivers that are not in use after 'negotiationCompleted', but we want to prevent\n        // this one from getting recycled while replaceTrack is pending.\n\n\n        this._replaceTrackPromises.set(transceiver, transceiver.sender.replaceTrack(track).then(function () {\n          transceiver.direction = 'sendrecv';\n        }, function () {// Do nothing.\n        }).finally(function () {\n          _this3._replaceTrackPromises.delete(transceiver);\n        }));\n\n        return transceiver;\n      }\n\n      return this._peerConnection.addTransceiver(track);\n    }\n    /**\n     * Check the {@link IceBox}.\n     * @private\n     * @param {RTCSessionDescriptionInit} description\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_checkIceBox',\n    value: function _checkIceBox(description) {\n      var ufrag = getUfrag(description);\n\n      if (!ufrag) {\n        return Promise.resolve();\n      }\n\n      var candidates = this._remoteCandidates.setUfrag(ufrag);\n\n      return this._addIceCandidates(candidates);\n    }\n    /**\n     * Create an answer and set it on the {@link PeerConnectionV2}.\n     * @private\n     * @param {RTCSessionDescriptionInit} offer\n     * @returns {Promise<boolean>}\n     */\n\n  }, {\n    key: '_answer',\n    value: function _answer(offer) {\n      var _this4 = this;\n\n      return Promise.resolve().then(function () {\n        if (!_this4._negotiationRole) {\n          _this4._negotiationRole = 'answerer';\n        }\n\n        return _this4._setRemoteDescription(offer);\n      }).catch(function () {\n        throw new MediaClientRemoteDescFailedError();\n      }).then(function () {\n        return _this4._peerConnection.createAnswer();\n      }).then(function (answer) {\n        if (!isFirefox) {\n          answer = workaroundIssue8329(answer);\n        }\n\n        var description = answer;\n\n        if (_this4._shouldApplySimulcast) {\n          var updatedSdp = _this4._setSimulcast(answer.sdp, _this4._sdpFormat, _this4._trackIdsToAttributes); // NOTE(syerrapragada): VMS does not support H264 simulcast. So,\n          // unset simulcast for sections in local offer where corresponding\n          // sections in answer doesn't have vp8 as preferred codec and reapply offer.\n\n\n          updatedSdp = _this4._revertSimulcastForNonVP8MediaSections(updatedSdp, answer.sdp, offer.sdp);\n          description = {\n            type: description.type,\n            sdp: updatedSdp\n          };\n        }\n\n        return _this4._setLocalDescription(description);\n      }).then(function () {\n        return _this4._checkIceBox(offer);\n      }).then(function () {\n        return _this4._queuedDescription && _this4._updateDescription(_this4._queuedDescription);\n      }).then(function () {\n        _this4._queuedDescription = null;\n        return _this4._maybeReoffer(_this4._peerConnection.localDescription);\n      }).catch(function (error) {\n        throw error instanceof MediaClientRemoteDescFailedError ? error : new MediaClientLocalDescFailedError();\n      });\n    }\n    /**\n     * Close the underlying RTCPeerConnection. Returns false if the\n     * RTCPeerConnection was already closed.\n     * @private\n     * @returns {boolean}\n     */\n\n  }, {\n    key: '_close',\n    value: function _close() {\n      if (this._peerConnection.signalingState !== 'closed') {\n        this._peerConnection.close();\n\n        this.preempt('closed');\n        return true;\n      }\n\n      return false;\n    }\n    /**\n     * Handle a \"connectionstatechange\" event.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleConnectionStateChange',\n    value: function _handleConnectionStateChange() {\n      this.emit('connectionStateChanged');\n    }\n    /**\n     * Handle a \"datachannel\" event.\n     * @private\n     * @param {RTCDataChannelEvent} event\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleDataChannelEvent',\n    value: function _handleDataChannelEvent(event) {\n      var _this5 = this;\n\n      var dataChannel = event.channel;\n      var dataTrackReceiver = new DataTrackReceiver(dataChannel);\n\n      this._dataTrackReceivers.add(dataTrackReceiver);\n\n      dataChannel.addEventListener('close', function () {\n        _this5._dataTrackReceivers.delete(dataTrackReceiver);\n      });\n      this.emit('trackAdded', dataTrackReceiver);\n    }\n    /**\n     * Handle a glare scenario on the {@link PeerConnectionV2}.\n     * @private\n     * @param {RTCSessionDescriptionInit} offer\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_handleGlare',\n    value: function _handleGlare(offer) {\n      var _this6 = this;\n\n      this._log.debug('Glare detected; rolling back');\n\n      if (this._isRestartingIce) {\n        this._log.debug('An ICE restart was in progress; we\\'ll need to restart ICE again after rolling back');\n\n        this._isRestartingIce = false;\n        this._shouldRestartIce = true;\n      }\n\n      return Promise.resolve().then(function () {\n        _this6._trackIdsToAttributes = new Map(_this6._appliedTrackIdsToAttributes);\n        return _this6._setLocalDescription({\n          type: 'rollback'\n        });\n      }).then(function () {\n        _this6._needsAnswer = false;\n        return _this6._answer(offer);\n      }).then(function (didReoffer) {\n        return didReoffer ? Promise.resolve() : _this6._offer();\n      });\n    }\n    /**\n     * Handle an ICE candidate event.\n     * @private\n     * @param {Event} event\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleIceCandidateEvent',\n    value: function _handleIceCandidateEvent(event) {\n      if (event.candidate) {\n        this._log.debug('Clearing ICE gathering timeout');\n\n        this._didGenerateLocalCandidates = true;\n\n        this._iceGatheringTimeout.clear();\n\n        this._localCandidates.push(event.candidate);\n      }\n\n      var peerConnectionState = {\n        ice: {\n          candidates: this._isIceLite ? [] : this._localCandidates.slice(),\n          ufrag: this._localUfrag\n        },\n        id: this.id\n      };\n\n      if (!event.candidate) {\n        peerConnectionState.ice.complete = true;\n      }\n\n      if (!(this._isIceLite && event.candidate)) {\n        peerConnectionState.ice.revision = this._localCandidatesRevision++;\n        this.emit('candidates', peerConnectionState);\n      }\n    }\n    /**\n     * Handle an ICE connection state change event.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleIceConnectionStateChange',\n    value: function _handleIceConnectionStateChange() {\n      var _this7 = this;\n\n      var iceConnectionState = this._peerConnection.iceConnectionState;\n      var isIceConnectedOrComplete = ['connected', 'complete'].includes(iceConnectionState);\n      var log = this._log;\n      log.debug('ICE connection state is \"' + iceConnectionState + '\"');\n\n      if (isIceConnectedOrComplete) {\n        this._iceReconnectTimeout.clear();\n\n        this._iceRestartBackoff.reset();\n      }\n\n      if (this._lastIceConnectionState !== 'failed' && iceConnectionState === 'failed' && !this._shouldRestartIce && !this._isRestartingIce) {\n        // Case 1: Transition to \"failed\".\n        log.warn('ICE failed');\n\n        this._initiateIceRestartBackoff();\n      } else if (['disconnected', 'failed'].includes(this._lastIceConnectionState) && isIceConnectedOrComplete) {\n        // Case 2: Transition from \"disconnected\" or \"failed\".\n        log.debug('ICE reconnected');\n      }\n\n      this._isIceConnectionInactive = false;\n\n      if (iceConnectionState === 'disconnected') {\n        this._iceConnectionMonitor.start(function () {\n          _this7._iceConnectionMonitor.stop();\n\n          if (!_this7._shouldRestartIce && !_this7._isRestartingIce) {\n            log.warn('ICE Connection Monitor detected inactivity');\n            _this7._isIceConnectionInactive = true;\n\n            _this7._initiateIceRestartBackoff();\n\n            _this7.emit('iceConnectionStateChanged');\n\n            _this7.emit('connectionStateChanged');\n          }\n        });\n      } else {\n        this._iceConnectionMonitor.stop();\n      }\n\n      this._lastIceConnectionState = iceConnectionState;\n      this.emit('iceConnectionStateChanged');\n    }\n    /**\n     * Handle ICE gathering timeout.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleIceGatheringTimeout',\n    value: function _handleIceGatheringTimeout() {\n      this._log.warn('ICE failed to gather any local candidates');\n\n      this._iceGatheringFailed = true;\n\n      this._initiateIceRestartBackoff();\n\n      this.emit('iceConnectionStateChanged');\n      this.emit('connectionStateChanged');\n    }\n    /**\n     * Handle an ICE gathering state change event.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleIceGatheringStateChange',\n    value: function _handleIceGatheringStateChange() {\n      var iceGatheringState = this._peerConnection.iceGatheringState;\n      var log = this._log;\n      log.debug('ICE gathering state is \"' + iceGatheringState + '\"'); // NOTE(mmalavalli): Start the ICE gathering timeout only if the RTCPeerConnection\n      // has started gathering candidates for the first time since the initial offer/answer\n      // or an offer/answer with ICE restart.\n\n      var _iceGatheringTimeout = this._iceGatheringTimeout,\n          delay = _iceGatheringTimeout.delay,\n          isSet = _iceGatheringTimeout.isSet;\n\n      if (iceGatheringState === 'gathering' && !this._didGenerateLocalCandidates && !isSet) {\n        log.debug('Starting ICE gathering timeout: ' + delay);\n        this._iceGatheringFailed = false;\n\n        this._iceGatheringTimeout.start();\n      }\n    }\n    /**\n     * Handle a signaling state change event.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleSignalingStateChange',\n    value: function _handleSignalingStateChange() {\n      if (this._peerConnection.signalingState === 'stable') {\n        this._appliedTrackIdsToAttributes = new Map(this._trackIdsToAttributes);\n      }\n    }\n    /**\n     * Handle a track event.\n     * @private\n     * @param {Event} event\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleTrackEvent',\n    value: function _handleTrackEvent(event) {\n      var _this8 = this;\n\n      var sdp = this._peerConnection.remoteDescription ? this._peerConnection.remoteDescription.sdp : null;\n\n      if (!this._trackMatcher) {\n        this._trackMatcher = event.transceiver && event.transceiver.mid ? new MIDTrackMatcher() // NOTE(mroberts): Until Chrome ships RTCRtpTransceivers with MID\n        // support, we have to use the same hacky solution as Safari. Revisit\n        // this when RTCRtpTransceivers and MIDs land. We should be able to use\n        // the same technique as Firefox.\n        : isSafari || this._isUnifiedPlan ? new OrderedTrackMatcher() : new IdentityTrackMatcher();\n      }\n\n      this._trackMatcher.update(sdp);\n\n      var mediaStreamTrack = event.track;\n      var signaledTrackId = this._trackMatcher.match(event) || mediaStreamTrack.id;\n      var mediaTrackReceiver = new MediaTrackReceiver(signaledTrackId, mediaStreamTrack); // NOTE(mmalavalli): In unified plan mode, \"ended\" is not fired on the remote\n      // MediaStreamTrack when the remote peer removes a track. So, when this\n      // MediaStreamTrack is re-used for a different track due to the remote peer\n      // calling RTCRtpSender.replaceTrack(), we delete the previous MediaTrackReceiver\n      // that owned this MediaStreamTrack before adding the new MediaTrackReceiver.\n\n      this._mediaTrackReceivers.forEach(function (trackReceiver) {\n        if (trackReceiver.track.id === mediaTrackReceiver.track.id) {\n          _this8._mediaTrackReceivers.delete(trackReceiver);\n        }\n      });\n\n      this._mediaTrackReceivers.add(mediaTrackReceiver);\n\n      mediaStreamTrack.addEventListener('ended', function () {\n        return _this8._mediaTrackReceivers.delete(mediaTrackReceiver);\n      });\n      this.emit('trackAdded', mediaTrackReceiver);\n    }\n    /**\n     * Initiate ICE Restart.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_initiateIceRestart',\n    value: function _initiateIceRestart() {\n      if (this._peerConnection.signalingState === 'closed') {\n        return;\n      }\n\n      var log = this._log;\n      log.warn('Attempting to restart ICE');\n      this._didGenerateLocalCandidates = false;\n      this._isIceRestartBackoffInProgress = false;\n      this._shouldRestartIce = true;\n      var _iceReconnectTimeout = this._iceReconnectTimeout,\n          delay = _iceReconnectTimeout.delay,\n          isSet = _iceReconnectTimeout.isSet;\n\n      if (!isSet) {\n        log.debug('Starting ICE reconnect timeout: ' + delay);\n\n        this._iceReconnectTimeout.start();\n      }\n\n      this.offer();\n    }\n    /**\n     * Schedule an ICE Restart.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_initiateIceRestartBackoff',\n    value: function _initiateIceRestartBackoff() {\n      if (this._peerConnection.signalingState === 'closed' || this._isIceRestartBackoffInProgress) {\n        return;\n      }\n\n      this._log.warn('An ICE restart has been scheduled');\n\n      this._isIceRestartBackoffInProgress = true;\n\n      this._iceRestartBackoff.backoff();\n    }\n    /**\n     * Conditionally re-offer.\n     * @private\n     * @param {?RTCSessionDescriptionInit} localDescription\n     * @returns {Promise<boolean>}\n     */\n\n  }, {\n    key: '_maybeReoffer',\n    value: function _maybeReoffer(localDescription) {\n      var shouldReoffer = this._shouldOffer;\n\n      if (localDescription && localDescription.sdp) {\n        // NOTE(mmalavalli): For \"unified-plan\" sdps, if the remote RTCPeerConnection sends\n        // an offer with fewer audio m= lines than the number of audio RTCRTPSenders\n        // in the local RTCPeerConnection, then the local RTCPeerConnection creates\n        // an answer with the same number of audio m= lines as in the offer. This\n        // behavior was triggered by the removal of 'offerToReceiveAudio' from the\n        // default RTCOfferOptions. Ideally, the local RTCPeerConnection should create\n        // an answer with the same number of audio m= lines as the number of\n        // RTCRTPSenders. In order to achieve this,the local RTCPeerConnection\n        // initiates renegotiation.\n        //\n        // We can reduce the number of cases where renegotiation is needed by\n        // re-introducing 'offerToReceiveAudio' to the default RTCOfferOptions with a\n        // value > 1.\n        if (this._isUnifiedPlan && localDescription.type === 'answer') {\n          var senders = this._peerConnection.getSenders().filter(function (sender) {\n            return sender.track;\n          });\n\n          shouldReoffer = ['audio', 'video'].reduce(function (shouldOffer, kind) {\n            var mediaSections = getMediaSections(localDescription.sdp, kind, '(sendrecv|sendonly)');\n            var sendersOfKind = senders.filter(isSenderOfKind.bind(null, kind));\n            return shouldOffer || mediaSections.length < sendersOfKind.length;\n          }, shouldReoffer);\n        } // NOTE(mroberts): We also need to re-offer if we have a DataTrack to share\n        // but no m= application section.\n\n\n        var hasDataTrack = this._dataChannels.size > 0;\n        var hasApplicationMediaSection = getMediaSections(localDescription.sdp, 'application').length > 0;\n        var needsApplicationMediaSection = hasDataTrack && !hasApplicationMediaSection;\n        shouldReoffer = shouldReoffer || needsApplicationMediaSection;\n      }\n\n      var promise = shouldReoffer ? this._offer() : Promise.resolve();\n      return promise.then(function () {\n        return shouldReoffer;\n      });\n    }\n    /**\n     * Create an offer and set it on the {@link PeerConnectionV2}.\n     * @private\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_offer',\n    value: function _offer() {\n      var _this9 = this;\n\n      var offerOptions = Object.assign({}, this._offerOptions);\n      this._needsAnswer = true;\n\n      if (this._shouldRestartIce) {\n        this._shouldRestartIce = false;\n        this._isRestartingIce = true;\n        offerOptions.iceRestart = true;\n      }\n\n      return Promise.all(this._replaceTrackPromises.values()).then(function () {\n        return _this9._peerConnection.createOffer(offerOptions);\n      }).catch(function () {\n        throw new MediaClientLocalDescFailedError();\n      }).then(function (offer) {\n        if (!isFirefox) {\n          offer = workaroundIssue8329(offer);\n        }\n\n        var sdp = _this9._isUnifiedPlan && _this9._peerConnection.remoteDescription ? unifiedPlanFilterLocalCodecs(offer.sdp, _this9._peerConnection.remoteDescription.sdp) : offer.sdp;\n\n        var updatedSdp = _this9._setCodecPreferences(sdp, _this9._preferredAudioCodecs, _this9._preferredVideoCodecs);\n\n        _this9._shouldOffer = false;\n\n        if (!_this9._negotiationRole) {\n          _this9._negotiationRole = 'offerer';\n        }\n\n        if (_this9._shouldApplySimulcast) {\n          _this9._localDescriptionWithoutSimulcast = {\n            type: 'offer',\n            sdp: updatedSdp\n          };\n          updatedSdp = _this9._setSimulcast(updatedSdp, _this9._sdpFormat, _this9._trackIdsToAttributes);\n        }\n\n        return _this9._setLocalDescription({\n          type: 'offer',\n          sdp: updatedSdp\n        });\n      });\n    }\n    /**\n     * Add or rewrite local MediaStreamTrack IDs in the given Unified Plan RTCSessionDescription.\n     * @private\n     * @param {RTCSessionDescription} description\n     * @return {RTCSessionDescription}\n     */\n\n  }, {\n    key: '_addOrRewriteLocalTrackIds',\n    value: function _addOrRewriteLocalTrackIds(description) {\n      var transceivers = this._peerConnection.getTransceivers();\n\n      var activeTransceivers = transceivers.filter(function (_ref) {\n        var sender = _ref.sender,\n            stopped = _ref.stopped;\n        return !stopped && sender && sender.track;\n      }); // NOTE(mmalavalli): There is no guarantee that MediaStreamTrack IDs will be present in\n      // SDPs, and even if they are, there is no guarantee that they will be the same as the\n      // actual MediaStreamTrack IDs. So, we add or re-write the actual MediaStreamTrack IDs\n      // to the assigned m= sections here.\n\n      var assignedTransceivers = activeTransceivers.filter(function (_ref2) {\n        var mid = _ref2.mid;\n        return mid;\n      });\n      var midsToTrackIds = new Map(assignedTransceivers.map(function (_ref3) {\n        var mid = _ref3.mid,\n            sender = _ref3.sender;\n        return [mid, sender.track.id];\n      }));\n      var sdp1 = unifiedPlanAddOrRewriteTrackIds(description.sdp, midsToTrackIds); // NOTE(mmalavalli): Chrome and Safari do not apply the offer until they get an answer.\n      // So, we add or re-write the actual MediaStreamTrack IDs to the unassigned m= sections here.\n\n      var unassignedTransceivers = activeTransceivers.filter(function (_ref4) {\n        var mid = _ref4.mid;\n        return !mid;\n      });\n      var newTrackIdsByKind = new Map(['audio', 'video'].map(function (kind) {\n        return [kind, unassignedTransceivers.filter(function (_ref5) {\n          var sender = _ref5.sender;\n          return sender.track.kind === kind;\n        }).map(function (_ref6) {\n          var sender = _ref6.sender;\n          return sender.track.id;\n        })];\n      }));\n      var sdp2 = unifiedPlanAddOrRewriteNewTrackIds(sdp1, midsToTrackIds, newTrackIdsByKind);\n      return new this._RTCSessionDescription({\n        sdp: sdp2,\n        type: description.type\n      });\n    }\n    /**\n     * Rollback and apply the given offer.\n     * @private\n     * @param {RTCSessionDescriptionInit} offer\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_rollbackAndApplyOffer',\n    value: function _rollbackAndApplyOffer(offer) {\n      var _this10 = this;\n\n      return this._setLocalDescription({\n        type: 'rollback'\n      }).then(function () {\n        return _this10._setLocalDescription(offer);\n      });\n    }\n    /**\n     * Set a local description on the {@link PeerConnectionV2}.\n     * @private\n     * @param {RTCSessionDescription|RTCSessionDescriptionInit} description\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_setLocalDescription',\n    value: function _setLocalDescription(description) {\n      var _this11 = this;\n\n      return this._peerConnection.setLocalDescription(description).catch(function (error) {\n        _this11._log.warn('Calling setLocalDescription with an RTCSessionDescription of type \"' + description.type + '\" failed with the error \"' + error.message + '\".');\n\n        if (description.sdp) {\n          _this11._log.warn('The SDP was ' + description.sdp);\n        }\n\n        throw new MediaClientLocalDescFailedError();\n      }).then(function () {\n        if (description.type !== 'rollback') {\n          _this11._localDescription = _this11._isUnifiedPlan ? _this11._addOrRewriteLocalTrackIds(description) : description;\n          _this11._localCandidates = [];\n\n          if (description.type === 'offer') {\n            _this11._descriptionRevision++;\n          } else if (description.type === 'answer') {\n            _this11._lastStableDescriptionRevision = _this11._descriptionRevision;\n            negotiationCompleted(_this11);\n          }\n\n          _this11._localUfrag = getUfrag(description);\n\n          _this11.emit('description', _this11.getState());\n        }\n      });\n    }\n    /**\n     * Set a remote RTCSessionDescription on the {@link PeerConnectionV2}.\n     * @private\n     * @param {RTCSessionDescriptionInit} description\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_setRemoteDescription',\n    value: function _setRemoteDescription(description) {\n      var _this12 = this;\n\n      if (description.sdp) {\n        if (!this._isRTCRtpSenderParamsSupported) {\n          description.sdp = this._setBitrateParameters(description.sdp, isFirefox ? 'TIAS' : 'AS', this._encodingParameters.maxAudioBitrate, this._encodingParameters.maxVideoBitrate);\n        }\n\n        description.sdp = this._setCodecPreferences(description.sdp, this._preferredAudioCodecs, this._preferredVideoCodecs); // NOTE(mroberts): Do this to reduce our MediaStream count in Firefox. By\n        // mapping MediaStream IDs in the SDP to \"-\", we ensure the \"track\" event\n        // doesn't include any new MediaStreams in Firefox. Its `streams` member\n        // will always be the empty Array.\n\n        if (isFirefox) {\n          description.sdp = filterOutMediaStreamIds(description.sdp);\n        }\n\n        if (!this._peerConnection.remoteDescription) {\n          this._isIceLite = /a=ice-lite/.test(description.sdp);\n        }\n      }\n\n      description = new this._RTCSessionDescription(description); // eslint-disable-next-line consistent-return\n\n      return Promise.resolve().then(function () {\n        // NOTE(syerrapragada): VMS does not support H264 simulcast. So,\n        // unset simulcast for sections in local offer where corresponding\n        // sections in answer doesn't have vp8 as preferred codec and reapply offer.\n        if (description.type === 'answer' && _this12._shouldApplySimulcast) {\n          var sdpWithoutSimulcastForNonVP8MediaSections = _this12._revertSimulcastForNonVP8MediaSections(_this12._localDescription.sdp, _this12._localDescriptionWithoutSimulcast.sdp, description.sdp);\n\n          if (sdpWithoutSimulcastForNonVP8MediaSections !== _this12._localDescription.sdp) {\n            return _this12._rollbackAndApplyOffer({\n              type: _this12._localDescription.type,\n              sdp: sdpWithoutSimulcastForNonVP8MediaSections\n            });\n          }\n        }\n      }).then(function () {\n        return _this12._peerConnection.setRemoteDescription(description);\n      }).then(function () {\n        if (description.type === 'answer') {\n          if (_this12._isRestartingIce) {\n            _this12._log.debug('An ICE restart was in-progress and is now completed');\n\n            _this12._isRestartingIce = false;\n          }\n\n          negotiationCompleted(_this12);\n        }\n      }, function (error) {\n        _this12._log.warn('Calling setRemoteDescription with an RTCSessionDescription of type \"' + description.type + '\" failed with the error \"' + error.message + '\".');\n\n        if (description.sdp) {\n          _this12._log.warn('The SDP was ' + description.sdp);\n        }\n\n        throw error;\n      });\n    }\n    /**\n     * Update the {@link PeerConnectionV2}'s description.\n     * @private\n     * @param {RTCSessionDescriptionInit} description\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_updateDescription',\n    value: function _updateDescription(description) {\n      var _this13 = this;\n\n      switch (description.type) {\n        case 'answer':\n        case 'pranswer':\n          if (description.revision !== this._descriptionRevision || this._peerConnection.signalingState !== 'have-local-offer') {\n            return Promise.resolve();\n          }\n\n          this._descriptionRevision = description.revision;\n          break;\n\n        case 'close':\n          return this._close();\n\n        case 'create-offer':\n          if (description.revision <= this._lastStableDescriptionRevision) {\n            return Promise.resolve();\n          } else if (this._needsAnswer) {\n            this._queuedDescription = description;\n            return Promise.resolve();\n          }\n\n          this._descriptionRevision = description.revision;\n          return this._offer();\n\n        case 'offer':\n          if (description.revision <= this._lastStableDescriptionRevision || this._peerConnection.signalingState === 'closed') {\n            return Promise.resolve();\n          }\n\n          if (this._peerConnection.signalingState === 'have-local-offer') {\n            // NOTE(mpatwardhan): For a peer connection\n            // 1) createOffer always generate SDP with `setup:actpass`\n            // 2) when remote description is set `setup:active`  - the answer generated selects the dtls role of setup:passive\n            // 3) when remote description is set `setup:passive` - the answer generated selects the dtls role of setup:active\n            // 4) when remote description is set `setup:actpass` - the answer generated uses the previously negotiated role (if not negotiated previously setup:active is used)\n            // This test shows the  behavior: https://github.com/twilio/twilio-webrtc.js/blob/master/test/integration/spec/rtcpeerconnection.js#L936\n            // with glare handling (if dtls role was not negotiated before ) the generated answer will set setup:active.\n            // we do not want that. lets wait for \"initial negotiation\" before attempting glare handling.\n            if (this._needsAnswer && this._lastStableDescriptionRevision === 0) {\n              this._queuedDescription = description;\n              return Promise.resolve();\n            }\n\n            this._descriptionRevision = description.revision;\n            return this._handleGlare(description);\n          }\n\n          this._descriptionRevision = description.revision;\n          return this._answer(description).then(function () {});\n\n        default: // Do nothing.\n\n      } // Handle answer or pranswer.\n\n\n      var revision = description.revision;\n      return Promise.resolve().then(function () {\n        return _this13._setRemoteDescription(description);\n      }).catch(function () {\n        throw new MediaClientRemoteDescFailedError();\n      }).then(function () {\n        _this13._lastStableDescriptionRevision = revision;\n        _this13._needsAnswer = false;\n        return _this13._checkIceBox(description);\n      }).then(function () {\n        return _this13._queuedDescription && _this13._updateDescription(_this13._queuedDescription);\n      }).then(function () {\n        _this13._queuedDescription = null;\n        return _this13._maybeReoffer(_this13._peerConnection.localDescription).then(function () {});\n      });\n    }\n    /**\n     * Update the {@link PeerConnectionV2}'s ICE candidates.\n     * @private\n     * @param {object} iceState\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_updateIce',\n    value: function _updateIce(iceState) {\n      var candidates = this._remoteCandidates.update(iceState);\n\n      return this._addIceCandidates(candidates);\n    }\n    /**\n     * Add a {@link DataTrackSender} to the {@link PeerConnectionV2}.\n     * @param {DataTrackSender} dataTrackSender\n     * @returns {void}\n     */\n\n  }, {\n    key: 'addDataTrackSender',\n    value: function addDataTrackSender(dataTrackSender) {\n      if (this._dataChannels.has(dataTrackSender)) {\n        return;\n      }\n\n      try {\n        var dataChannelDict = {\n          ordered: dataTrackSender.ordered\n        };\n\n        if (dataTrackSender.maxPacketLifeTime !== null) {\n          dataChannelDict.maxPacketLifeTime = dataTrackSender.maxPacketLifeTime;\n        }\n\n        if (dataTrackSender.maxRetransmits !== null) {\n          dataChannelDict.maxRetransmits = dataTrackSender.maxRetransmits;\n        }\n\n        var dataChannel = this._peerConnection.createDataChannel(dataTrackSender.id, dataChannelDict);\n\n        dataTrackSender.addDataChannel(dataChannel);\n\n        this._dataChannels.set(dataTrackSender, dataChannel);\n      } catch (error) {\n        this._log.warn('Error creating an RTCDataChannel for DataTrack \"' + dataTrackSender.id + '\": ' + error.message);\n      }\n    }\n    /**\n     * Add the {@link MediaTrackSender} to the {@link PeerConnectionV2}.\n     * @param {MediaTrackSender} mediaTrackSender\n     * @returns {void}\n     */\n\n  }, {\n    key: 'addMediaTrackSender',\n    value: function addMediaTrackSender(mediaTrackSender) {\n      if (this._peerConnection.signalingState === 'closed' || this._rtpSenders.has(mediaTrackSender)) {\n        return;\n      }\n\n      var sender = void 0;\n\n      if (this._localMediaStream) {\n        this._localMediaStream.addTrack(mediaTrackSender.track);\n\n        sender = this._peerConnection.addTrack(mediaTrackSender.track, this._localMediaStream);\n      } else {\n        var transceiver = this._addOrUpdateTransceiver(mediaTrackSender.track);\n\n        sender = transceiver.sender;\n      }\n\n      mediaTrackSender.addSender(sender);\n\n      this._rtpSenders.set(mediaTrackSender, sender);\n    }\n    /**\n     * Close the {@link PeerConnectionV2}.\n     * @returns {void}\n     */\n\n  }, {\n    key: 'close',\n    value: function close() {\n      if (this._close()) {\n        this._descriptionRevision++;\n        this._localDescription = {\n          type: 'close'\n        };\n        this.emit('description', this.getState());\n      }\n    }\n    /**\n     * Get the {@link DataTrackReceiver}s and the {@link MediaTrackReceivers} on the\n     * {@link PeerConnectionV2}.\n     * @returns {Array<DataTrackReceiver|MediaTrackReceiver>} trackReceivers\n     */\n\n  }, {\n    key: 'getTrackReceivers',\n    value: function getTrackReceivers() {\n      return Array.from(this._dataTrackReceivers).concat(Array.from(this._mediaTrackReceivers));\n    }\n    /**\n     * Get the {@link PeerConnectionV2}'s state (specifically, its description).\n     * @returns {?object}\n     */\n\n  }, {\n    key: 'getState',\n    value: function getState() {\n      if (!this._localDescription) {\n        return null;\n      }\n\n      var localDescription = {\n        type: this._localDescription.type,\n        revision: this._descriptionRevision\n      };\n\n      if (this._localDescription.sdp) {\n        localDescription.sdp = this._localDescription.sdp;\n      }\n\n      return {\n        description: localDescription,\n        id: this.id\n      };\n    }\n    /**\n     * Create an offer and set it on the {@link PeerConnectionV2}.\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: 'offer',\n    value: function offer() {\n      var _this14 = this;\n\n      if (this._needsAnswer || this._isRestartingIce) {\n        this._shouldOffer = true;\n        return Promise.resolve();\n      }\n\n      return this.bracket('offering', function (key) {\n        _this14.transition('updating', key);\n\n        var promise = _this14._needsAnswer || _this14._isRestartingIce ? Promise.resolve() : _this14._offer();\n        return promise.then(function () {\n          _this14.tryTransition('open', key);\n        }, function (error) {\n          _this14.tryTransition('open', key);\n\n          throw error;\n        });\n      });\n    }\n    /**\n     * Remove a {@link DataTrackSender} from the {@link PeerConnectionV2}.\n     * @param {DataTrackSender} dataTrackSender\n     * @returns {void}\n     */\n\n  }, {\n    key: 'removeDataTrackSender',\n    value: function removeDataTrackSender(dataTrackSender) {\n      var dataChannel = this._dataChannels.get(dataTrackSender);\n\n      if (dataChannel) {\n        dataTrackSender.removeDataChannel(dataChannel);\n\n        this._dataChannels.delete(dataTrackSender);\n\n        dataChannel.close();\n      }\n    }\n    /**\n     * Remove the {@link MediaTrackSender} from the {@link PeerConnectionV2}.\n     * @param {MediaTrackSender} mediaTrackSender\n     * @returns {void}\n     */\n\n  }, {\n    key: 'removeMediaTrackSender',\n    value: function removeMediaTrackSender(mediaTrackSender) {\n      if (this._peerConnection.signalingState === 'closed' || !this._rtpSenders.has(mediaTrackSender)) {\n        return;\n      }\n\n      var sender = this._rtpSenders.get(mediaTrackSender);\n\n      this._peerConnection.removeTrack(sender);\n\n      if (this._localMediaStream) {\n        this._localMediaStream.removeTrack(mediaTrackSender.track);\n      }\n\n      mediaTrackSender.removeSender(sender);\n\n      this._rtpSenders.delete(mediaTrackSender);\n    }\n    /**\n     * Set the RTCConfiguration on the underlying RTCPeerConnection.\n     * @param {RTCConfiguration} configuration\n     * @returns {void}\n     */\n\n  }, {\n    key: 'setConfiguration',\n    value: function setConfiguration(configuration) {\n      if (typeof this._peerConnection.setConfiguration === 'function') {\n        this._peerConnection.setConfiguration(getConfiguration(configuration));\n      }\n    }\n    /**\n     * Set the ICE reconnect timeout period.\n     * @param {number} period - Period in milliseconds.\n     * @returns {this}\n     */\n\n  }, {\n    key: 'setIceReconnectTimeout',\n    value: function setIceReconnectTimeout(period) {\n      this._iceReconnectTimeout.setDelay(period);\n\n      this._log.debug('Updated ICE reconnection timeout period:', this._iceReconnectTimeout.delay);\n\n      return this;\n    }\n    /**\n     * Update the {@link PeerConnectionV2}.\n     * @param {object} peerConnectionState\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: 'update',\n    value: function update(peerConnectionState) {\n      var _this15 = this;\n\n      return this.bracket('updating', function (key) {\n        if (_this15.state === 'closed') {\n          return Promise.resolve();\n        }\n\n        _this15.transition('updating', key);\n\n        var updates = [];\n\n        if (peerConnectionState.ice) {\n          updates.push(_this15._updateIce(peerConnectionState.ice));\n        }\n\n        if (peerConnectionState.description) {\n          updates.push(_this15._updateDescription(peerConnectionState.description));\n        }\n\n        return Promise.all(updates).then(function () {\n          _this15.tryTransition('open', key);\n        }, function (error) {\n          _this15.tryTransition('open', key);\n\n          throw error;\n        });\n      });\n    }\n    /**\n     * Get the {@link PeerConnectionV2}'s media statistics.\n     * @returns {Promise<StandardizedStatsResponse>}\n     */\n\n  }, {\n    key: 'getStats',\n    value: function getStats() {\n      var _this16 = this;\n\n      return getStatistics(this._peerConnection).then(function (response) {\n        return rewriteTrackIds(_this16, response);\n      });\n    }\n  }, {\n    key: 'connectionState',\n    get: function get() {\n      return this.iceConnectionState === 'failed' ? 'failed' : this._peerConnection.connectionState || this.iceConnectionState;\n    }\n    /**\n     * The {@link PeerConnectionV2}'s underlying RTCPeerConnection's\n     * RTCIceConnectionState.\n     * @property {RTCIceConnectionState}\n     */\n\n  }, {\n    key: 'iceConnectionState',\n    get: function get() {\n      return this._isIceConnectionInactive && this._peerConnection.iceConnectionState === 'disconnected' || this._iceGatheringFailed ? 'failed' : this._peerConnection.iceConnectionState;\n    }\n    /**\n     * Whether the {@link PeerConnectionV2} has negotiated or is in the process\n     * of negotiating the application m= section.\n     * @returns {boolean}\n     */\n\n  }, {\n    key: 'isApplicationSectionNegotiated',\n    get: function get() {\n      if (this._peerConnection.signalingState !== 'closed') {\n        // accessing .localDescription in 'closed' state causes it throw exceptions.\n        return this._peerConnection.localDescription ? getMediaSections(this._peerConnection.localDescription.sdp, 'application').length > 0 : false;\n      }\n\n      return true;\n    }\n  }]);\n\n  return PeerConnectionV2;\n}(StateMachine);\n\nfunction rewriteTrackId(pcv2, stats) {\n  var receiver = [].concat(_toConsumableArray(pcv2._mediaTrackReceivers)).find(function (receiver) {\n    return receiver.track.id === stats.trackId;\n  });\n  var trackId = receiver ? receiver.id : null;\n  return Object.assign(stats, {\n    trackId: trackId\n  });\n}\n\nfunction rewriteTrackIds(pcv2, response) {\n  return Object.assign(response, {\n    remoteAudioTrackStats: response.remoteAudioTrackStats.map(function (stats) {\n      return rewriteTrackId(pcv2, stats);\n    }),\n    remoteVideoTrackStats: response.remoteVideoTrackStats.map(function (stats) {\n      return rewriteTrackId(pcv2, stats);\n    })\n  });\n}\n/**\n * @event PeerConnectionV2#candidates\n * @param {object} candidates\n */\n\n/**\n * @event PeerConnectionV2#connectionStateChanged\n */\n\n/**\n * @event PeerConnectionV2#description\n * @param {object} description\n */\n\n/**\n * @event PeerConnectionV2#iceConnectionStateChanged\n */\n\n/**\n * @event PeerConnectionV2#trackAdded\n * @param {DataTrackReceiver|MediaTrackReceiver} trackReceiver\n */\n\n\nfunction getUfrag(description) {\n  if (description.sdp) {\n    var match = description.sdp.match(/^a=ice-ufrag:([a-zA-Z0-9+/]+)/m);\n\n    if (match) {\n      return match[1];\n    }\n  }\n\n  return null;\n}\n\nfunction getConfiguration(configuration) {\n  return Object.assign({\n    bundlePolicy: 'max-bundle',\n    rtcpMuxPolicy: 'require'\n  }, configuration);\n}\n/**\n * Whether the MediaStreamTrack of the given RTCRTPSender is a non-ended\n * MediaStreamTrack of a given kind.\n * @private\n * @param {string} kind\n * @param {RTCRtpSender} sender\n * @return {boolean}\n */\n\n\nfunction isSenderOfKind(kind, sender) {\n  var track = sender.track;\n  return track && track.kind === kind && track.readyState !== 'ended';\n}\n/**\n * Preferred codecs.\n * @typedef {object} PreferredCodecs\n * @property {Array<AudioCodec>} audio\n * @property {Array<VideoCodec>} video\n */\n\n\nfunction filterOutMediaStreamIds(sdp) {\n  return sdp.replace(/a=msid:[^ ]+ /g, 'a=msid:- ');\n}\n/**\n * Whether an RTCRtpTransceiver can be recycled.\n * @param {RTCRtpTransceiver} transceiver\n * @returns {boolean}\n */\n\n\nfunction shouldRecycleTransceiver(transceiver, pcv2) {\n  return !transceiver.stopped && !pcv2._replaceTrackPromises.has(transceiver) && (transceiver.currentDirection === 'inactive' || transceiver.currentDirection === 'recvonly' || transceiver.direction === 'recvonly');\n}\n/**\n * Take a recycled RTCRtpTransceiver if available.\n * @param {PeerConnectionV2} pcv2\n * @param {Track.Kind} kind\n * @returns {?RTCRtpTransceiver}\n */\n\n\nfunction takeRecycledTransceiver(pcv2, kind) {\n  var preferredCodecs = {\n    audio: pcv2._preferredAudioCodecs.map(function (codec) {\n      return codec.toLowerCase();\n    }),\n    video: pcv2._preferredVideoCodecs.map(function (_ref7) {\n      var codec = _ref7.codec;\n      return codec.toLowerCase();\n    })\n  }[kind];\n  var recycledTransceivers = pcv2._recycledTransceivers[kind];\n  var localCodec = preferredCodecs.find(function (codec) {\n    return pcv2._localCodecs.has(codec);\n  });\n\n  if (!localCodec) {\n    return recycledTransceivers.shift();\n  }\n\n  var transceiver = recycledTransceivers.find(function (transceiver) {\n    var remoteCodecMap = pcv2._remoteCodecMaps.get(transceiver.mid);\n\n    return remoteCodecMap && remoteCodecMap.has(localCodec);\n  });\n\n  if (transceiver) {\n    recycledTransceivers.splice(recycledTransceivers.indexOf(transceiver), 1);\n  }\n\n  return transceiver;\n}\n/**\n * Update the set of locally supported {@link Codec}s.\n * @param pcv2\n * @returns {void}\n */\n\n\nfunction updateLocalCodecs(pcv2) {\n  var description = pcv2._peerConnection.localDescription;\n\n  if (!description) {\n    return;\n  }\n\n  getMediaSections(description.sdp).forEach(function (section) {\n    var codecMap = createCodecMapForMediaSection(section);\n    codecMap.forEach(function (pts, codec) {\n      return pcv2._localCodecs.add(codec);\n    });\n  });\n}\n/**\n * Update the {@link Codec} maps for all m= sections in the remote {@link RTCSessionDescription}s.\n * @param {PeerConnectionV2} pcv2\n * @returns {void}\n */\n\n\nfunction updateRemoteCodecMaps(pcv2) {\n  var description = pcv2._peerConnection.remoteDescription;\n\n  if (!description) {\n    return;\n  }\n\n  getMediaSections(description.sdp).forEach(function (section) {\n    var mid = section.match(/^a=mid:(.+)$/m)[1];\n    var codecMap = createCodecMapForMediaSection(section);\n\n    pcv2._remoteCodecMaps.set(mid, codecMap);\n  });\n}\n/**\n * Update the list of recycled RTCRtpTransceivers.\n * @param {PeerConnectionV2} pcv2\n */\n\n\nfunction updateRecycledTransceivers(pcv2) {\n  pcv2._recycledTransceivers.audio = [];\n  pcv2._recycledTransceivers.video = [];\n\n  pcv2._peerConnection.getTransceivers().forEach(function (transceiver) {\n    if (shouldRecycleTransceiver(transceiver, pcv2)) {\n      var track = transceiver.receiver.track;\n\n      pcv2._recycledTransceivers[track.kind].push(transceiver);\n    }\n  });\n}\n/**\n * Perform certain updates after an SDP negotiation is completed.\n * @param {PeerConnectionV2} pcv2\n * @returns {void}\n */\n\n\nfunction negotiationCompleted(pcv2) {\n  if (pcv2._isUnifiedPlan) {\n    updateRecycledTransceivers(pcv2);\n    updateLocalCodecs(pcv2);\n    updateRemoteCodecMaps(pcv2);\n  }\n\n  if (pcv2._isRTCRtpSenderParamsSupported) {\n    updateEncodingParameters(pcv2);\n  }\n}\n/**\n * Update the RTCRtpEncodingParameters of all active RTCRtpSenders.\n * @param {PeerConnectionV2} pcv2\n * @returns {void}\n */\n\n\nfunction updateEncodingParameters(pcv2) {\n  var _pcv2$_encodingParame = pcv2._encodingParameters,\n      maxAudioBitrate = _pcv2$_encodingParame.maxAudioBitrate,\n      maxVideoBitrate = _pcv2$_encodingParame.maxVideoBitrate;\n  var maxBitrates = new Map([['audio', maxAudioBitrate], ['video', maxVideoBitrate]]);\n\n  pcv2._peerConnection.getSenders().filter(function (sender) {\n    return sender.track;\n  }).forEach(function (sender) {\n    var maxBitrate = maxBitrates.get(sender.track.kind);\n    var params = sender.getParameters();\n\n    if (maxBitrate === null || maxBitrate === 0) {\n      removeMaxBitrate(params);\n    } else if (pcv2._isChromeScreenShareTrack(sender.track)) {\n      // NOTE(mpatwardhan): Sometimes (JSDK-2557) chrome does not send any bytes on screen track if MaxBitRate is set on it via setParameters,\n      // To workaround this issue we will not apply maxBitrate if the track appears to be a screen share track created by chrome\n      pcv2._log.warn('Not setting maxBitrate for ' + sender.track.kind + ' Track ' + sender.track.id + ' because it appears to be screen share track: ' + sender.track.label);\n    } else {\n      setMaxBitrate(params, maxBitrate);\n    }\n\n    if (!isFirefox && pcv2._enableDscp && params.encodings.length > 0) {\n      // NOTE(mmalavalli): \"networkPriority\" is a per-sender property and not\n      // a per-encoding-layer property. So, we set the value only on the first\n      // encoding layer. Any attempt to set the value on subsequent encoding\n      // layers (in the case of simulcast) will result in the Promise returned\n      // by RTCRtpSender.setParameters() being rejected.\n      params.encodings[0].networkPriority = 'high';\n    }\n\n    sender.setParameters(params).catch(function (error) {\n      pcv2._log.warn('Error while setting encodings parameters for ' + sender.track.kind + ' Track ' + sender.track.id + ': ' + (error.message || error.name));\n    });\n  });\n}\n/**\n * Remove maxBitrate from the RTCRtpSendParameters' encodings.\n * @param {RTCRtpSendParameters} params\n * @returns {void}\n */\n\n\nfunction removeMaxBitrate(params) {\n  if (Array.isArray(params.encodings)) {\n    params.encodings.forEach(function (encoding) {\n      return delete encoding.maxBitrate;\n    });\n  }\n}\n/**\n * Set the given maxBitrate in the RTCRtpSendParameters' encodings.\n * @param {RTCRtpSendParameters} params\n * @param {number} maxBitrate\n * @returns {void}\n */\n\n\nfunction setMaxBitrate(params, maxBitrate) {\n  if (isFirefox) {\n    params.encodings = [{\n      maxBitrate: maxBitrate\n    }];\n  } else {\n    params.encodings.forEach(function (encoding) {\n      encoding.maxBitrate = maxBitrate;\n    });\n  }\n}\n\nmodule.exports = PeerConnectionV2;","map":{"version":3,"sources":["/home/ascencion/sebrae_megahack/node_modules/twilio-video/es5/signaling/v2/peerconnection.js"],"names":["_createClass","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","Constructor","protoProps","staticProps","prototype","_toConsumableArray","arr","Array","isArray","arr2","from","_classCallCheck","instance","TypeError","_possibleConstructorReturn","self","call","ReferenceError","_inherits","subClass","superClass","create","constructor","value","setPrototypeOf","__proto__","DefaultBackoff","require","_require","DefaultMediaStream","MediaStream","DefaultRTCIceCandidate","RTCIceCandidate","DefaultRTCPeerConnection","RTCPeerConnection","DefaultRTCSessionDescription","RTCSessionDescription","getStatistics","getStats","_require2","guessBrowser","_require3","getSdpFormat","_require4","DEFAULT_ICE_GATHERING_TIMEOUT_MS","DEFAULT_LOG_LEVEL","DEFAULT_SESSION_TIMEOUT_SEC","iceRestartBackoffConfig","_require5","createCodecMapForMediaSection","getMediaSections","revertSimulcastForNonVP8MediaSections","setBitrateParameters","setCodecPreferences","setSimulcast","unifiedPlanAddOrRewriteNewTrackIds","unifiedPlanAddOrRewriteTrackIds","unifiedPlanFilterLocalCodecs","DefaultTimeout","_require6","MediaClientLocalDescFailedError","MediaClientRemoteDescFailedError","_require7","buildLogLevels","isChromeScreenShareTrack","oncePerTick","IceBox","DefaultIceConnectionMonitor","DataTrackReceiver","MediaTrackReceiver","StateMachine","Log","IdentityTrackMatcher","OrderedTrackMatcher","MIDTrackMatcher","workaroundIssue8329","guess","isChrome","isFirefox","isSafari","isRTCRtpSenderParamsSupported","RTCRtpSender","getParameters","setParameters","nInstances","states","open","updating","closed","PeerConnectionV2","_StateMachine","id","encodingParameters","preferredCodecs","options","_this","getPrototypeOf","assign","enableDscp","dummyAudioMediaStreamTrack","iceServers","logLevel","offerOptions","sessionTimeout","Backoff","IceConnectionMonitor","Timeout","configuration","getConfiguration","sdpFormat","sdpSemantics","isUnifiedPlan","localMediaStream","logLevels","chromeSpecificConstraints","optional","push","googDscp","log","createLog","peerConnection","addTrack","_appliedTrackIdsToAttributes","Map","_dataChannels","_dataTrackReceivers","Set","_descriptionRevision","_didGenerateLocalCandidates","_enableDscp","_encodingParameters","_isChromeScreenShareTrack","_iceGatheringFailed","_iceGatheringTimeout","_handleIceGatheringTimeout","_iceRestartBackoff","exponential","_instanceId","_isIceConnectionInactive","_isIceLite","_isIceRestartBackoffInProgress","_isRestartingIce","_isUnifiedPlan","_isRTCRtpSenderParamsSupported","_lastIceConnectionState","_lastStableDescriptionRevision","_localCandidates","_localCodecs","_localCandidatesRevision","_localDescriptionWithoutSimulcast","_localDescription","_localMediaStream","_localUfrag","_log","_remoteCodecMaps","_rtpSenders","_iceConnectionMonitor","_mediaTrackReceivers","_needsAnswer","_negotiationRole","_offerOptions","_peerConnection","_preferredAudioCodecs","audio","_preferredVideoCodecs","video","_shouldApplySimulcast","some","codecSettings","codec","toLowerCase","simulcast","_queuedDescription","_iceReconnectTimeout","debug","close","_recycledTransceivers","_replaceTrackPromises","_remoteCandidates","_sdpFormat","_setBitrateParameters","_setCodecPreferences","_setSimulcast","_revertSimulcastForNonVP8MediaSections","_RTCIceCandidate","_RTCPeerConnection","_RTCSessionDescription","_shouldOffer","_shouldRestartIce","_trackIdsToAttributes","_trackMatcher","on","updateEncodingParameters","offer","addEventListener","_handleConnectionStateChange","bind","_handleDataChannelEvent","_handleIceCandidateEvent","_handleIceConnectionStateChange","_handleIceGatheringStateChange","_handleSignalingStateChange","_handleTrackEvent","_initiateIceRestart","stateChanged","state","removeListener","forEach","dataChannel","dataTrackSender","removeDataTrackSender","toString","_addIceCandidate","candidate","_this2","Promise","resolve","then","addIceCandidate","catch","error","warn","message","_addIceCandidates","candidates","all","map","_addOrUpdateTransceiver","track","_this3","transceiver","takeRecycledTransceiver","kind","sender","oldTrackId","mid","set","replaceTrack","direction","finally","delete","addTransceiver","_checkIceBox","description","ufrag","getUfrag","setUfrag","_answer","_this4","_setRemoteDescription","createAnswer","answer","updatedSdp","sdp","type","_setLocalDescription","_updateDescription","_maybeReoffer","localDescription","_close","signalingState","preempt","emit","event","_this5","channel","dataTrackReceiver","add","_handleGlare","_this6","didReoffer","_offer","clear","peerConnectionState","ice","slice","complete","revision","_this7","iceConnectionState","isIceConnectedOrComplete","includes","reset","_initiateIceRestartBackoff","start","stop","iceGatheringState","delay","isSet","_this8","remoteDescription","update","mediaStreamTrack","signaledTrackId","match","mediaTrackReceiver","trackReceiver","backoff","shouldReoffer","senders","getSenders","filter","reduce","shouldOffer","mediaSections","sendersOfKind","isSenderOfKind","hasDataTrack","size","hasApplicationMediaSection","needsApplicationMediaSection","promise","_this9","iceRestart","values","createOffer","_addOrRewriteLocalTrackIds","transceivers","getTransceivers","activeTransceivers","_ref","stopped","assignedTransceivers","_ref2","midsToTrackIds","_ref3","sdp1","unassignedTransceivers","_ref4","newTrackIdsByKind","_ref5","_ref6","sdp2","_rollbackAndApplyOffer","_this10","_this11","setLocalDescription","negotiationCompleted","getState","_this12","maxAudioBitrate","maxVideoBitrate","filterOutMediaStreamIds","test","sdpWithoutSimulcastForNonVP8MediaSections","setRemoteDescription","_this13","_updateIce","iceState","addDataTrackSender","has","dataChannelDict","ordered","maxPacketLifeTime","maxRetransmits","createDataChannel","addDataChannel","addMediaTrackSender","mediaTrackSender","addSender","getTrackReceivers","concat","_this14","bracket","transition","tryTransition","get","removeDataChannel","removeMediaTrackSender","removeTrack","removeSender","setConfiguration","setIceReconnectTimeout","period","setDelay","_this15","updates","_this16","response","rewriteTrackIds","connectionState","rewriteTrackId","pcv2","stats","receiver","find","trackId","remoteAudioTrackStats","remoteVideoTrackStats","bundlePolicy","rtcpMuxPolicy","readyState","replace","shouldRecycleTransceiver","currentDirection","_ref7","recycledTransceivers","localCodec","shift","remoteCodecMap","splice","indexOf","updateLocalCodecs","section","codecMap","pts","updateRemoteCodecMaps","updateRecycledTransceivers","_pcv2$_encodingParame","maxBitrates","maxBitrate","params","removeMaxBitrate","label","setMaxBitrate","encodings","networkPriority","name","encoding","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }\n\nvar DefaultBackoff = require('backoff');\n\nvar _require = require('@twilio/webrtc'),\n    DefaultMediaStream = _require.MediaStream,\n    DefaultRTCIceCandidate = _require.RTCIceCandidate,\n    DefaultRTCPeerConnection = _require.RTCPeerConnection,\n    DefaultRTCSessionDescription = _require.RTCSessionDescription,\n    getStatistics = _require.getStats;\n\nvar _require2 = require('@twilio/webrtc/lib/util'),\n    guessBrowser = _require2.guessBrowser;\n\nvar _require3 = require('@twilio/webrtc/lib/util/sdp'),\n    getSdpFormat = _require3.getSdpFormat;\n\nvar _require4 = require('../../util/constants'),\n    DEFAULT_ICE_GATHERING_TIMEOUT_MS = _require4.DEFAULT_ICE_GATHERING_TIMEOUT_MS,\n    DEFAULT_LOG_LEVEL = _require4.DEFAULT_LOG_LEVEL,\n    DEFAULT_SESSION_TIMEOUT_SEC = _require4.DEFAULT_SESSION_TIMEOUT_SEC,\n    iceRestartBackoffConfig = _require4.iceRestartBackoffConfig;\n\nvar _require5 = require('../../util/sdp'),\n    createCodecMapForMediaSection = _require5.createCodecMapForMediaSection,\n    getMediaSections = _require5.getMediaSections,\n    revertSimulcastForNonVP8MediaSections = _require5.revertSimulcastForNonVP8MediaSections,\n    setBitrateParameters = _require5.setBitrateParameters,\n    setCodecPreferences = _require5.setCodecPreferences,\n    setSimulcast = _require5.setSimulcast,\n    unifiedPlanAddOrRewriteNewTrackIds = _require5.unifiedPlanAddOrRewriteNewTrackIds,\n    unifiedPlanAddOrRewriteTrackIds = _require5.unifiedPlanAddOrRewriteTrackIds,\n    unifiedPlanFilterLocalCodecs = _require5.unifiedPlanFilterLocalCodecs;\n\nvar DefaultTimeout = require('../../util/timeout');\n\nvar _require6 = require('../../util/twilio-video-errors'),\n    MediaClientLocalDescFailedError = _require6.MediaClientLocalDescFailedError,\n    MediaClientRemoteDescFailedError = _require6.MediaClientRemoteDescFailedError;\n\nvar _require7 = require('../../util'),\n    buildLogLevels = _require7.buildLogLevels,\n    isChromeScreenShareTrack = _require7.isChromeScreenShareTrack,\n    oncePerTick = _require7.oncePerTick;\n\nvar IceBox = require('./icebox');\nvar DefaultIceConnectionMonitor = require('./iceconnectionmonitor.js');\nvar DataTrackReceiver = require('../../data/receiver');\nvar MediaTrackReceiver = require('../../media/track/receiver');\nvar StateMachine = require('../../statemachine');\nvar Log = require('../../util/log');\nvar IdentityTrackMatcher = require('../../util/sdp/trackmatcher/identity');\nvar OrderedTrackMatcher = require('../../util/sdp/trackmatcher/ordered');\nvar MIDTrackMatcher = require('../../util/sdp/trackmatcher/mid');\nvar workaroundIssue8329 = require('../../util/sdp/issue8329');\n\nvar guess = guessBrowser();\nvar isChrome = guess === 'chrome';\nvar isFirefox = guess === 'firefox';\nvar isSafari = guess === 'safari';\n\nvar isRTCRtpSenderParamsSupported = typeof RTCRtpSender !== 'undefined' && typeof RTCRtpSender.prototype.getParameters === 'function' && typeof RTCRtpSender.prototype.setParameters === 'function';\n\nvar nInstances = 0;\n\n/*\nPeerConnectionV2 States\n-----------------------\n\n    +------+    +--------+\n    |      |    |        |\n    | open |--->| closed |\n    |      |    |        |\n    +------+    +--------+\n      |  ^          ^\n      |  |          |\n      |  |          |\n      v  |          |\n  +----------+      |\n  |          |      |\n  | updating |------+\n  |          |\n  +----------+\n\n*/\n\nvar states = {\n  open: ['closed', 'updating'],\n  updating: ['closed', 'open'],\n  closed: []\n};\n\n/**\n * @extends StateMachine\n * @property {id}\n * @emits PeerConnectionV2#connectionStateChanged\n * @emits PeerConnectionV2#iceConnectionStateChanged\n * @emits PeerConnectionV2#candidates\n * @emits PeerConnectionV2#description\n */\n\nvar PeerConnectionV2 = function (_StateMachine) {\n  _inherits(PeerConnectionV2, _StateMachine);\n\n  /**\n   * Construct a {@link PeerConnectionV2}.\n   * @param {string} id\n   * @param {EncodingParametersImpl} encodingParameters\n   * @param {PreferredCodecs} preferredCodecs\n   * @param {object} [options]\n   */\n  function PeerConnectionV2(id, encodingParameters, preferredCodecs, options) {\n    _classCallCheck(this, PeerConnectionV2);\n\n    var _this = _possibleConstructorReturn(this, (PeerConnectionV2.__proto__ || Object.getPrototypeOf(PeerConnectionV2)).call(this, 'open', states));\n\n    options = Object.assign({\n      enableDscp: false,\n      dummyAudioMediaStreamTrack: null,\n      isChromeScreenShareTrack: isChromeScreenShareTrack,\n      iceServers: [],\n      isRTCRtpSenderParamsSupported: isRTCRtpSenderParamsSupported,\n      logLevel: DEFAULT_LOG_LEVEL,\n      offerOptions: {},\n      revertSimulcastForNonVP8MediaSections: revertSimulcastForNonVP8MediaSections,\n      sessionTimeout: DEFAULT_SESSION_TIMEOUT_SEC * 1000,\n      setBitrateParameters: setBitrateParameters,\n      setCodecPreferences: setCodecPreferences,\n      setSimulcast: setSimulcast,\n      Backoff: DefaultBackoff,\n      IceConnectionMonitor: DefaultIceConnectionMonitor,\n      MediaStream: DefaultMediaStream,\n      RTCIceCandidate: DefaultRTCIceCandidate,\n      RTCPeerConnection: DefaultRTCPeerConnection,\n      RTCSessionDescription: DefaultRTCSessionDescription,\n      Timeout: DefaultTimeout\n    }, options);\n\n    var configuration = getConfiguration(options);\n    var sdpFormat = getSdpFormat(configuration.sdpSemantics);\n    var isUnifiedPlan = sdpFormat === 'unified';\n\n    var localMediaStream = isUnifiedPlan ? null : new options.MediaStream();\n    var logLevels = buildLogLevels(options.logLevel);\n    var RTCPeerConnection = options.RTCPeerConnection;\n\n    if (options.enableDscp === true) {\n      options.chromeSpecificConstraints = options.chromeSpecificConstraints || {};\n      options.chromeSpecificConstraints.optional = options.chromeSpecificConstraints.optional || [];\n      options.chromeSpecificConstraints.optional.push({ googDscp: true });\n    }\n\n    var log = options.log ? options.log.createLog('signaling', _this) : new Log('webrtc', _this, logLevels);\n    var peerConnection = new RTCPeerConnection(configuration, options.chromeSpecificConstraints);\n\n    if (options.dummyAudioMediaStreamTrack) {\n      peerConnection.addTrack(options.dummyAudioMediaStreamTrack, localMediaStream || new options.MediaStream());\n    }\n\n    Object.defineProperties(_this, {\n      _appliedTrackIdsToAttributes: {\n        value: new Map(),\n        writable: true\n      },\n      _dataChannels: {\n        value: new Map()\n      },\n      _dataTrackReceivers: {\n        value: new Set()\n      },\n      _descriptionRevision: {\n        writable: true,\n        value: 0\n      },\n      _didGenerateLocalCandidates: {\n        writable: true,\n        value: false\n      },\n      _enableDscp: {\n        value: options.enableDscp\n      },\n      _encodingParameters: {\n        value: encodingParameters\n      },\n      _isChromeScreenShareTrack: {\n        value: options.isChromeScreenShareTrack\n      },\n      _iceGatheringFailed: {\n        value: false,\n        writable: true\n      },\n      _iceGatheringTimeout: {\n        value: new options.Timeout(function () {\n          return _this._handleIceGatheringTimeout();\n        }, DEFAULT_ICE_GATHERING_TIMEOUT_MS, false)\n      },\n      _iceRestartBackoff: {\n        value: options.Backoff.exponential(iceRestartBackoffConfig)\n      },\n      _instanceId: {\n        value: ++nInstances\n      },\n      _isIceConnectionInactive: {\n        writable: true,\n        value: false\n      },\n      _isIceLite: {\n        writable: true,\n        value: false\n      },\n      _isIceRestartBackoffInProgress: {\n        writable: true,\n        value: false\n      },\n      _isRestartingIce: {\n        writable: true,\n        value: false\n      },\n      _isUnifiedPlan: {\n        value: isUnifiedPlan\n      },\n      _isRTCRtpSenderParamsSupported: {\n        value: options.isRTCRtpSenderParamsSupported\n      },\n      _lastIceConnectionState: {\n        writable: true,\n        value: null\n      },\n      _lastStableDescriptionRevision: {\n        writable: true,\n        value: 0\n      },\n      _localCandidates: {\n        writable: true,\n        value: []\n      },\n      _localCodecs: {\n        value: new Set()\n      },\n      _localCandidatesRevision: {\n        writable: true,\n        value: 1\n      },\n      _localDescriptionWithoutSimulcast: {\n        writable: true,\n        value: null\n      },\n      _localDescription: {\n        writable: true,\n        value: null\n      },\n      _localMediaStream: {\n        value: localMediaStream\n      },\n      _localUfrag: {\n        writable: true,\n        value: null\n      },\n      _log: {\n        value: log\n      },\n      _remoteCodecMaps: {\n        value: new Map()\n      },\n      _rtpSenders: {\n        value: new Map()\n      },\n      _iceConnectionMonitor: {\n        value: new options.IceConnectionMonitor(peerConnection)\n      },\n      _mediaTrackReceivers: {\n        value: new Set()\n      },\n      _needsAnswer: {\n        writable: true,\n        value: false\n      },\n      _negotiationRole: {\n        writable: true,\n        value: null\n      },\n      _offerOptions: {\n        writable: true,\n        value: options.offerOptions\n      },\n      _peerConnection: {\n        value: peerConnection\n      },\n      _preferredAudioCodecs: {\n        value: preferredCodecs.audio\n      },\n      _preferredVideoCodecs: {\n        value: preferredCodecs.video\n      },\n      _shouldApplySimulcast: {\n        value: (isChrome || isSafari) && preferredCodecs.video.some(function (codecSettings) {\n          return codecSettings.codec.toLowerCase() === 'vp8' && codecSettings.simulcast;\n        })\n      },\n      _queuedDescription: {\n        writable: true,\n        value: null\n      },\n      _iceReconnectTimeout: {\n        value: new options.Timeout(function () {\n          log.debug('ICE reconnect timed out');\n          _this.close();\n        }, options.sessionTimeout, false)\n      },\n      _recycledTransceivers: {\n        value: {\n          audio: [],\n          video: []\n        }\n      },\n      _replaceTrackPromises: {\n        value: new Map()\n      },\n      _remoteCandidates: {\n        writable: true,\n        value: new IceBox()\n      },\n      _sdpFormat: {\n        value: sdpFormat\n      },\n      _setBitrateParameters: {\n        value: options.setBitrateParameters\n      },\n      _setCodecPreferences: {\n        value: options.setCodecPreferences\n      },\n      _setSimulcast: {\n        value: options.setSimulcast\n      },\n      _revertSimulcastForNonVP8MediaSections: {\n        value: options.revertSimulcastForNonVP8MediaSections\n      },\n      _RTCIceCandidate: {\n        value: options.RTCIceCandidate\n      },\n      _RTCPeerConnection: {\n        value: options.RTCPeerConnection\n      },\n      _RTCSessionDescription: {\n        value: options.RTCSessionDescription\n      },\n      _shouldOffer: {\n        writable: true,\n        value: false\n      },\n      _shouldRestartIce: {\n        writable: true,\n        value: false\n      },\n      _trackIdsToAttributes: {\n        value: new Map(),\n        writable: true\n      },\n      _trackMatcher: {\n        writable: true,\n        value: null\n      },\n      id: {\n        enumerable: true,\n        value: id\n      }\n    });\n\n    encodingParameters.on('changed', oncePerTick(function () {\n      if (_this._isRTCRtpSenderParamsSupported) {\n        if (!_this._needsAnswer) {\n          updateEncodingParameters(_this);\n        }\n        return;\n      }\n      _this.offer();\n    }));\n\n    peerConnection.addEventListener('connectionstatechange', _this._handleConnectionStateChange.bind(_this));\n    peerConnection.addEventListener('datachannel', _this._handleDataChannelEvent.bind(_this));\n    peerConnection.addEventListener('icecandidate', _this._handleIceCandidateEvent.bind(_this));\n    peerConnection.addEventListener('iceconnectionstatechange', _this._handleIceConnectionStateChange.bind(_this));\n    peerConnection.addEventListener('icegatheringstatechange', _this._handleIceGatheringStateChange.bind(_this));\n    peerConnection.addEventListener('signalingstatechange', _this._handleSignalingStateChange.bind(_this));\n    peerConnection.addEventListener('track', _this._handleTrackEvent.bind(_this));\n    _this._iceRestartBackoff.on('ready', function () {\n      return _this._initiateIceRestart();\n    });\n\n    var self = _this;\n    _this.on('stateChanged', function stateChanged(state) {\n      if (state !== 'closed') {\n        return;\n      }\n      self.removeListener('stateChanged', stateChanged);\n      self._dataChannels.forEach(function (dataChannel, dataTrackSender) {\n        self.removeDataTrackSender(dataTrackSender);\n      });\n    });\n    return _this;\n  }\n\n  _createClass(PeerConnectionV2, [{\n    key: 'toString',\n    value: function toString() {\n      return '[PeerConnectionV2 #' + this._instanceId + ': ' + this.id + ']';\n    }\n\n    /**\n     * The {@link PeerConnectionV2}'s underlying RTCPeerConnection's RTCPeerConnectionState\n     * if supported by the browser, its RTCIceConnectionState otherwise.\n     * @property {RTCPeerConnectionState}\n     */\n\n  }, {\n    key: '_addIceCandidate',\n\n\n    /**\n     * Add an ICE candidate to the {@link PeerConnectionV2}.\n     * @private\n     * @param {object} candidate\n     * @returns {Promise<void>}\n     */\n    value: function _addIceCandidate(candidate) {\n      var _this2 = this;\n\n      return Promise.resolve().then(function () {\n        candidate = new _this2._RTCIceCandidate(candidate);\n        return _this2._peerConnection.addIceCandidate(candidate);\n      }).catch(function (error) {\n        // NOTE(mmalavalli): Firefox 68+ now generates an RTCIceCandidate with an\n        // empty candidate string to signal end-of-candidates, followed by a null\n        // candidate. As of now, Chrome and Safari reject this RTCIceCandidate. Since\n        // this does not affect the media connection between Firefox 68+ and Chrome/Safari\n        // in Peer-to-Peer Rooms, we suppress the Error and log a warning message.\n        //\n        // Chrome bug: https://bugs.chromium.org/p/chromium/issues/detail?id=978582\n        //\n        _this2._log.warn('Failed to add RTCIceCandidate ' + (candidate ? '\"' + candidate.candidate + '\"' : 'null') + ': ' + error.message);\n      });\n    }\n\n    /**\n     * Add ICE candidates to the {@link PeerConnectionV2}.\n     * @private\n     * @param {Array<object>} candidates\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_addIceCandidates',\n    value: function _addIceCandidates(candidates) {\n      return Promise.all(candidates.map(this._addIceCandidate, this)).then(function () {});\n    }\n\n    /**\n     * Add a new RTCRtpTransceiver or update an existing RTCRtpTransceiver for the\n     * given MediaStreamTrack.\n     * @private\n     * @param {MediaStreamTrack} track\n     * @returns {RTCRtpTransceiver}\n     */\n\n  }, {\n    key: '_addOrUpdateTransceiver',\n    value: function _addOrUpdateTransceiver(track) {\n      var _this3 = this;\n\n      var transceiver = takeRecycledTransceiver(this, track.kind);\n      if (transceiver && transceiver.sender) {\n        var oldTrackId = transceiver.sender.track ? transceiver.sender.track.id : null;\n        if (oldTrackId) {\n          this._log.warn('Reusing transceiver: ' + transceiver.mid + '] ' + oldTrackId + ' => ' + track.id);\n        }\n        // NOTE(mpatwardhan):remember this transceiver while we replace track.\n        // we recycle transceivers that are not in use after 'negotiationCompleted', but we want to prevent\n        // this one from getting recycled while replaceTrack is pending.\n        this._replaceTrackPromises.set(transceiver, transceiver.sender.replaceTrack(track).then(function () {\n          transceiver.direction = 'sendrecv';\n        }, function () {\n          // Do nothing.\n        }).finally(function () {\n          _this3._replaceTrackPromises.delete(transceiver);\n        }));\n        return transceiver;\n      }\n      return this._peerConnection.addTransceiver(track);\n    }\n\n    /**\n     * Check the {@link IceBox}.\n     * @private\n     * @param {RTCSessionDescriptionInit} description\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_checkIceBox',\n    value: function _checkIceBox(description) {\n      var ufrag = getUfrag(description);\n      if (!ufrag) {\n        return Promise.resolve();\n      }\n      var candidates = this._remoteCandidates.setUfrag(ufrag);\n      return this._addIceCandidates(candidates);\n    }\n\n    /**\n     * Create an answer and set it on the {@link PeerConnectionV2}.\n     * @private\n     * @param {RTCSessionDescriptionInit} offer\n     * @returns {Promise<boolean>}\n     */\n\n  }, {\n    key: '_answer',\n    value: function _answer(offer) {\n      var _this4 = this;\n\n      return Promise.resolve().then(function () {\n        if (!_this4._negotiationRole) {\n          _this4._negotiationRole = 'answerer';\n        }\n        return _this4._setRemoteDescription(offer);\n      }).catch(function () {\n        throw new MediaClientRemoteDescFailedError();\n      }).then(function () {\n        return _this4._peerConnection.createAnswer();\n      }).then(function (answer) {\n        if (!isFirefox) {\n          answer = workaroundIssue8329(answer);\n        }\n\n        var description = answer;\n        if (_this4._shouldApplySimulcast) {\n          var updatedSdp = _this4._setSimulcast(answer.sdp, _this4._sdpFormat, _this4._trackIdsToAttributes);\n          // NOTE(syerrapragada): VMS does not support H264 simulcast. So,\n          // unset simulcast for sections in local offer where corresponding\n          // sections in answer doesn't have vp8 as preferred codec and reapply offer.\n          updatedSdp = _this4._revertSimulcastForNonVP8MediaSections(updatedSdp, answer.sdp, offer.sdp);\n          description = {\n            type: description.type,\n            sdp: updatedSdp\n          };\n        }\n        return _this4._setLocalDescription(description);\n      }).then(function () {\n        return _this4._checkIceBox(offer);\n      }).then(function () {\n        return _this4._queuedDescription && _this4._updateDescription(_this4._queuedDescription);\n      }).then(function () {\n        _this4._queuedDescription = null;\n        return _this4._maybeReoffer(_this4._peerConnection.localDescription);\n      }).catch(function (error) {\n        throw error instanceof MediaClientRemoteDescFailedError ? error : new MediaClientLocalDescFailedError();\n      });\n    }\n\n    /**\n     * Close the underlying RTCPeerConnection. Returns false if the\n     * RTCPeerConnection was already closed.\n     * @private\n     * @returns {boolean}\n     */\n\n  }, {\n    key: '_close',\n    value: function _close() {\n      if (this._peerConnection.signalingState !== 'closed') {\n        this._peerConnection.close();\n        this.preempt('closed');\n        return true;\n      }\n      return false;\n    }\n\n    /**\n     * Handle a \"connectionstatechange\" event.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleConnectionStateChange',\n    value: function _handleConnectionStateChange() {\n      this.emit('connectionStateChanged');\n    }\n\n    /**\n     * Handle a \"datachannel\" event.\n     * @private\n     * @param {RTCDataChannelEvent} event\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleDataChannelEvent',\n    value: function _handleDataChannelEvent(event) {\n      var _this5 = this;\n\n      var dataChannel = event.channel;\n      var dataTrackReceiver = new DataTrackReceiver(dataChannel);\n      this._dataTrackReceivers.add(dataTrackReceiver);\n\n      dataChannel.addEventListener('close', function () {\n        _this5._dataTrackReceivers.delete(dataTrackReceiver);\n      });\n\n      this.emit('trackAdded', dataTrackReceiver);\n    }\n\n    /**\n     * Handle a glare scenario on the {@link PeerConnectionV2}.\n     * @private\n     * @param {RTCSessionDescriptionInit} offer\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_handleGlare',\n    value: function _handleGlare(offer) {\n      var _this6 = this;\n\n      this._log.debug('Glare detected; rolling back');\n      if (this._isRestartingIce) {\n        this._log.debug('An ICE restart was in progress; we\\'ll need to restart ICE again after rolling back');\n        this._isRestartingIce = false;\n        this._shouldRestartIce = true;\n      }\n      return Promise.resolve().then(function () {\n        _this6._trackIdsToAttributes = new Map(_this6._appliedTrackIdsToAttributes);\n        return _this6._setLocalDescription({ type: 'rollback' });\n      }).then(function () {\n        _this6._needsAnswer = false;\n        return _this6._answer(offer);\n      }).then(function (didReoffer) {\n        return didReoffer ? Promise.resolve() : _this6._offer();\n      });\n    }\n\n    /**\n     * Handle an ICE candidate event.\n     * @private\n     * @param {Event} event\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleIceCandidateEvent',\n    value: function _handleIceCandidateEvent(event) {\n      if (event.candidate) {\n        this._log.debug('Clearing ICE gathering timeout');\n        this._didGenerateLocalCandidates = true;\n        this._iceGatheringTimeout.clear();\n        this._localCandidates.push(event.candidate);\n      }\n      var peerConnectionState = {\n        ice: {\n          candidates: this._isIceLite ? [] : this._localCandidates.slice(),\n          ufrag: this._localUfrag\n        },\n        id: this.id\n      };\n      if (!event.candidate) {\n        peerConnectionState.ice.complete = true;\n      }\n      if (!(this._isIceLite && event.candidate)) {\n        peerConnectionState.ice.revision = this._localCandidatesRevision++;\n        this.emit('candidates', peerConnectionState);\n      }\n    }\n\n    /**\n     * Handle an ICE connection state change event.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleIceConnectionStateChange',\n    value: function _handleIceConnectionStateChange() {\n      var _this7 = this;\n\n      var iceConnectionState = this._peerConnection.iceConnectionState;\n\n      var isIceConnectedOrComplete = ['connected', 'complete'].includes(iceConnectionState);\n      var log = this._log;\n\n      log.debug('ICE connection state is \"' + iceConnectionState + '\"');\n      if (isIceConnectedOrComplete) {\n        this._iceReconnectTimeout.clear();\n        this._iceRestartBackoff.reset();\n      }\n\n      if (this._lastIceConnectionState !== 'failed' && iceConnectionState === 'failed' && !this._shouldRestartIce && !this._isRestartingIce) {\n        // Case 1: Transition to \"failed\".\n        log.warn('ICE failed');\n        this._initiateIceRestartBackoff();\n      } else if (['disconnected', 'failed'].includes(this._lastIceConnectionState) && isIceConnectedOrComplete) {\n        // Case 2: Transition from \"disconnected\" or \"failed\".\n        log.debug('ICE reconnected');\n      }\n\n      this._isIceConnectionInactive = false;\n      if (iceConnectionState === 'disconnected') {\n        this._iceConnectionMonitor.start(function () {\n          _this7._iceConnectionMonitor.stop();\n          if (!_this7._shouldRestartIce && !_this7._isRestartingIce) {\n            log.warn('ICE Connection Monitor detected inactivity');\n            _this7._isIceConnectionInactive = true;\n            _this7._initiateIceRestartBackoff();\n            _this7.emit('iceConnectionStateChanged');\n            _this7.emit('connectionStateChanged');\n          }\n        });\n      } else {\n        this._iceConnectionMonitor.stop();\n      }\n\n      this._lastIceConnectionState = iceConnectionState;\n      this.emit('iceConnectionStateChanged');\n    }\n\n    /**\n     * Handle ICE gathering timeout.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleIceGatheringTimeout',\n    value: function _handleIceGatheringTimeout() {\n      this._log.warn('ICE failed to gather any local candidates');\n      this._iceGatheringFailed = true;\n      this._initiateIceRestartBackoff();\n      this.emit('iceConnectionStateChanged');\n      this.emit('connectionStateChanged');\n    }\n\n    /**\n     * Handle an ICE gathering state change event.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleIceGatheringStateChange',\n    value: function _handleIceGatheringStateChange() {\n      var iceGatheringState = this._peerConnection.iceGatheringState;\n\n      var log = this._log;\n      log.debug('ICE gathering state is \"' + iceGatheringState + '\"');\n\n      // NOTE(mmalavalli): Start the ICE gathering timeout only if the RTCPeerConnection\n      // has started gathering candidates for the first time since the initial offer/answer\n      // or an offer/answer with ICE restart.\n      var _iceGatheringTimeout = this._iceGatheringTimeout,\n          delay = _iceGatheringTimeout.delay,\n          isSet = _iceGatheringTimeout.isSet;\n\n      if (iceGatheringState === 'gathering' && !this._didGenerateLocalCandidates && !isSet) {\n        log.debug('Starting ICE gathering timeout: ' + delay);\n        this._iceGatheringFailed = false;\n        this._iceGatheringTimeout.start();\n      }\n    }\n\n    /**\n     * Handle a signaling state change event.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleSignalingStateChange',\n    value: function _handleSignalingStateChange() {\n      if (this._peerConnection.signalingState === 'stable') {\n        this._appliedTrackIdsToAttributes = new Map(this._trackIdsToAttributes);\n      }\n    }\n\n    /**\n     * Handle a track event.\n     * @private\n     * @param {Event} event\n     * @returns {void}\n     */\n\n  }, {\n    key: '_handleTrackEvent',\n    value: function _handleTrackEvent(event) {\n      var _this8 = this;\n\n      var sdp = this._peerConnection.remoteDescription ? this._peerConnection.remoteDescription.sdp : null;\n\n      if (!this._trackMatcher) {\n        this._trackMatcher = event.transceiver && event.transceiver.mid ? new MIDTrackMatcher()\n        // NOTE(mroberts): Until Chrome ships RTCRtpTransceivers with MID\n        // support, we have to use the same hacky solution as Safari. Revisit\n        // this when RTCRtpTransceivers and MIDs land. We should be able to use\n        // the same technique as Firefox.\n        : isSafari || this._isUnifiedPlan ? new OrderedTrackMatcher() : new IdentityTrackMatcher();\n      }\n      this._trackMatcher.update(sdp);\n\n      var mediaStreamTrack = event.track;\n      var signaledTrackId = this._trackMatcher.match(event) || mediaStreamTrack.id;\n      var mediaTrackReceiver = new MediaTrackReceiver(signaledTrackId, mediaStreamTrack);\n\n      // NOTE(mmalavalli): In unified plan mode, \"ended\" is not fired on the remote\n      // MediaStreamTrack when the remote peer removes a track. So, when this\n      // MediaStreamTrack is re-used for a different track due to the remote peer\n      // calling RTCRtpSender.replaceTrack(), we delete the previous MediaTrackReceiver\n      // that owned this MediaStreamTrack before adding the new MediaTrackReceiver.\n      this._mediaTrackReceivers.forEach(function (trackReceiver) {\n        if (trackReceiver.track.id === mediaTrackReceiver.track.id) {\n          _this8._mediaTrackReceivers.delete(trackReceiver);\n        }\n      });\n\n      this._mediaTrackReceivers.add(mediaTrackReceiver);\n      mediaStreamTrack.addEventListener('ended', function () {\n        return _this8._mediaTrackReceivers.delete(mediaTrackReceiver);\n      });\n      this.emit('trackAdded', mediaTrackReceiver);\n    }\n\n    /**\n     * Initiate ICE Restart.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_initiateIceRestart',\n    value: function _initiateIceRestart() {\n      if (this._peerConnection.signalingState === 'closed') {\n        return;\n      }\n      var log = this._log;\n      log.warn('Attempting to restart ICE');\n      this._didGenerateLocalCandidates = false;\n      this._isIceRestartBackoffInProgress = false;\n      this._shouldRestartIce = true;\n\n      var _iceReconnectTimeout = this._iceReconnectTimeout,\n          delay = _iceReconnectTimeout.delay,\n          isSet = _iceReconnectTimeout.isSet;\n\n      if (!isSet) {\n        log.debug('Starting ICE reconnect timeout: ' + delay);\n        this._iceReconnectTimeout.start();\n      }\n      this.offer();\n    }\n\n    /**\n     * Schedule an ICE Restart.\n     * @private\n     * @returns {void}\n     */\n\n  }, {\n    key: '_initiateIceRestartBackoff',\n    value: function _initiateIceRestartBackoff() {\n      if (this._peerConnection.signalingState === 'closed' || this._isIceRestartBackoffInProgress) {\n        return;\n      }\n      this._log.warn('An ICE restart has been scheduled');\n      this._isIceRestartBackoffInProgress = true;\n      this._iceRestartBackoff.backoff();\n    }\n\n    /**\n     * Conditionally re-offer.\n     * @private\n     * @param {?RTCSessionDescriptionInit} localDescription\n     * @returns {Promise<boolean>}\n     */\n\n  }, {\n    key: '_maybeReoffer',\n    value: function _maybeReoffer(localDescription) {\n      var shouldReoffer = this._shouldOffer;\n\n      if (localDescription && localDescription.sdp) {\n        // NOTE(mmalavalli): For \"unified-plan\" sdps, if the remote RTCPeerConnection sends\n        // an offer with fewer audio m= lines than the number of audio RTCRTPSenders\n        // in the local RTCPeerConnection, then the local RTCPeerConnection creates\n        // an answer with the same number of audio m= lines as in the offer. This\n        // behavior was triggered by the removal of 'offerToReceiveAudio' from the\n        // default RTCOfferOptions. Ideally, the local RTCPeerConnection should create\n        // an answer with the same number of audio m= lines as the number of\n        // RTCRTPSenders. In order to achieve this,the local RTCPeerConnection\n        // initiates renegotiation.\n        //\n        // We can reduce the number of cases where renegotiation is needed by\n        // re-introducing 'offerToReceiveAudio' to the default RTCOfferOptions with a\n        // value > 1.\n        if (this._isUnifiedPlan && localDescription.type === 'answer') {\n          var senders = this._peerConnection.getSenders().filter(function (sender) {\n            return sender.track;\n          });\n          shouldReoffer = ['audio', 'video'].reduce(function (shouldOffer, kind) {\n            var mediaSections = getMediaSections(localDescription.sdp, kind, '(sendrecv|sendonly)');\n            var sendersOfKind = senders.filter(isSenderOfKind.bind(null, kind));\n            return shouldOffer || mediaSections.length < sendersOfKind.length;\n          }, shouldReoffer);\n        }\n\n        // NOTE(mroberts): We also need to re-offer if we have a DataTrack to share\n        // but no m= application section.\n        var hasDataTrack = this._dataChannels.size > 0;\n        var hasApplicationMediaSection = getMediaSections(localDescription.sdp, 'application').length > 0;\n        var needsApplicationMediaSection = hasDataTrack && !hasApplicationMediaSection;\n        shouldReoffer = shouldReoffer || needsApplicationMediaSection;\n      }\n\n      var promise = shouldReoffer ? this._offer() : Promise.resolve();\n      return promise.then(function () {\n        return shouldReoffer;\n      });\n    }\n\n    /**\n     * Create an offer and set it on the {@link PeerConnectionV2}.\n     * @private\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_offer',\n    value: function _offer() {\n      var _this9 = this;\n\n      var offerOptions = Object.assign({}, this._offerOptions);\n      this._needsAnswer = true;\n      if (this._shouldRestartIce) {\n        this._shouldRestartIce = false;\n        this._isRestartingIce = true;\n        offerOptions.iceRestart = true;\n      }\n\n      return Promise.all(this._replaceTrackPromises.values()).then(function () {\n        return _this9._peerConnection.createOffer(offerOptions);\n      }).catch(function () {\n        throw new MediaClientLocalDescFailedError();\n      }).then(function (offer) {\n        if (!isFirefox) {\n          offer = workaroundIssue8329(offer);\n        }\n\n        var sdp = _this9._isUnifiedPlan && _this9._peerConnection.remoteDescription ? unifiedPlanFilterLocalCodecs(offer.sdp, _this9._peerConnection.remoteDescription.sdp) : offer.sdp;\n\n        var updatedSdp = _this9._setCodecPreferences(sdp, _this9._preferredAudioCodecs, _this9._preferredVideoCodecs);\n\n        _this9._shouldOffer = false;\n        if (!_this9._negotiationRole) {\n          _this9._negotiationRole = 'offerer';\n        }\n\n        if (_this9._shouldApplySimulcast) {\n          _this9._localDescriptionWithoutSimulcast = {\n            type: 'offer',\n            sdp: updatedSdp\n          };\n          updatedSdp = _this9._setSimulcast(updatedSdp, _this9._sdpFormat, _this9._trackIdsToAttributes);\n        }\n        return _this9._setLocalDescription({\n          type: 'offer',\n          sdp: updatedSdp\n        });\n      });\n    }\n\n    /**\n     * Add or rewrite local MediaStreamTrack IDs in the given Unified Plan RTCSessionDescription.\n     * @private\n     * @param {RTCSessionDescription} description\n     * @return {RTCSessionDescription}\n     */\n\n  }, {\n    key: '_addOrRewriteLocalTrackIds',\n    value: function _addOrRewriteLocalTrackIds(description) {\n      var transceivers = this._peerConnection.getTransceivers();\n      var activeTransceivers = transceivers.filter(function (_ref) {\n        var sender = _ref.sender,\n            stopped = _ref.stopped;\n        return !stopped && sender && sender.track;\n      });\n\n      // NOTE(mmalavalli): There is no guarantee that MediaStreamTrack IDs will be present in\n      // SDPs, and even if they are, there is no guarantee that they will be the same as the\n      // actual MediaStreamTrack IDs. So, we add or re-write the actual MediaStreamTrack IDs\n      // to the assigned m= sections here.\n      var assignedTransceivers = activeTransceivers.filter(function (_ref2) {\n        var mid = _ref2.mid;\n        return mid;\n      });\n      var midsToTrackIds = new Map(assignedTransceivers.map(function (_ref3) {\n        var mid = _ref3.mid,\n            sender = _ref3.sender;\n        return [mid, sender.track.id];\n      }));\n      var sdp1 = unifiedPlanAddOrRewriteTrackIds(description.sdp, midsToTrackIds);\n\n      // NOTE(mmalavalli): Chrome and Safari do not apply the offer until they get an answer.\n      // So, we add or re-write the actual MediaStreamTrack IDs to the unassigned m= sections here.\n      var unassignedTransceivers = activeTransceivers.filter(function (_ref4) {\n        var mid = _ref4.mid;\n        return !mid;\n      });\n      var newTrackIdsByKind = new Map(['audio', 'video'].map(function (kind) {\n        return [kind, unassignedTransceivers.filter(function (_ref5) {\n          var sender = _ref5.sender;\n          return sender.track.kind === kind;\n        }).map(function (_ref6) {\n          var sender = _ref6.sender;\n          return sender.track.id;\n        })];\n      }));\n      var sdp2 = unifiedPlanAddOrRewriteNewTrackIds(sdp1, midsToTrackIds, newTrackIdsByKind);\n\n      return new this._RTCSessionDescription({\n        sdp: sdp2,\n        type: description.type\n      });\n    }\n\n    /**\n     * Rollback and apply the given offer.\n     * @private\n     * @param {RTCSessionDescriptionInit} offer\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_rollbackAndApplyOffer',\n    value: function _rollbackAndApplyOffer(offer) {\n      var _this10 = this;\n\n      return this._setLocalDescription({ type: 'rollback' }).then(function () {\n        return _this10._setLocalDescription(offer);\n      });\n    }\n\n    /**\n     * Set a local description on the {@link PeerConnectionV2}.\n     * @private\n     * @param {RTCSessionDescription|RTCSessionDescriptionInit} description\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_setLocalDescription',\n    value: function _setLocalDescription(description) {\n      var _this11 = this;\n\n      return this._peerConnection.setLocalDescription(description).catch(function (error) {\n        _this11._log.warn('Calling setLocalDescription with an RTCSessionDescription of type \"' + description.type + '\" failed with the error \"' + error.message + '\".');\n        if (description.sdp) {\n          _this11._log.warn('The SDP was ' + description.sdp);\n        }\n        throw new MediaClientLocalDescFailedError();\n      }).then(function () {\n        if (description.type !== 'rollback') {\n          _this11._localDescription = _this11._isUnifiedPlan ? _this11._addOrRewriteLocalTrackIds(description) : description;\n          _this11._localCandidates = [];\n          if (description.type === 'offer') {\n            _this11._descriptionRevision++;\n          } else if (description.type === 'answer') {\n            _this11._lastStableDescriptionRevision = _this11._descriptionRevision;\n            negotiationCompleted(_this11);\n          }\n          _this11._localUfrag = getUfrag(description);\n          _this11.emit('description', _this11.getState());\n        }\n      });\n    }\n\n    /**\n     * Set a remote RTCSessionDescription on the {@link PeerConnectionV2}.\n     * @private\n     * @param {RTCSessionDescriptionInit} description\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_setRemoteDescription',\n    value: function _setRemoteDescription(description) {\n      var _this12 = this;\n\n      if (description.sdp) {\n        if (!this._isRTCRtpSenderParamsSupported) {\n          description.sdp = this._setBitrateParameters(description.sdp, isFirefox ? 'TIAS' : 'AS', this._encodingParameters.maxAudioBitrate, this._encodingParameters.maxVideoBitrate);\n        }\n        description.sdp = this._setCodecPreferences(description.sdp, this._preferredAudioCodecs, this._preferredVideoCodecs);\n        // NOTE(mroberts): Do this to reduce our MediaStream count in Firefox. By\n        // mapping MediaStream IDs in the SDP to \"-\", we ensure the \"track\" event\n        // doesn't include any new MediaStreams in Firefox. Its `streams` member\n        // will always be the empty Array.\n        if (isFirefox) {\n          description.sdp = filterOutMediaStreamIds(description.sdp);\n        }\n        if (!this._peerConnection.remoteDescription) {\n          this._isIceLite = /a=ice-lite/.test(description.sdp);\n        }\n      }\n      description = new this._RTCSessionDescription(description);\n      // eslint-disable-next-line consistent-return\n      return Promise.resolve().then(function () {\n        // NOTE(syerrapragada): VMS does not support H264 simulcast. So,\n        // unset simulcast for sections in local offer where corresponding\n        // sections in answer doesn't have vp8 as preferred codec and reapply offer.\n        if (description.type === 'answer' && _this12._shouldApplySimulcast) {\n          var sdpWithoutSimulcastForNonVP8MediaSections = _this12._revertSimulcastForNonVP8MediaSections(_this12._localDescription.sdp, _this12._localDescriptionWithoutSimulcast.sdp, description.sdp);\n          if (sdpWithoutSimulcastForNonVP8MediaSections !== _this12._localDescription.sdp) {\n            return _this12._rollbackAndApplyOffer({\n              type: _this12._localDescription.type,\n              sdp: sdpWithoutSimulcastForNonVP8MediaSections\n            });\n          }\n        }\n      }).then(function () {\n        return _this12._peerConnection.setRemoteDescription(description);\n      }).then(function () {\n        if (description.type === 'answer') {\n          if (_this12._isRestartingIce) {\n            _this12._log.debug('An ICE restart was in-progress and is now completed');\n            _this12._isRestartingIce = false;\n          }\n          negotiationCompleted(_this12);\n        }\n      }, function (error) {\n        _this12._log.warn('Calling setRemoteDescription with an RTCSessionDescription of type \"' + description.type + '\" failed with the error \"' + error.message + '\".');\n        if (description.sdp) {\n          _this12._log.warn('The SDP was ' + description.sdp);\n        }\n        throw error;\n      });\n    }\n\n    /**\n     * Update the {@link PeerConnectionV2}'s description.\n     * @private\n     * @param {RTCSessionDescriptionInit} description\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_updateDescription',\n    value: function _updateDescription(description) {\n      var _this13 = this;\n\n      switch (description.type) {\n        case 'answer':\n        case 'pranswer':\n          if (description.revision !== this._descriptionRevision || this._peerConnection.signalingState !== 'have-local-offer') {\n            return Promise.resolve();\n          }\n          this._descriptionRevision = description.revision;\n          break;\n        case 'close':\n          return this._close();\n        case 'create-offer':\n          if (description.revision <= this._lastStableDescriptionRevision) {\n            return Promise.resolve();\n          } else if (this._needsAnswer) {\n            this._queuedDescription = description;\n            return Promise.resolve();\n          }\n          this._descriptionRevision = description.revision;\n          return this._offer();\n        case 'offer':\n          if (description.revision <= this._lastStableDescriptionRevision || this._peerConnection.signalingState === 'closed') {\n            return Promise.resolve();\n          }\n          if (this._peerConnection.signalingState === 'have-local-offer') {\n            // NOTE(mpatwardhan): For a peer connection\n            // 1) createOffer always generate SDP with `setup:actpass`\n            // 2) when remote description is set `setup:active`  - the answer generated selects the dtls role of setup:passive\n            // 3) when remote description is set `setup:passive` - the answer generated selects the dtls role of setup:active\n            // 4) when remote description is set `setup:actpass` - the answer generated uses the previously negotiated role (if not negotiated previously setup:active is used)\n            // This test shows the  behavior: https://github.com/twilio/twilio-webrtc.js/blob/master/test/integration/spec/rtcpeerconnection.js#L936\n            // with glare handling (if dtls role was not negotiated before ) the generated answer will set setup:active.\n            // we do not want that. lets wait for \"initial negotiation\" before attempting glare handling.\n            if (this._needsAnswer && this._lastStableDescriptionRevision === 0) {\n              this._queuedDescription = description;\n              return Promise.resolve();\n            }\n            this._descriptionRevision = description.revision;\n            return this._handleGlare(description);\n          }\n          this._descriptionRevision = description.revision;\n          return this._answer(description).then(function () {});\n        default:\n        // Do nothing.\n      }\n\n      // Handle answer or pranswer.\n      var revision = description.revision;\n      return Promise.resolve().then(function () {\n        return _this13._setRemoteDescription(description);\n      }).catch(function () {\n        throw new MediaClientRemoteDescFailedError();\n      }).then(function () {\n        _this13._lastStableDescriptionRevision = revision;\n        _this13._needsAnswer = false;\n        return _this13._checkIceBox(description);\n      }).then(function () {\n        return _this13._queuedDescription && _this13._updateDescription(_this13._queuedDescription);\n      }).then(function () {\n        _this13._queuedDescription = null;\n        return _this13._maybeReoffer(_this13._peerConnection.localDescription).then(function () {});\n      });\n    }\n\n    /**\n     * Update the {@link PeerConnectionV2}'s ICE candidates.\n     * @private\n     * @param {object} iceState\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: '_updateIce',\n    value: function _updateIce(iceState) {\n      var candidates = this._remoteCandidates.update(iceState);\n      return this._addIceCandidates(candidates);\n    }\n\n    /**\n     * Add a {@link DataTrackSender} to the {@link PeerConnectionV2}.\n     * @param {DataTrackSender} dataTrackSender\n     * @returns {void}\n     */\n\n  }, {\n    key: 'addDataTrackSender',\n    value: function addDataTrackSender(dataTrackSender) {\n      if (this._dataChannels.has(dataTrackSender)) {\n        return;\n      }\n      try {\n        var dataChannelDict = {\n          ordered: dataTrackSender.ordered\n        };\n        if (dataTrackSender.maxPacketLifeTime !== null) {\n          dataChannelDict.maxPacketLifeTime = dataTrackSender.maxPacketLifeTime;\n        }\n        if (dataTrackSender.maxRetransmits !== null) {\n          dataChannelDict.maxRetransmits = dataTrackSender.maxRetransmits;\n        }\n        var dataChannel = this._peerConnection.createDataChannel(dataTrackSender.id, dataChannelDict);\n        dataTrackSender.addDataChannel(dataChannel);\n        this._dataChannels.set(dataTrackSender, dataChannel);\n      } catch (error) {\n        this._log.warn('Error creating an RTCDataChannel for DataTrack \"' + dataTrackSender.id + '\": ' + error.message);\n      }\n    }\n\n    /**\n     * Add the {@link MediaTrackSender} to the {@link PeerConnectionV2}.\n     * @param {MediaTrackSender} mediaTrackSender\n     * @returns {void}\n     */\n\n  }, {\n    key: 'addMediaTrackSender',\n    value: function addMediaTrackSender(mediaTrackSender) {\n      if (this._peerConnection.signalingState === 'closed' || this._rtpSenders.has(mediaTrackSender)) {\n        return;\n      }\n      var sender = void 0;\n      if (this._localMediaStream) {\n        this._localMediaStream.addTrack(mediaTrackSender.track);\n        sender = this._peerConnection.addTrack(mediaTrackSender.track, this._localMediaStream);\n      } else {\n        var transceiver = this._addOrUpdateTransceiver(mediaTrackSender.track);\n        sender = transceiver.sender;\n      }\n      mediaTrackSender.addSender(sender);\n      this._rtpSenders.set(mediaTrackSender, sender);\n    }\n\n    /**\n     * Close the {@link PeerConnectionV2}.\n     * @returns {void}\n     */\n\n  }, {\n    key: 'close',\n    value: function close() {\n      if (this._close()) {\n        this._descriptionRevision++;\n        this._localDescription = { type: 'close' };\n        this.emit('description', this.getState());\n      }\n    }\n\n    /**\n     * Get the {@link DataTrackReceiver}s and the {@link MediaTrackReceivers} on the\n     * {@link PeerConnectionV2}.\n     * @returns {Array<DataTrackReceiver|MediaTrackReceiver>} trackReceivers\n     */\n\n  }, {\n    key: 'getTrackReceivers',\n    value: function getTrackReceivers() {\n      return Array.from(this._dataTrackReceivers).concat(Array.from(this._mediaTrackReceivers));\n    }\n\n    /**\n     * Get the {@link PeerConnectionV2}'s state (specifically, its description).\n     * @returns {?object}\n     */\n\n  }, {\n    key: 'getState',\n    value: function getState() {\n      if (!this._localDescription) {\n        return null;\n      }\n      var localDescription = {\n        type: this._localDescription.type,\n        revision: this._descriptionRevision\n      };\n      if (this._localDescription.sdp) {\n        localDescription.sdp = this._localDescription.sdp;\n      }\n      return {\n        description: localDescription,\n        id: this.id\n      };\n    }\n\n    /**\n     * Create an offer and set it on the {@link PeerConnectionV2}.\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: 'offer',\n    value: function offer() {\n      var _this14 = this;\n\n      if (this._needsAnswer || this._isRestartingIce) {\n        this._shouldOffer = true;\n        return Promise.resolve();\n      }\n\n      return this.bracket('offering', function (key) {\n        _this14.transition('updating', key);\n        var promise = _this14._needsAnswer || _this14._isRestartingIce ? Promise.resolve() : _this14._offer();\n        return promise.then(function () {\n          _this14.tryTransition('open', key);\n        }, function (error) {\n          _this14.tryTransition('open', key);\n          throw error;\n        });\n      });\n    }\n\n    /**\n     * Remove a {@link DataTrackSender} from the {@link PeerConnectionV2}.\n     * @param {DataTrackSender} dataTrackSender\n     * @returns {void}\n     */\n\n  }, {\n    key: 'removeDataTrackSender',\n    value: function removeDataTrackSender(dataTrackSender) {\n      var dataChannel = this._dataChannels.get(dataTrackSender);\n      if (dataChannel) {\n        dataTrackSender.removeDataChannel(dataChannel);\n        this._dataChannels.delete(dataTrackSender);\n        dataChannel.close();\n      }\n    }\n\n    /**\n     * Remove the {@link MediaTrackSender} from the {@link PeerConnectionV2}.\n     * @param {MediaTrackSender} mediaTrackSender\n     * @returns {void}\n     */\n\n  }, {\n    key: 'removeMediaTrackSender',\n    value: function removeMediaTrackSender(mediaTrackSender) {\n      if (this._peerConnection.signalingState === 'closed' || !this._rtpSenders.has(mediaTrackSender)) {\n        return;\n      }\n      var sender = this._rtpSenders.get(mediaTrackSender);\n      this._peerConnection.removeTrack(sender);\n      if (this._localMediaStream) {\n        this._localMediaStream.removeTrack(mediaTrackSender.track);\n      }\n      mediaTrackSender.removeSender(sender);\n      this._rtpSenders.delete(mediaTrackSender);\n    }\n\n    /**\n     * Set the RTCConfiguration on the underlying RTCPeerConnection.\n     * @param {RTCConfiguration} configuration\n     * @returns {void}\n     */\n\n  }, {\n    key: 'setConfiguration',\n    value: function setConfiguration(configuration) {\n      if (typeof this._peerConnection.setConfiguration === 'function') {\n        this._peerConnection.setConfiguration(getConfiguration(configuration));\n      }\n    }\n\n    /**\n     * Set the ICE reconnect timeout period.\n     * @param {number} period - Period in milliseconds.\n     * @returns {this}\n     */\n\n  }, {\n    key: 'setIceReconnectTimeout',\n    value: function setIceReconnectTimeout(period) {\n      this._iceReconnectTimeout.setDelay(period);\n      this._log.debug('Updated ICE reconnection timeout period:', this._iceReconnectTimeout.delay);\n      return this;\n    }\n\n    /**\n     * Update the {@link PeerConnectionV2}.\n     * @param {object} peerConnectionState\n     * @returns {Promise<void>}\n     */\n\n  }, {\n    key: 'update',\n    value: function update(peerConnectionState) {\n      var _this15 = this;\n\n      return this.bracket('updating', function (key) {\n        if (_this15.state === 'closed') {\n          return Promise.resolve();\n        }\n\n        _this15.transition('updating', key);\n\n        var updates = [];\n\n        if (peerConnectionState.ice) {\n          updates.push(_this15._updateIce(peerConnectionState.ice));\n        }\n\n        if (peerConnectionState.description) {\n          updates.push(_this15._updateDescription(peerConnectionState.description));\n        }\n\n        return Promise.all(updates).then(function () {\n          _this15.tryTransition('open', key);\n        }, function (error) {\n          _this15.tryTransition('open', key);\n          throw error;\n        });\n      });\n    }\n\n    /**\n     * Get the {@link PeerConnectionV2}'s media statistics.\n     * @returns {Promise<StandardizedStatsResponse>}\n     */\n\n  }, {\n    key: 'getStats',\n    value: function getStats() {\n      var _this16 = this;\n\n      return getStatistics(this._peerConnection).then(function (response) {\n        return rewriteTrackIds(_this16, response);\n      });\n    }\n  }, {\n    key: 'connectionState',\n    get: function get() {\n      return this.iceConnectionState === 'failed' ? 'failed' : this._peerConnection.connectionState || this.iceConnectionState;\n    }\n\n    /**\n     * The {@link PeerConnectionV2}'s underlying RTCPeerConnection's\n     * RTCIceConnectionState.\n     * @property {RTCIceConnectionState}\n     */\n\n  }, {\n    key: 'iceConnectionState',\n    get: function get() {\n      return this._isIceConnectionInactive && this._peerConnection.iceConnectionState === 'disconnected' || this._iceGatheringFailed ? 'failed' : this._peerConnection.iceConnectionState;\n    }\n\n    /**\n     * Whether the {@link PeerConnectionV2} has negotiated or is in the process\n     * of negotiating the application m= section.\n     * @returns {boolean}\n     */\n\n  }, {\n    key: 'isApplicationSectionNegotiated',\n    get: function get() {\n      if (this._peerConnection.signalingState !== 'closed') {\n        // accessing .localDescription in 'closed' state causes it throw exceptions.\n        return this._peerConnection.localDescription ? getMediaSections(this._peerConnection.localDescription.sdp, 'application').length > 0 : false;\n      }\n      return true;\n    }\n  }]);\n\n  return PeerConnectionV2;\n}(StateMachine);\n\nfunction rewriteTrackId(pcv2, stats) {\n  var receiver = [].concat(_toConsumableArray(pcv2._mediaTrackReceivers)).find(function (receiver) {\n    return receiver.track.id === stats.trackId;\n  });\n  var trackId = receiver ? receiver.id : null;\n  return Object.assign(stats, { trackId: trackId });\n}\n\nfunction rewriteTrackIds(pcv2, response) {\n  return Object.assign(response, {\n    remoteAudioTrackStats: response.remoteAudioTrackStats.map(function (stats) {\n      return rewriteTrackId(pcv2, stats);\n    }),\n    remoteVideoTrackStats: response.remoteVideoTrackStats.map(function (stats) {\n      return rewriteTrackId(pcv2, stats);\n    })\n  });\n}\n\n/**\n * @event PeerConnectionV2#candidates\n * @param {object} candidates\n */\n\n/**\n * @event PeerConnectionV2#connectionStateChanged\n */\n\n/**\n * @event PeerConnectionV2#description\n * @param {object} description\n */\n\n/**\n * @event PeerConnectionV2#iceConnectionStateChanged\n */\n\n/**\n * @event PeerConnectionV2#trackAdded\n * @param {DataTrackReceiver|MediaTrackReceiver} trackReceiver\n */\n\nfunction getUfrag(description) {\n  if (description.sdp) {\n    var match = description.sdp.match(/^a=ice-ufrag:([a-zA-Z0-9+/]+)/m);\n    if (match) {\n      return match[1];\n    }\n  }\n  return null;\n}\n\nfunction getConfiguration(configuration) {\n  return Object.assign({\n    bundlePolicy: 'max-bundle',\n    rtcpMuxPolicy: 'require'\n  }, configuration);\n}\n\n/**\n * Whether the MediaStreamTrack of the given RTCRTPSender is a non-ended\n * MediaStreamTrack of a given kind.\n * @private\n * @param {string} kind\n * @param {RTCRtpSender} sender\n * @return {boolean}\n */\nfunction isSenderOfKind(kind, sender) {\n  var track = sender.track;\n  return track && track.kind === kind && track.readyState !== 'ended';\n}\n\n/**\n * Preferred codecs.\n * @typedef {object} PreferredCodecs\n * @property {Array<AudioCodec>} audio\n * @property {Array<VideoCodec>} video\n */\n\nfunction filterOutMediaStreamIds(sdp) {\n  return sdp.replace(/a=msid:[^ ]+ /g, 'a=msid:- ');\n}\n\n/**\n * Whether an RTCRtpTransceiver can be recycled.\n * @param {RTCRtpTransceiver} transceiver\n * @returns {boolean}\n */\nfunction shouldRecycleTransceiver(transceiver, pcv2) {\n  return !transceiver.stopped && !pcv2._replaceTrackPromises.has(transceiver) && (transceiver.currentDirection === 'inactive' || transceiver.currentDirection === 'recvonly' || transceiver.direction === 'recvonly');\n}\n\n/**\n * Take a recycled RTCRtpTransceiver if available.\n * @param {PeerConnectionV2} pcv2\n * @param {Track.Kind} kind\n * @returns {?RTCRtpTransceiver}\n */\nfunction takeRecycledTransceiver(pcv2, kind) {\n  var preferredCodecs = {\n    audio: pcv2._preferredAudioCodecs.map(function (codec) {\n      return codec.toLowerCase();\n    }),\n    video: pcv2._preferredVideoCodecs.map(function (_ref7) {\n      var codec = _ref7.codec;\n      return codec.toLowerCase();\n    })\n  }[kind];\n\n  var recycledTransceivers = pcv2._recycledTransceivers[kind];\n  var localCodec = preferredCodecs.find(function (codec) {\n    return pcv2._localCodecs.has(codec);\n  });\n  if (!localCodec) {\n    return recycledTransceivers.shift();\n  }\n\n  var transceiver = recycledTransceivers.find(function (transceiver) {\n    var remoteCodecMap = pcv2._remoteCodecMaps.get(transceiver.mid);\n    return remoteCodecMap && remoteCodecMap.has(localCodec);\n  });\n\n  if (transceiver) {\n    recycledTransceivers.splice(recycledTransceivers.indexOf(transceiver), 1);\n  }\n  return transceiver;\n}\n\n/**\n * Update the set of locally supported {@link Codec}s.\n * @param pcv2\n * @returns {void}\n */\nfunction updateLocalCodecs(pcv2) {\n  var description = pcv2._peerConnection.localDescription;\n  if (!description) {\n    return;\n  }\n  getMediaSections(description.sdp).forEach(function (section) {\n    var codecMap = createCodecMapForMediaSection(section);\n    codecMap.forEach(function (pts, codec) {\n      return pcv2._localCodecs.add(codec);\n    });\n  });\n}\n\n/**\n * Update the {@link Codec} maps for all m= sections in the remote {@link RTCSessionDescription}s.\n * @param {PeerConnectionV2} pcv2\n * @returns {void}\n */\nfunction updateRemoteCodecMaps(pcv2) {\n  var description = pcv2._peerConnection.remoteDescription;\n  if (!description) {\n    return;\n  }\n  getMediaSections(description.sdp).forEach(function (section) {\n    var mid = section.match(/^a=mid:(.+)$/m)[1];\n    var codecMap = createCodecMapForMediaSection(section);\n    pcv2._remoteCodecMaps.set(mid, codecMap);\n  });\n}\n\n/**\n * Update the list of recycled RTCRtpTransceivers.\n * @param {PeerConnectionV2} pcv2\n */\nfunction updateRecycledTransceivers(pcv2) {\n  pcv2._recycledTransceivers.audio = [];\n  pcv2._recycledTransceivers.video = [];\n  pcv2._peerConnection.getTransceivers().forEach(function (transceiver) {\n    if (shouldRecycleTransceiver(transceiver, pcv2)) {\n      var track = transceiver.receiver.track;\n      pcv2._recycledTransceivers[track.kind].push(transceiver);\n    }\n  });\n}\n\n/**\n * Perform certain updates after an SDP negotiation is completed.\n * @param {PeerConnectionV2} pcv2\n * @returns {void}\n */\nfunction negotiationCompleted(pcv2) {\n  if (pcv2._isUnifiedPlan) {\n    updateRecycledTransceivers(pcv2);\n    updateLocalCodecs(pcv2);\n    updateRemoteCodecMaps(pcv2);\n  }\n  if (pcv2._isRTCRtpSenderParamsSupported) {\n    updateEncodingParameters(pcv2);\n  }\n}\n\n/**\n * Update the RTCRtpEncodingParameters of all active RTCRtpSenders.\n * @param {PeerConnectionV2} pcv2\n * @returns {void}\n */\nfunction updateEncodingParameters(pcv2) {\n  var _pcv2$_encodingParame = pcv2._encodingParameters,\n      maxAudioBitrate = _pcv2$_encodingParame.maxAudioBitrate,\n      maxVideoBitrate = _pcv2$_encodingParame.maxVideoBitrate;\n\n\n  var maxBitrates = new Map([['audio', maxAudioBitrate], ['video', maxVideoBitrate]]);\n\n  pcv2._peerConnection.getSenders().filter(function (sender) {\n    return sender.track;\n  }).forEach(function (sender) {\n    var maxBitrate = maxBitrates.get(sender.track.kind);\n    var params = sender.getParameters();\n\n    if (maxBitrate === null || maxBitrate === 0) {\n      removeMaxBitrate(params);\n    } else if (pcv2._isChromeScreenShareTrack(sender.track)) {\n      // NOTE(mpatwardhan): Sometimes (JSDK-2557) chrome does not send any bytes on screen track if MaxBitRate is set on it via setParameters,\n      // To workaround this issue we will not apply maxBitrate if the track appears to be a screen share track created by chrome\n      pcv2._log.warn('Not setting maxBitrate for ' + sender.track.kind + ' Track ' + sender.track.id + ' because it appears to be screen share track: ' + sender.track.label);\n    } else {\n      setMaxBitrate(params, maxBitrate);\n    }\n\n    if (!isFirefox && pcv2._enableDscp && params.encodings.length > 0) {\n      // NOTE(mmalavalli): \"networkPriority\" is a per-sender property and not\n      // a per-encoding-layer property. So, we set the value only on the first\n      // encoding layer. Any attempt to set the value on subsequent encoding\n      // layers (in the case of simulcast) will result in the Promise returned\n      // by RTCRtpSender.setParameters() being rejected.\n      params.encodings[0].networkPriority = 'high';\n    }\n\n    sender.setParameters(params).catch(function (error) {\n      pcv2._log.warn('Error while setting encodings parameters for ' + sender.track.kind + ' Track ' + sender.track.id + ': ' + (error.message || error.name));\n    });\n  });\n}\n\n/**\n * Remove maxBitrate from the RTCRtpSendParameters' encodings.\n * @param {RTCRtpSendParameters} params\n * @returns {void}\n */\nfunction removeMaxBitrate(params) {\n  if (Array.isArray(params.encodings)) {\n    params.encodings.forEach(function (encoding) {\n      return delete encoding.maxBitrate;\n    });\n  }\n}\n\n/**\n * Set the given maxBitrate in the RTCRtpSendParameters' encodings.\n * @param {RTCRtpSendParameters} params\n * @param {number} maxBitrate\n * @returns {void}\n */\nfunction setMaxBitrate(params, maxBitrate) {\n  if (isFirefox) {\n    params.encodings = [{ maxBitrate: maxBitrate }];\n  } else {\n    params.encodings.forEach(function (encoding) {\n      encoding.maxBitrate = maxBitrate;\n    });\n  }\n}\n\nmodule.exports = PeerConnectionV2;"]},"metadata":{},"sourceType":"script"}