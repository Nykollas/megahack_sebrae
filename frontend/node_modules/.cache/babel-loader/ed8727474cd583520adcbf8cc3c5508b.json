{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst uuid = require(\"uuid\");\n\nconst syncerror_1 = require(\"../utils/syncerror\");\n\nconst logger_1 = require(\"../utils/logger\");\n\nconst operation_retrier_1 = require(\"operation-retrier\");\n\nconst twilsock_1 = require(\"twilsock\");\n\nconst MINIMUM_RETRY_DELAY = 4000;\nconst MAXIMUM_RETRY_DELAY = 60000;\nconst MAXIMUM_ATTEMPTS_TIME = 90000;\nconst RETRY_DELAY_RANDOMNESS = 0.2;\n\nfunction messageFromErrorBody(transportError) {\n  if (transportError.body) {\n    if (transportError.body.message) {\n      return transportError.body.message;\n    }\n  }\n\n  switch (transportError.status) {\n    case 429:\n      return 'Throttled by server';\n\n    case 404:\n      return 'Not found from server';\n\n    default:\n      return 'Error from server';\n  }\n}\n\nfunction codeFromErrorBody(trasportError) {\n  if (trasportError.body) {\n    return trasportError.body.code;\n  }\n\n  return 0;\n}\n\nfunction mapTransportError(transportError) {\n  if (transportError.status === 409) {\n    return new syncerror_1.SyncNetworkError(messageFromErrorBody(transportError), transportError.status, codeFromErrorBody(transportError), transportError.body);\n  } else if (transportError.status) {\n    return new syncerror_1.SyncError(messageFromErrorBody(transportError), transportError.status, codeFromErrorBody(transportError));\n  } else if (transportError instanceof twilsock_1.TransportUnavailableError) {\n    return transportError;\n  } else {\n    return new syncerror_1.SyncError(transportError.message, 0, 0);\n  }\n}\n/**\n * @classdesc Incapsulates network operations to make it possible to add some optimization/caching strategies\n */\n\n\nclass NetworkService {\n  constructor(clientInfo, config, transport) {\n    this.clientInfo = clientInfo;\n    this.config = config;\n    this.transport = transport;\n  }\n\n  createHeaders() {\n    return {\n      'Content-Type': 'application/json',\n      'Twilio-Sync-Client-Info': JSON.stringify(this.clientInfo),\n      'Twilio-Request-Id': 'RQ' + uuid.v4().replace(/-/g, '')\n    };\n  }\n\n  backoffConfig() {\n    return Object.assign({\n      min: MINIMUM_RETRY_DELAY,\n      max: MAXIMUM_RETRY_DELAY,\n      maxAttemptsTime: MAXIMUM_ATTEMPTS_TIME,\n      randomness: RETRY_DELAY_RANDOMNESS\n    }, this.config.backoffConfig);\n  }\n\n  executeWithRetry(request, retryWhenThrottled = true) {\n    return new Promise((resolve, reject) => {\n      let codesToRetryOn = [502, 503, 504];\n\n      if (retryWhenThrottled) {\n        codesToRetryOn.push(429);\n      }\n\n      let retrier = new operation_retrier_1.Retrier(this.backoffConfig());\n      retrier.on('attempt', () => {\n        request().then(result => retrier.succeeded(result)).catch(err => {\n          if (codesToRetryOn.includes(err.status)) {\n            let delayOverride = parseInt(err.headers ? err.headers['Retry-After'] : null);\n            retrier.failed(mapTransportError(err), isNaN(delayOverride) ? null : delayOverride * 1000);\n          } else if (err.message === 'Twilsock disconnected') {\n            // Ugly hack. We must make a proper exceptions for twilsock\n            retrier.failed(mapTransportError(err));\n          } else {\n            // Fatal error\n            retrier.removeAllListeners();\n            retrier.cancel();\n            reject(mapTransportError(err));\n          }\n        });\n      });\n      retrier.on('succeeded', result => {\n        resolve(result);\n      });\n      retrier.on('cancelled', err => reject(mapTransportError(err)));\n      retrier.on('failed', err => reject(mapTransportError(err)));\n      retrier.start();\n    });\n  }\n  /**\n   * Make a GET request by given URI\n   * @Returns Promise<Response> Result of successful get request\n   */\n\n\n  get(uri) {\n    let headers = this.createHeaders();\n    logger_1.default.debug('GET', uri, 'ID:', headers['Twilio-Request-Id']);\n    return this.executeWithRetry(() => this.transport.get(uri, headers), true);\n  }\n\n  post(uri, body, revision, retryWhenThrottled = false) {\n    let headers = this.createHeaders();\n\n    if (typeof revision !== 'undefined' && revision !== null) {\n      headers['If-Match'] = revision;\n    }\n\n    logger_1.default.debug('POST', uri, 'ID:', headers['Twilio-Request-Id']);\n    return this.executeWithRetry(() => this.transport.post(uri, headers, body), retryWhenThrottled);\n  }\n\n  put(uri, body, revision) {\n    let headers = this.createHeaders();\n\n    if (typeof revision !== 'undefined' && revision !== null) {\n      headers['If-Match'] = revision;\n    }\n\n    logger_1.default.debug('PUT', uri, 'ID:', headers['Twilio-Request-Id']);\n    return this.executeWithRetry(() => this.transport.put(uri, headers, body), false);\n  }\n\n  delete(uri) {\n    let headers = this.createHeaders();\n    logger_1.default.debug('DELETE', uri, 'ID:', headers['Twilio-Request-Id']);\n    return this.executeWithRetry(() => this.transport.delete(uri, headers), false);\n  }\n\n}\n\nexports.NetworkService = NetworkService;","map":{"version":3,"sources":["/home/ascencion/sebrae_megahack/node_modules/twilio-sync/lib/services/network.js"],"names":["Object","defineProperty","exports","value","uuid","require","syncerror_1","logger_1","operation_retrier_1","twilsock_1","MINIMUM_RETRY_DELAY","MAXIMUM_RETRY_DELAY","MAXIMUM_ATTEMPTS_TIME","RETRY_DELAY_RANDOMNESS","messageFromErrorBody","transportError","body","message","status","codeFromErrorBody","trasportError","code","mapTransportError","SyncNetworkError","SyncError","TransportUnavailableError","NetworkService","constructor","clientInfo","config","transport","createHeaders","JSON","stringify","v4","replace","backoffConfig","assign","min","max","maxAttemptsTime","randomness","executeWithRetry","request","retryWhenThrottled","Promise","resolve","reject","codesToRetryOn","push","retrier","Retrier","on","then","result","succeeded","catch","err","includes","delayOverride","parseInt","headers","failed","isNaN","removeAllListeners","cancel","start","get","uri","default","debug","post","revision","put","delete"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst uuid = require(\"uuid\");\nconst syncerror_1 = require(\"../utils/syncerror\");\nconst logger_1 = require(\"../utils/logger\");\nconst operation_retrier_1 = require(\"operation-retrier\");\nconst twilsock_1 = require(\"twilsock\");\nconst MINIMUM_RETRY_DELAY = 4000;\nconst MAXIMUM_RETRY_DELAY = 60000;\nconst MAXIMUM_ATTEMPTS_TIME = 90000;\nconst RETRY_DELAY_RANDOMNESS = 0.2;\nfunction messageFromErrorBody(transportError) {\n    if (transportError.body) {\n        if (transportError.body.message) {\n            return transportError.body.message;\n        }\n    }\n    switch (transportError.status) {\n        case 429:\n            return 'Throttled by server';\n        case 404:\n            return 'Not found from server';\n        default:\n            return 'Error from server';\n    }\n}\nfunction codeFromErrorBody(trasportError) {\n    if (trasportError.body) {\n        return trasportError.body.code;\n    }\n    return 0;\n}\nfunction mapTransportError(transportError) {\n    if (transportError.status === 409) {\n        return new syncerror_1.SyncNetworkError(messageFromErrorBody(transportError), transportError.status, codeFromErrorBody(transportError), transportError.body);\n    }\n    else if (transportError.status) {\n        return new syncerror_1.SyncError(messageFromErrorBody(transportError), transportError.status, codeFromErrorBody(transportError));\n    }\n    else if (transportError instanceof twilsock_1.TransportUnavailableError) {\n        return transportError;\n    }\n    else {\n        return new syncerror_1.SyncError(transportError.message, 0, 0);\n    }\n}\n/**\n * @classdesc Incapsulates network operations to make it possible to add some optimization/caching strategies\n */\nclass NetworkService {\n    constructor(clientInfo, config, transport) {\n        this.clientInfo = clientInfo;\n        this.config = config;\n        this.transport = transport;\n    }\n    createHeaders() {\n        return {\n            'Content-Type': 'application/json',\n            'Twilio-Sync-Client-Info': JSON.stringify(this.clientInfo),\n            'Twilio-Request-Id': 'RQ' + uuid.v4().replace(/-/g, '')\n        };\n    }\n    backoffConfig() {\n        return Object.assign({\n            min: MINIMUM_RETRY_DELAY,\n            max: MAXIMUM_RETRY_DELAY,\n            maxAttemptsTime: MAXIMUM_ATTEMPTS_TIME,\n            randomness: RETRY_DELAY_RANDOMNESS\n        }, this.config.backoffConfig);\n    }\n    executeWithRetry(request, retryWhenThrottled = true) {\n        return new Promise((resolve, reject) => {\n            let codesToRetryOn = [502, 503, 504];\n            if (retryWhenThrottled) {\n                codesToRetryOn.push(429);\n            }\n            let retrier = new operation_retrier_1.Retrier(this.backoffConfig());\n            retrier.on('attempt', () => {\n                request()\n                    .then(result => retrier.succeeded(result))\n                    .catch(err => {\n                    if (codesToRetryOn.includes(err.status)) {\n                        let delayOverride = parseInt(err.headers ? err.headers['Retry-After'] : null);\n                        retrier.failed(mapTransportError(err), isNaN(delayOverride) ? null : delayOverride * 1000);\n                    }\n                    else if (err.message === 'Twilsock disconnected') {\n                        // Ugly hack. We must make a proper exceptions for twilsock\n                        retrier.failed(mapTransportError(err));\n                    }\n                    else {\n                        // Fatal error\n                        retrier.removeAllListeners();\n                        retrier.cancel();\n                        reject(mapTransportError(err));\n                    }\n                });\n            });\n            retrier.on('succeeded', result => {\n                resolve(result);\n            });\n            retrier.on('cancelled', err => reject(mapTransportError(err)));\n            retrier.on('failed', err => reject(mapTransportError(err)));\n            retrier.start();\n        });\n    }\n    /**\n     * Make a GET request by given URI\n     * @Returns Promise<Response> Result of successful get request\n     */\n    get(uri) {\n        let headers = this.createHeaders();\n        logger_1.default.debug('GET', uri, 'ID:', headers['Twilio-Request-Id']);\n        return this.executeWithRetry(() => this.transport.get(uri, headers), true);\n    }\n    post(uri, body, revision, retryWhenThrottled = false) {\n        let headers = this.createHeaders();\n        if (typeof revision !== 'undefined' && revision !== null) {\n            headers['If-Match'] = revision;\n        }\n        logger_1.default.debug('POST', uri, 'ID:', headers['Twilio-Request-Id']);\n        return this.executeWithRetry(() => this.transport.post(uri, headers, body), retryWhenThrottled);\n    }\n    put(uri, body, revision) {\n        let headers = this.createHeaders();\n        if (typeof revision !== 'undefined' && revision !== null) {\n            headers['If-Match'] = revision;\n        }\n        logger_1.default.debug('PUT', uri, 'ID:', headers['Twilio-Request-Id']);\n        return this.executeWithRetry(() => this.transport.put(uri, headers, body), false);\n    }\n    delete(uri) {\n        let headers = this.createHeaders();\n        logger_1.default.debug('DELETE', uri, 'ID:', headers['Twilio-Request-Id']);\n        return this.executeWithRetry(() => this.transport.delete(uri, headers), false);\n    }\n}\nexports.NetworkService = NetworkService;\n"]},"metadata":{},"sourceType":"script"}