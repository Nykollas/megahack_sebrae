{"ast":null,"code":"\"use strict\";\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _stringify = require(\"babel-runtime/core-js/json/stringify\");\n\nvar _stringify2 = _interopRequireDefault(_stringify);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _set = require(\"babel-runtime/core-js/set\");\n\nvar _set2 = _interopRequireDefault(_set);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _getPrototypeOf = require(\"babel-runtime/core-js/object/get-prototype-of\");\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _possibleConstructorReturn2 = require(\"babel-runtime/helpers/possibleConstructorReturn\");\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require(\"babel-runtime/helpers/inherits\");\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar events_1 = require(\"events\");\n\nvar logger_1 = require(\"../logger\");\n\nvar channel_1 = require(\"../channel\");\n\nexports.Channel = channel_1.Channel;\n\nvar deferred_1 = require(\"../util/deferred\");\n\nvar util_1 = require(\"../util\");\n\nvar log = logger_1.Logger.scope('Channels');\n/**\n * Represents channels collection\n * {@see Channel}\n */\n\nvar Channels = function (_events_1$EventEmitte) {\n  (0, _inherits3.default)(Channels, _events_1$EventEmitte);\n\n  function Channels(services) {\n    (0, _classCallCheck3.default)(this, Channels);\n\n    var _this = (0, _possibleConstructorReturn3.default)(this, (Channels.__proto__ || (0, _getPrototypeOf2.default)(Channels)).call(this));\n\n    _this.services = services;\n    _this.channels = new _map2.default();\n    _this.thumbstones = new _set2.default();\n    _this.syncListFetched = false;\n    _this.syncListRead = new deferred_1.Deferred();\n    return _this;\n  }\n\n  (0, _createClass3.default)(Channels, [{\n    key: \"getMap\",\n    value: function getMap() {\n      var _this2 = this;\n\n      return this.services.session.getMyChannelsId().then(function (name) {\n        return _this2.services.syncClient.map({\n          id: name,\n          mode: 'open_existing'\n        });\n      });\n    }\n    /**\n     * Add channel to server\n     * @private\n     * @returns {Promise<Channel|SessionError>} Channel\n     */\n\n  }, {\n    key: \"addChannel\",\n    value: function () {\n      var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(options) {\n        var attributes, response, channelSid, channelDocument, existingChannel, channel;\n        return _regenerator2.default.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                attributes = void 0;\n\n                if (typeof options.attributes === 'undefined') {\n                  attributes = {};\n                } else {\n                  attributes = options.attributes;\n                }\n\n                if (!(attributes === null)) {\n                  _context.next = 4;\n                  break;\n                }\n\n                throw new Error('Attributes can\\'t be null');\n\n              case 4:\n                if (!(attributes.constructor !== Object)) {\n                  _context.next = 6;\n                  break;\n                }\n\n                throw new Error('Attributes must be a valid JSON object');\n\n              case 6:\n                _context.next = 8;\n                return this.services.session.addCommand('createChannel', {\n                  friendlyName: options.friendlyName,\n                  uniqueName: options.uniqueName,\n                  type: options.isPrivate ? 'private' : 'public',\n                  attributes: (0, _stringify2.default)(attributes)\n                });\n\n              case 8:\n                response = _context.sent;\n                channelSid = 'channelSid' in response ? response['channelSid'] : null;\n                channelDocument = 'channel' in response ? response['channel'] : null;\n                existingChannel = this.channels.get(channelSid);\n\n                if (!existingChannel) {\n                  _context.next = 16;\n                  break;\n                }\n\n                _context.next = 15;\n                return existingChannel._subscribe();\n\n              case 15:\n                return _context.abrupt(\"return\", existingChannel);\n\n              case 16:\n                channel = new channel_1.Channel(this.services, {\n                  channel: channelDocument,\n                  entityName: null,\n                  uniqueName: null,\n                  attributes: null,\n                  createdBy: null,\n                  friendlyName: null,\n                  lastConsumedMessageIndex: null,\n                  type: options.isPrivate ? 'private' : 'public',\n                  dateCreated: null,\n                  dateUpdated: null\n                }, channelSid);\n                this.channels.set(channel.sid, channel);\n                this.registerForEvents(channel);\n                _context.next = 21;\n                return channel._subscribe();\n\n              case 21:\n                this.emit('channelAdded', channel);\n                return _context.abrupt(\"return\", channel);\n\n              case 23:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function addChannel(_x) {\n        return _ref.apply(this, arguments);\n      }\n\n      return addChannel;\n    }()\n    /**\n     * Fetch channels list and instantiate all necessary objects\n     */\n\n  }, {\n    key: \"fetchChannels\",\n    value: function fetchChannels() {\n      var _this3 = this;\n\n      this.getMap().then(function () {\n        var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(map) {\n          var upserts, paginator, items;\n          return _regenerator2.default.wrap(function _callee2$(_context2) {\n            while (1) {\n              switch (_context2.prev = _context2.next) {\n                case 0:\n                  map.on('itemAdded', function (args) {\n                    log.debug('itemAdded: ' + args.item.key);\n\n                    _this3.upsertChannel('sync', args.item.key, args.item.value);\n                  });\n                  map.on('itemRemoved', function (args) {\n                    log.debug('itemRemoved: ' + args.key);\n                    var sid = args.key;\n\n                    if (!_this3.syncListFetched) {\n                      _this3.thumbstones.add(sid);\n                    }\n\n                    var channel = _this3.channels.get(sid);\n\n                    if (channel) {\n                      if (channel.status === 'joined' || channel.status === 'invited') {\n                        channel._setStatus('known', 'sync');\n\n                        _this3.emit('channelLeft', channel);\n                      }\n\n                      if (channel.isPrivate) {\n                        _this3.channels.delete(sid);\n\n                        _this3.emit('channelRemoved', channel);\n\n                        channel.emit('removed', channel);\n                      }\n                    }\n                  });\n                  map.on('itemUpdated', function (args) {\n                    log.debug('itemUpdated: ' + args.item.key);\n\n                    _this3.upsertChannel('sync', args.item.key, args.item.value);\n                  });\n                  upserts = [];\n                  _context2.next = 6;\n                  return _this3.services.syncList.getPage();\n\n                case 6:\n                  paginator = _context2.sent;\n                  items = paginator.items;\n                  items.forEach(function (item) {\n                    upserts.push(_this3.upsertChannel('synclist', item.channel_sid, item));\n                  });\n\n                case 9:\n                  if (!paginator.hasNextPage) {\n                    _context2.next = 16;\n                    break;\n                  }\n\n                  _context2.next = 12;\n                  return paginator.nextPage();\n\n                case 12:\n                  paginator = _context2.sent;\n                  paginator.items.forEach(function (item) {\n                    upserts.push(_this3.upsertChannel('synclist', item.channel_sid, item));\n                  });\n                  _context2.next = 9;\n                  break;\n\n                case 16:\n                  _this3.syncListRead.set(true);\n\n                  return _context2.abrupt(\"return\", _promise2.default.all(upserts));\n\n                case 18:\n                case \"end\":\n                  return _context2.stop();\n              }\n            }\n          }, _callee2, _this3);\n        }));\n\n        return function (_x2) {\n          return _ref2.apply(this, arguments);\n        };\n      }()).then(function () {\n        _this3.syncListFetched = true;\n\n        _this3.thumbstones.clear();\n\n        log.debug('Channels list fetched');\n      }).then(function () {\n        return _this3;\n      }).catch(function (e) {\n        if (_this3.services.syncClient.connectionState != 'disconnected') {\n          log.error('Failed to get channels list', e);\n        }\n\n        log.debug('ERROR: Failed to get channels list', e);\n        throw e;\n      });\n    }\n  }, {\n    key: \"_wrapPaginator\",\n    value: function _wrapPaginator(page, op) {\n      var _this4 = this;\n\n      return op(page.items).then(function (items) {\n        return {\n          items: items,\n          hasNextPage: page.hasNextPage,\n          hasPrevPage: page.hasPrevPage,\n          nextPage: function nextPage() {\n            return page.nextPage().then(function (x) {\n              return _this4._wrapPaginator(x, op);\n            });\n          },\n          prevPage: function prevPage() {\n            return page.prevPage().then(function (x) {\n              return _this4._wrapPaginator(x, op);\n            });\n          }\n        };\n      });\n    }\n  }, {\n    key: \"getChannels\",\n    value: function getChannels(args) {\n      var _this5 = this;\n\n      return this.getMap().then(function (channelsMap) {\n        return channelsMap.getItems(args);\n      }).then(function (page) {\n        return _this5._wrapPaginator(page, function (items) {\n          return _promise2.default.all(items.map(function (item) {\n            return _this5.upsertChannel('sync', item.key, item.value);\n          }));\n        });\n      });\n    }\n  }, {\n    key: \"getChannel\",\n    value: function getChannel(sid) {\n      var _this6 = this;\n\n      return this.getMap().then(function (channelsMap) {\n        return channelsMap.getItems({\n          key: sid\n        });\n      }).then(function (page) {\n        return page.items.map(function (item) {\n          return _this6.upsertChannel('sync', item.key, item.value);\n        });\n      }).then(function (items) {\n        return items.length > 0 ? items[0] : null;\n      });\n    }\n  }, {\n    key: \"pushChannel\",\n    value: function pushChannel(descriptor) {\n      var sid = descriptor.sid;\n      var data = {\n        entityName: null,\n        lastConsumedMessageIndex: descriptor.lastConsumedMessageIndex,\n        type: descriptor.type,\n        status: descriptor.status,\n        friendlyName: descriptor.friendlyName,\n        dateUpdated: descriptor.dateUpdated,\n        dateCreated: descriptor.dateCreated,\n        uniqueName: descriptor.uniqueName,\n        createdBy: descriptor.createdBy,\n        attributes: descriptor.attributes,\n        channel: descriptor.channel,\n        notificationLevel: descriptor.notificationLevel,\n        sid: sid\n      };\n      return this.upsertChannel('chat', sid, data);\n    }\n  }, {\n    key: \"upsertChannel\",\n    value: function upsertChannel(source, sid, data) {\n      var _this7 = this;\n\n      log.trace('upsertChannel(sid=' + sid + ', data=', data);\n      var channel = this.channels.get(sid); // Update the Channel's status if we know about it\n\n      if (channel) {\n        log.trace('upsertChannel: channel ' + sid + ' is known and it\\'s' + ' status is known from source ' + channel._statusSource() + ' and update came from source ' + source, channel);\n\n        if (typeof channel._statusSource() === 'undefined' || source === channel._statusSource() || source === 'synclist' && channel._statusSource() !== 'sync' || source === 'sync') {\n          if (data.status === 'joined' && channel.status !== 'joined') {\n            channel._setStatus('joined', source);\n\n            var updateData = {};\n\n            if (typeof data.notificationLevel !== 'undefined') {\n              updateData.notificationLevel = data.notificationLevel;\n            }\n\n            if (typeof data.lastConsumedMessageIndex !== 'undefined') {\n              updateData.lastConsumedMessageIndex = data.lastConsumedMessageIndex;\n            }\n\n            if (!util_1.isDeepEqual(updateData, {})) {\n              channel._update(updateData);\n            }\n\n            channel._subscribe().then(function () {\n              _this7.emit('channelJoined', channel);\n            });\n          } else if (data.status === 'invited' && channel.status !== 'invited') {\n            channel._setStatus('invited', source);\n\n            var _updateData = {};\n\n            if (typeof data.notificationLevel !== 'undefined') {\n              _updateData.notificationLevel = data.notificationLevel;\n            }\n\n            if (typeof data.lastConsumedMessageIndex !== 'undefined') {\n              _updateData.lastConsumedMessageIndex = data.lastConsumedMessageIndex;\n            }\n\n            if (!util_1.isDeepEqual(_updateData, {})) {\n              channel._update(_updateData);\n            }\n\n            channel._subscribe().then(function () {\n              _this7.emit('channelInvited', channel);\n            });\n          } else if (data.status === 'known' && (channel.status === 'invited' || channel.status === 'joined')) {\n            channel._setStatus('known', source);\n\n            channel._update(data);\n\n            channel._subscribe().then(function () {\n              _this7.emit('channelLeft', channel);\n            });\n          } else if ((data.status === 'notParticipating' || data.status === 'known') && data.type === 'private') {\n            channel._subscribe();\n          } else {\n            channel._update(data);\n          }\n        } else {\n          log.trace('upsertChannel: channel is known from sync and came from chat, ignoring', {\n            sid: sid,\n            data: data.status,\n            channel: channel.status\n          });\n        }\n\n        return channel._subscribe().then(function () {\n          return channel;\n        });\n      }\n\n      if ((source === 'chat' || source === 'synclist') && this.thumbstones.has(sid)) {\n        // if channel was deleted, we ignore it\n        log.trace('upsertChannel: channel is deleted and came again from chat, ignoring', sid);\n        return;\n      } // Fetch the Channel if we don't know about it\n\n\n      log.trace('upsertChannel: creating local channel object with sid ' + sid, data);\n      channel = new channel_1.Channel(this.services, data, sid);\n      this.channels.set(sid, channel);\n      return channel._subscribe().then(function () {\n        _this7.registerForEvents(channel);\n\n        _this7.emit('channelAdded', channel);\n\n        if (data.status === 'joined') {\n          channel._setStatus('joined', source);\n\n          _this7.emit('channelJoined', channel);\n        } else if (data.status === 'invited') {\n          channel._setStatus('invited', source);\n\n          _this7.emit('channelInvited', channel);\n        }\n\n        return channel;\n      });\n    }\n  }, {\n    key: \"onChannelRemoved\",\n    value: function onChannelRemoved(sid) {\n      var channel = this.channels.get(sid);\n\n      if (channel) {\n        this.channels.delete(sid);\n        this.emit('channelRemoved', channel);\n      }\n    }\n  }, {\n    key: \"registerForEvents\",\n    value: function registerForEvents(channel) {\n      var _this8 = this;\n\n      channel.on('removed', function () {\n        return _this8.onChannelRemoved(channel.sid);\n      });\n      channel.on('updated', function (args) {\n        return _this8.emit('channelUpdated', args);\n      });\n      channel.on('memberJoined', this.emit.bind(this, 'memberJoined'));\n      channel.on('memberLeft', this.emit.bind(this, 'memberLeft'));\n      channel.on('memberUpdated', function (args) {\n        return _this8.emit('memberUpdated', args);\n      });\n      channel.on('messageAdded', this.emit.bind(this, 'messageAdded'));\n      channel.on('messageUpdated', function (args) {\n        return _this8.emit('messageUpdated', args);\n      });\n      channel.on('messageRemoved', this.emit.bind(this, 'messageRemoved'));\n      channel.on('typingStarted', this.emit.bind(this, 'typingStarted'));\n      channel.on('typingEnded', this.emit.bind(this, 'typingEnded'));\n    }\n  }]);\n  return Channels;\n}(events_1.EventEmitter);\n\nexports.Channels = Channels;","map":{"version":3,"sources":["/home/ascencion/sebrae_megahack/node_modules/twilio-chat/browser/data/channels.js"],"names":["_promise","require","_promise2","_interopRequireDefault","_regenerator","_regenerator2","_stringify","_stringify2","_asyncToGenerator2","_asyncToGenerator3","_set","_set2","_map","_map2","_getPrototypeOf","_getPrototypeOf2","_classCallCheck2","_classCallCheck3","_createClass2","_createClass3","_possibleConstructorReturn2","_possibleConstructorReturn3","_inherits2","_inherits3","obj","__esModule","default","Object","defineProperty","exports","value","events_1","logger_1","channel_1","Channel","deferred_1","util_1","log","Logger","scope","Channels","_events_1$EventEmitte","services","_this","__proto__","call","channels","thumbstones","syncListFetched","syncListRead","Deferred","key","getMap","_this2","session","getMyChannelsId","then","name","syncClient","map","id","mode","_ref","mark","_callee","options","attributes","response","channelSid","channelDocument","existingChannel","channel","wrap","_callee$","_context","prev","next","Error","constructor","addCommand","friendlyName","uniqueName","type","isPrivate","sent","get","_subscribe","abrupt","entityName","createdBy","lastConsumedMessageIndex","dateCreated","dateUpdated","set","sid","registerForEvents","emit","stop","addChannel","_x","apply","arguments","fetchChannels","_this3","_ref2","_callee2","upserts","paginator","items","_callee2$","_context2","on","args","debug","item","upsertChannel","add","status","_setStatus","delete","syncList","getPage","forEach","push","channel_sid","hasNextPage","nextPage","all","_x2","clear","catch","e","connectionState","error","_wrapPaginator","page","op","_this4","hasPrevPage","x","prevPage","getChannels","_this5","channelsMap","getItems","getChannel","_this6","length","pushChannel","descriptor","data","notificationLevel","source","_this7","trace","_statusSource","updateData","isDeepEqual","_update","_updateData","has","onChannelRemoved","_this8","bind","EventEmitter"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _stringify = require(\"babel-runtime/core-js/json/stringify\");\n\nvar _stringify2 = _interopRequireDefault(_stringify);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _set = require(\"babel-runtime/core-js/set\");\n\nvar _set2 = _interopRequireDefault(_set);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _getPrototypeOf = require(\"babel-runtime/core-js/object/get-prototype-of\");\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _possibleConstructorReturn2 = require(\"babel-runtime/helpers/possibleConstructorReturn\");\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require(\"babel-runtime/helpers/inherits\");\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar events_1 = require(\"events\");\nvar logger_1 = require(\"../logger\");\nvar channel_1 = require(\"../channel\");\nexports.Channel = channel_1.Channel;\nvar deferred_1 = require(\"../util/deferred\");\nvar util_1 = require(\"../util\");\nvar log = logger_1.Logger.scope('Channels');\n/**\n * Represents channels collection\n * {@see Channel}\n */\n\nvar Channels = function (_events_1$EventEmitte) {\n    (0, _inherits3.default)(Channels, _events_1$EventEmitte);\n\n    function Channels(services) {\n        (0, _classCallCheck3.default)(this, Channels);\n\n        var _this = (0, _possibleConstructorReturn3.default)(this, (Channels.__proto__ || (0, _getPrototypeOf2.default)(Channels)).call(this));\n\n        _this.services = services;\n        _this.channels = new _map2.default();\n        _this.thumbstones = new _set2.default();\n        _this.syncListFetched = false;\n        _this.syncListRead = new deferred_1.Deferred();\n        return _this;\n    }\n\n    (0, _createClass3.default)(Channels, [{\n        key: \"getMap\",\n        value: function getMap() {\n            var _this2 = this;\n\n            return this.services.session.getMyChannelsId().then(function (name) {\n                return _this2.services.syncClient.map({ id: name, mode: 'open_existing' });\n            });\n        }\n        /**\n         * Add channel to server\n         * @private\n         * @returns {Promise<Channel|SessionError>} Channel\n         */\n\n    }, {\n        key: \"addChannel\",\n        value: function () {\n            var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(options) {\n                var attributes, response, channelSid, channelDocument, existingChannel, channel;\n                return _regenerator2.default.wrap(function _callee$(_context) {\n                    while (1) {\n                        switch (_context.prev = _context.next) {\n                            case 0:\n                                attributes = void 0;\n\n                                if (typeof options.attributes === 'undefined') {\n                                    attributes = {};\n                                } else {\n                                    attributes = options.attributes;\n                                }\n\n                                if (!(attributes === null)) {\n                                    _context.next = 4;\n                                    break;\n                                }\n\n                                throw new Error('Attributes can\\'t be null');\n\n                            case 4:\n                                if (!(attributes.constructor !== Object)) {\n                                    _context.next = 6;\n                                    break;\n                                }\n\n                                throw new Error('Attributes must be a valid JSON object');\n\n                            case 6:\n                                _context.next = 8;\n                                return this.services.session.addCommand('createChannel', {\n                                    friendlyName: options.friendlyName,\n                                    uniqueName: options.uniqueName,\n                                    type: options.isPrivate ? 'private' : 'public',\n                                    attributes: (0, _stringify2.default)(attributes)\n                                });\n\n                            case 8:\n                                response = _context.sent;\n                                channelSid = 'channelSid' in response ? response['channelSid'] : null;\n                                channelDocument = 'channel' in response ? response['channel'] : null;\n                                existingChannel = this.channels.get(channelSid);\n\n                                if (!existingChannel) {\n                                    _context.next = 16;\n                                    break;\n                                }\n\n                                _context.next = 15;\n                                return existingChannel._subscribe();\n\n                            case 15:\n                                return _context.abrupt(\"return\", existingChannel);\n\n                            case 16:\n                                channel = new channel_1.Channel(this.services, {\n                                    channel: channelDocument,\n                                    entityName: null,\n                                    uniqueName: null,\n                                    attributes: null,\n                                    createdBy: null,\n                                    friendlyName: null,\n                                    lastConsumedMessageIndex: null,\n                                    type: options.isPrivate ? 'private' : 'public',\n                                    dateCreated: null,\n                                    dateUpdated: null\n                                }, channelSid);\n\n                                this.channels.set(channel.sid, channel);\n                                this.registerForEvents(channel);\n                                _context.next = 21;\n                                return channel._subscribe();\n\n                            case 21:\n                                this.emit('channelAdded', channel);\n                                return _context.abrupt(\"return\", channel);\n\n                            case 23:\n                            case \"end\":\n                                return _context.stop();\n                        }\n                    }\n                }, _callee, this);\n            }));\n\n            function addChannel(_x) {\n                return _ref.apply(this, arguments);\n            }\n\n            return addChannel;\n        }()\n        /**\n         * Fetch channels list and instantiate all necessary objects\n         */\n\n    }, {\n        key: \"fetchChannels\",\n        value: function fetchChannels() {\n            var _this3 = this;\n\n            this.getMap().then(function () {\n                var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(map) {\n                    var upserts, paginator, items;\n                    return _regenerator2.default.wrap(function _callee2$(_context2) {\n                        while (1) {\n                            switch (_context2.prev = _context2.next) {\n                                case 0:\n                                    map.on('itemAdded', function (args) {\n                                        log.debug('itemAdded: ' + args.item.key);\n                                        _this3.upsertChannel('sync', args.item.key, args.item.value);\n                                    });\n                                    map.on('itemRemoved', function (args) {\n                                        log.debug('itemRemoved: ' + args.key);\n                                        var sid = args.key;\n                                        if (!_this3.syncListFetched) {\n                                            _this3.thumbstones.add(sid);\n                                        }\n                                        var channel = _this3.channels.get(sid);\n                                        if (channel) {\n                                            if (channel.status === 'joined' || channel.status === 'invited') {\n                                                channel._setStatus('known', 'sync');\n                                                _this3.emit('channelLeft', channel);\n                                            }\n                                            if (channel.isPrivate) {\n                                                _this3.channels.delete(sid);\n                                                _this3.emit('channelRemoved', channel);\n                                                channel.emit('removed', channel);\n                                            }\n                                        }\n                                    });\n                                    map.on('itemUpdated', function (args) {\n                                        log.debug('itemUpdated: ' + args.item.key);\n                                        _this3.upsertChannel('sync', args.item.key, args.item.value);\n                                    });\n                                    upserts = [];\n                                    _context2.next = 6;\n                                    return _this3.services.syncList.getPage();\n\n                                case 6:\n                                    paginator = _context2.sent;\n                                    items = paginator.items;\n\n                                    items.forEach(function (item) {\n                                        upserts.push(_this3.upsertChannel('synclist', item.channel_sid, item));\n                                    });\n\n                                case 9:\n                                    if (!paginator.hasNextPage) {\n                                        _context2.next = 16;\n                                        break;\n                                    }\n\n                                    _context2.next = 12;\n                                    return paginator.nextPage();\n\n                                case 12:\n                                    paginator = _context2.sent;\n\n                                    paginator.items.forEach(function (item) {\n                                        upserts.push(_this3.upsertChannel('synclist', item.channel_sid, item));\n                                    });\n                                    _context2.next = 9;\n                                    break;\n\n                                case 16:\n                                    _this3.syncListRead.set(true);\n                                    return _context2.abrupt(\"return\", _promise2.default.all(upserts));\n\n                                case 18:\n                                case \"end\":\n                                    return _context2.stop();\n                            }\n                        }\n                    }, _callee2, _this3);\n                }));\n\n                return function (_x2) {\n                    return _ref2.apply(this, arguments);\n                };\n            }()).then(function () {\n                _this3.syncListFetched = true;\n                _this3.thumbstones.clear();\n                log.debug('Channels list fetched');\n            }).then(function () {\n                return _this3;\n            }).catch(function (e) {\n                if (_this3.services.syncClient.connectionState != 'disconnected') {\n                    log.error('Failed to get channels list', e);\n                }\n                log.debug('ERROR: Failed to get channels list', e);\n                throw e;\n            });\n        }\n    }, {\n        key: \"_wrapPaginator\",\n        value: function _wrapPaginator(page, op) {\n            var _this4 = this;\n\n            return op(page.items).then(function (items) {\n                return {\n                    items: items,\n                    hasNextPage: page.hasNextPage,\n                    hasPrevPage: page.hasPrevPage,\n                    nextPage: function nextPage() {\n                        return page.nextPage().then(function (x) {\n                            return _this4._wrapPaginator(x, op);\n                        });\n                    },\n                    prevPage: function prevPage() {\n                        return page.prevPage().then(function (x) {\n                            return _this4._wrapPaginator(x, op);\n                        });\n                    }\n                };\n            });\n        }\n    }, {\n        key: \"getChannels\",\n        value: function getChannels(args) {\n            var _this5 = this;\n\n            return this.getMap().then(function (channelsMap) {\n                return channelsMap.getItems(args);\n            }).then(function (page) {\n                return _this5._wrapPaginator(page, function (items) {\n                    return _promise2.default.all(items.map(function (item) {\n                        return _this5.upsertChannel('sync', item.key, item.value);\n                    }));\n                });\n            });\n        }\n    }, {\n        key: \"getChannel\",\n        value: function getChannel(sid) {\n            var _this6 = this;\n\n            return this.getMap().then(function (channelsMap) {\n                return channelsMap.getItems({ key: sid });\n            }).then(function (page) {\n                return page.items.map(function (item) {\n                    return _this6.upsertChannel('sync', item.key, item.value);\n                });\n            }).then(function (items) {\n                return items.length > 0 ? items[0] : null;\n            });\n        }\n    }, {\n        key: \"pushChannel\",\n        value: function pushChannel(descriptor) {\n            var sid = descriptor.sid;\n            var data = {\n                entityName: null,\n                lastConsumedMessageIndex: descriptor.lastConsumedMessageIndex,\n                type: descriptor.type,\n                status: descriptor.status,\n                friendlyName: descriptor.friendlyName,\n                dateUpdated: descriptor.dateUpdated,\n                dateCreated: descriptor.dateCreated,\n                uniqueName: descriptor.uniqueName,\n                createdBy: descriptor.createdBy,\n                attributes: descriptor.attributes,\n                channel: descriptor.channel,\n                notificationLevel: descriptor.notificationLevel,\n                sid: sid\n            };\n            return this.upsertChannel('chat', sid, data);\n        }\n    }, {\n        key: \"upsertChannel\",\n        value: function upsertChannel(source, sid, data) {\n            var _this7 = this;\n\n            log.trace('upsertChannel(sid=' + sid + ', data=', data);\n            var channel = this.channels.get(sid);\n            // Update the Channel's status if we know about it\n            if (channel) {\n                log.trace('upsertChannel: channel ' + sid + ' is known and it\\'s' + ' status is known from source ' + channel._statusSource() + ' and update came from source ' + source, channel);\n                if (typeof channel._statusSource() === 'undefined' || source === channel._statusSource() || source === 'synclist' && channel._statusSource() !== 'sync' || source === 'sync') {\n                    if (data.status === 'joined' && channel.status !== 'joined') {\n                        channel._setStatus('joined', source);\n                        var updateData = {};\n                        if (typeof data.notificationLevel !== 'undefined') {\n                            updateData.notificationLevel = data.notificationLevel;\n                        }\n                        if (typeof data.lastConsumedMessageIndex !== 'undefined') {\n                            updateData.lastConsumedMessageIndex = data.lastConsumedMessageIndex;\n                        }\n                        if (!util_1.isDeepEqual(updateData, {})) {\n                            channel._update(updateData);\n                        }\n                        channel._subscribe().then(function () {\n                            _this7.emit('channelJoined', channel);\n                        });\n                    } else if (data.status === 'invited' && channel.status !== 'invited') {\n                        channel._setStatus('invited', source);\n                        var _updateData = {};\n                        if (typeof data.notificationLevel !== 'undefined') {\n                            _updateData.notificationLevel = data.notificationLevel;\n                        }\n                        if (typeof data.lastConsumedMessageIndex !== 'undefined') {\n                            _updateData.lastConsumedMessageIndex = data.lastConsumedMessageIndex;\n                        }\n                        if (!util_1.isDeepEqual(_updateData, {})) {\n                            channel._update(_updateData);\n                        }\n                        channel._subscribe().then(function () {\n                            _this7.emit('channelInvited', channel);\n                        });\n                    } else if (data.status === 'known' && (channel.status === 'invited' || channel.status === 'joined')) {\n                        channel._setStatus('known', source);\n                        channel._update(data);\n                        channel._subscribe().then(function () {\n                            _this7.emit('channelLeft', channel);\n                        });\n                    } else if ((data.status === 'notParticipating' || data.status === 'known') && data.type === 'private') {\n                        channel._subscribe();\n                    } else {\n                        channel._update(data);\n                    }\n                } else {\n                    log.trace('upsertChannel: channel is known from sync and came from chat, ignoring', {\n                        sid: sid,\n                        data: data.status,\n                        channel: channel.status\n                    });\n                }\n                return channel._subscribe().then(function () {\n                    return channel;\n                });\n            }\n            if ((source === 'chat' || source === 'synclist') && this.thumbstones.has(sid)) {\n                // if channel was deleted, we ignore it\n                log.trace('upsertChannel: channel is deleted and came again from chat, ignoring', sid);\n                return;\n            }\n            // Fetch the Channel if we don't know about it\n            log.trace('upsertChannel: creating local channel object with sid ' + sid, data);\n            channel = new channel_1.Channel(this.services, data, sid);\n            this.channels.set(sid, channel);\n            return channel._subscribe().then(function () {\n                _this7.registerForEvents(channel);\n                _this7.emit('channelAdded', channel);\n                if (data.status === 'joined') {\n                    channel._setStatus('joined', source);\n                    _this7.emit('channelJoined', channel);\n                } else if (data.status === 'invited') {\n                    channel._setStatus('invited', source);\n                    _this7.emit('channelInvited', channel);\n                }\n                return channel;\n            });\n        }\n    }, {\n        key: \"onChannelRemoved\",\n        value: function onChannelRemoved(sid) {\n            var channel = this.channels.get(sid);\n            if (channel) {\n                this.channels.delete(sid);\n                this.emit('channelRemoved', channel);\n            }\n        }\n    }, {\n        key: \"registerForEvents\",\n        value: function registerForEvents(channel) {\n            var _this8 = this;\n\n            channel.on('removed', function () {\n                return _this8.onChannelRemoved(channel.sid);\n            });\n            channel.on('updated', function (args) {\n                return _this8.emit('channelUpdated', args);\n            });\n            channel.on('memberJoined', this.emit.bind(this, 'memberJoined'));\n            channel.on('memberLeft', this.emit.bind(this, 'memberLeft'));\n            channel.on('memberUpdated', function (args) {\n                return _this8.emit('memberUpdated', args);\n            });\n            channel.on('messageAdded', this.emit.bind(this, 'messageAdded'));\n            channel.on('messageUpdated', function (args) {\n                return _this8.emit('messageUpdated', args);\n            });\n            channel.on('messageRemoved', this.emit.bind(this, 'messageRemoved'));\n            channel.on('typingStarted', this.emit.bind(this, 'typingStarted'));\n            channel.on('typingEnded', this.emit.bind(this, 'typingEnded'));\n        }\n    }]);\n    return Channels;\n}(events_1.EventEmitter);\n\nexports.Channels = Channels;"]},"metadata":{},"sourceType":"script"}