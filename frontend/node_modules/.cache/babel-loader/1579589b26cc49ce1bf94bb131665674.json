{"ast":null,"code":"\"use strict\";\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _getPrototypeOf = require(\"babel-runtime/core-js/object/get-prototype-of\");\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _possibleConstructorReturn2 = require(\"babel-runtime/helpers/possibleConstructorReturn\");\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require(\"babel-runtime/helpers/inherits\");\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar events_1 = require(\"events\");\n\nvar user_1 = require(\"../user\");\n\nvar userdescriptors_1 = require(\"./userdescriptors\");\n/**\n * @classdesc Container for known users\n * @fires Users#userUpdated\n */\n\n\nvar Users = function (_events_1$EventEmitte) {\n  (0, _inherits3.default)(Users, _events_1$EventEmitte);\n\n  function Users(services) {\n    (0, _classCallCheck3.default)(this, Users);\n\n    var _this = (0, _possibleConstructorReturn3.default)(this, (Users.__proto__ || (0, _getPrototypeOf2.default)(Users)).call(this));\n\n    _this.services = services;\n    _this.fifoStack = [];\n    _this.fifoStackMaxLength = 100;\n    _this.myself = new user_1.User(null, null, _this.services);\n\n    _this.myself.on('updated', function (args) {\n      return _this.emit('userUpdated', args);\n    });\n\n    _this.myself.on('userSubscribed', function () {\n      return _this.emit('userSubscribed', _this.myself);\n    });\n\n    _this.myself.on('userUnsubscribed', function () {\n      _this.emit('userUnsubscribed', _this.myself);\n\n      _this.myself._ensureFetched();\n    });\n\n    _this.services = services;\n    _this.subscribedUsers = new _map2.default();\n    _this.userDescriptorsPromise = _this.services.session.getSessionLinks().then(function (links) {\n      _this.userDescriptors = new userdescriptors_1.UserDescriptors({\n        users: _this,\n        network: _this.services.network\n      }, links.usersUrl);\n      return _this.userDescriptors;\n    });\n\n    _this.services.session.getMaxUserInfosToSubscribe().then(function (maxUserInfosToSubscribe) {\n      _this.fifoStackMaxLength = maxUserInfosToSubscribe;\n    });\n\n    _this.services.session.getUsersData().then(function (data) {\n      _this.myself.identity = data.identity;\n      _this.myself.entityName = data.user;\n      return _this.myself._ensureFetched();\n    });\n\n    return _this;\n  }\n\n  (0, _createClass3.default)(Users, [{\n    key: \"handleUnsubscribeUser\",\n    value: function handleUnsubscribeUser(user) {\n      if (this.subscribedUsers.has(user.identity)) {\n        this.subscribedUsers.delete(user.identity);\n      }\n\n      var foundItemIndex = -1;\n      var foundItem = this.fifoStack.find(function (item, index) {\n        if (item == user.identity) {\n          foundItemIndex = index;\n          return true;\n        }\n\n        return false;\n      });\n\n      if (foundItem) {\n        this.fifoStack.splice(foundItemIndex, 1);\n      }\n\n      this.emit('userUnsubscribed', user);\n    }\n  }, {\n    key: \"handleSubscribeUser\",\n    value: function handleSubscribeUser(user) {\n      if (this.subscribedUsers.has(user.identity)) {\n        return;\n      }\n\n      if (this.fifoStack.length >= this.fifoStackMaxLength) {\n        this.subscribedUsers.get(this.fifoStack.shift()).unsubscribe();\n      }\n\n      this.fifoStack.push(user.identity);\n      this.subscribedUsers.set(user.identity, user);\n      this.emit('userSubscribed', user);\n    }\n    /**\n     * Gets user, if it's in subscribed list - then return the user object from it,\n     * if not - then subscribes and adds user to the FIFO stack\n     * @returns {Promise<User>} Fully initialized user\n     */\n\n  }, {\n    key: \"getUser\",\n    value: function () {\n      var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(identity) {\n        var _this2 = this;\n\n        var entityName = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n        var user, userDescriptor;\n        return _regenerator2.default.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return this.services.session.getUsersData();\n\n              case 2:\n                _context.next = 4;\n                return this.myself._ensureFetched();\n\n              case 4:\n                if (!(identity == this.myself.identity)) {\n                  _context.next = 6;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", this.myself);\n\n              case 6:\n                user = this.subscribedUsers.get(identity);\n\n                if (user) {\n                  _context.next = 19;\n                  break;\n                }\n\n                if (entityName) {\n                  _context.next = 13;\n                  break;\n                }\n\n                _context.next = 11;\n                return this.getUserDescriptor(identity);\n\n              case 11:\n                userDescriptor = _context.sent;\n                entityName = userDescriptor._getDescriptor().sync_unique_name;\n\n              case 13:\n                user = new user_1.User(identity, entityName, this.services);\n                user.on('updated', function (args) {\n                  return _this2.emit('userUpdated', args);\n                });\n                user.on('userSubscribed', function () {\n                  return _this2.handleSubscribeUser(user);\n                });\n                user.on('userUnsubscribed', function () {\n                  return _this2.handleUnsubscribeUser(user);\n                });\n                _context.next = 19;\n                return user._ensureFetched();\n\n              case 19:\n                return _context.abrupt(\"return\", user);\n\n              case 20:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function getUser(_x2) {\n        return _ref.apply(this, arguments);\n      }\n\n      return getUser;\n    }()\n    /**\n     * @returns {Promise<UserDescriptor>} User descriptor\n     */\n\n  }, {\n    key: \"getUserDescriptor\",\n    value: function () {\n      var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(identity) {\n        return _regenerator2.default.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return this.userDescriptorsPromise;\n\n              case 2:\n                return _context2.abrupt(\"return\", this.userDescriptors.getUserDescriptor(identity));\n\n              case 3:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function getUserDescriptor(_x3) {\n        return _ref2.apply(this, arguments);\n      }\n\n      return getUserDescriptor;\n    }()\n    /**\n     * @returns {Promise<Paginator<UserDescriptor>>} Users descriptors page for given channel sid\n     */\n\n  }, {\n    key: \"getChannelUserDescriptors\",\n    value: function () {\n      var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(channelSid) {\n        return _regenerator2.default.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.next = 2;\n                return this.userDescriptorsPromise;\n\n              case 2:\n                return _context3.abrupt(\"return\", this.userDescriptors.getChannelUserDescriptors(channelSid));\n\n              case 3:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function getChannelUserDescriptors(_x4) {\n        return _ref3.apply(this, arguments);\n      }\n\n      return getChannelUserDescriptors;\n    }()\n    /**\n     * @returns {Promise<Array<User>>} returns list of subscribed User objects {@see User}\n     */\n\n  }, {\n    key: \"getSubscribedUsers\",\n    value: function () {\n      var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee4() {\n        var users;\n        return _regenerator2.default.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                _context4.next = 2;\n                return this.services.session.getUsersData();\n\n              case 2:\n                _context4.next = 4;\n                return this.myself._ensureFetched();\n\n              case 4:\n                users = [this.myself];\n                this.subscribedUsers.forEach(function (user) {\n                  return users.push(user);\n                });\n                return _context4.abrupt(\"return\", users);\n\n              case 7:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function getSubscribedUsers() {\n        return _ref4.apply(this, arguments);\n      }\n\n      return getSubscribedUsers;\n    }()\n  }]);\n  return Users;\n}(events_1.EventEmitter);\n\nexports.Users = Users;","map":{"version":3,"sources":["/home/ascencion/sebrae_megahack/node_modules/twilio-chat/browser/data/users.js"],"names":["_regenerator","require","_regenerator2","_interopRequireDefault","_asyncToGenerator2","_asyncToGenerator3","_map","_map2","_getPrototypeOf","_getPrototypeOf2","_classCallCheck2","_classCallCheck3","_createClass2","_createClass3","_possibleConstructorReturn2","_possibleConstructorReturn3","_inherits2","_inherits3","obj","__esModule","default","Object","defineProperty","exports","value","events_1","user_1","userdescriptors_1","Users","_events_1$EventEmitte","services","_this","__proto__","call","fifoStack","fifoStackMaxLength","myself","User","on","args","emit","_ensureFetched","subscribedUsers","userDescriptorsPromise","session","getSessionLinks","then","links","userDescriptors","UserDescriptors","users","network","usersUrl","getMaxUserInfosToSubscribe","maxUserInfosToSubscribe","getUsersData","data","identity","entityName","user","key","handleUnsubscribeUser","has","delete","foundItemIndex","foundItem","find","item","index","splice","handleSubscribeUser","length","get","shift","unsubscribe","push","set","_ref","mark","_callee","_this2","arguments","undefined","userDescriptor","wrap","_callee$","_context","prev","next","abrupt","getUserDescriptor","sent","_getDescriptor","sync_unique_name","stop","getUser","_x2","apply","_ref2","_callee2","_callee2$","_context2","_x3","_ref3","_callee3","channelSid","_callee3$","_context3","getChannelUserDescriptors","_x4","_ref4","_callee4","_callee4$","_context4","forEach","getSubscribedUsers","EventEmitter"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _getPrototypeOf = require(\"babel-runtime/core-js/object/get-prototype-of\");\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _possibleConstructorReturn2 = require(\"babel-runtime/helpers/possibleConstructorReturn\");\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require(\"babel-runtime/helpers/inherits\");\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar events_1 = require(\"events\");\nvar user_1 = require(\"../user\");\nvar userdescriptors_1 = require(\"./userdescriptors\");\n/**\n * @classdesc Container for known users\n * @fires Users#userUpdated\n */\n\nvar Users = function (_events_1$EventEmitte) {\n    (0, _inherits3.default)(Users, _events_1$EventEmitte);\n\n    function Users(services) {\n        (0, _classCallCheck3.default)(this, Users);\n\n        var _this = (0, _possibleConstructorReturn3.default)(this, (Users.__proto__ || (0, _getPrototypeOf2.default)(Users)).call(this));\n\n        _this.services = services;\n        _this.fifoStack = [];\n        _this.fifoStackMaxLength = 100;\n        _this.myself = new user_1.User(null, null, _this.services);\n        _this.myself.on('updated', function (args) {\n            return _this.emit('userUpdated', args);\n        });\n        _this.myself.on('userSubscribed', function () {\n            return _this.emit('userSubscribed', _this.myself);\n        });\n        _this.myself.on('userUnsubscribed', function () {\n            _this.emit('userUnsubscribed', _this.myself);\n            _this.myself._ensureFetched();\n        });\n        _this.services = services;\n        _this.subscribedUsers = new _map2.default();\n        _this.userDescriptorsPromise = _this.services.session.getSessionLinks().then(function (links) {\n            _this.userDescriptors = new userdescriptors_1.UserDescriptors({\n                users: _this,\n                network: _this.services.network\n            }, links.usersUrl);\n            return _this.userDescriptors;\n        });\n        _this.services.session.getMaxUserInfosToSubscribe().then(function (maxUserInfosToSubscribe) {\n            _this.fifoStackMaxLength = maxUserInfosToSubscribe;\n        });\n        _this.services.session.getUsersData().then(function (data) {\n            _this.myself.identity = data.identity;\n            _this.myself.entityName = data.user;\n            return _this.myself._ensureFetched();\n        });\n        return _this;\n    }\n\n    (0, _createClass3.default)(Users, [{\n        key: \"handleUnsubscribeUser\",\n        value: function handleUnsubscribeUser(user) {\n            if (this.subscribedUsers.has(user.identity)) {\n                this.subscribedUsers.delete(user.identity);\n            }\n            var foundItemIndex = -1;\n            var foundItem = this.fifoStack.find(function (item, index) {\n                if (item == user.identity) {\n                    foundItemIndex = index;\n                    return true;\n                }\n                return false;\n            });\n            if (foundItem) {\n                this.fifoStack.splice(foundItemIndex, 1);\n            }\n            this.emit('userUnsubscribed', user);\n        }\n    }, {\n        key: \"handleSubscribeUser\",\n        value: function handleSubscribeUser(user) {\n            if (this.subscribedUsers.has(user.identity)) {\n                return;\n            }\n            if (this.fifoStack.length >= this.fifoStackMaxLength) {\n                this.subscribedUsers.get(this.fifoStack.shift()).unsubscribe();\n            }\n            this.fifoStack.push(user.identity);\n            this.subscribedUsers.set(user.identity, user);\n            this.emit('userSubscribed', user);\n        }\n        /**\n         * Gets user, if it's in subscribed list - then return the user object from it,\n         * if not - then subscribes and adds user to the FIFO stack\n         * @returns {Promise<User>} Fully initialized user\n         */\n\n    }, {\n        key: \"getUser\",\n        value: function () {\n            var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(identity) {\n                var _this2 = this;\n\n                var entityName = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n                var user, userDescriptor;\n                return _regenerator2.default.wrap(function _callee$(_context) {\n                    while (1) {\n                        switch (_context.prev = _context.next) {\n                            case 0:\n                                _context.next = 2;\n                                return this.services.session.getUsersData();\n\n                            case 2:\n                                _context.next = 4;\n                                return this.myself._ensureFetched();\n\n                            case 4:\n                                if (!(identity == this.myself.identity)) {\n                                    _context.next = 6;\n                                    break;\n                                }\n\n                                return _context.abrupt(\"return\", this.myself);\n\n                            case 6:\n                                user = this.subscribedUsers.get(identity);\n\n                                if (user) {\n                                    _context.next = 19;\n                                    break;\n                                }\n\n                                if (entityName) {\n                                    _context.next = 13;\n                                    break;\n                                }\n\n                                _context.next = 11;\n                                return this.getUserDescriptor(identity);\n\n                            case 11:\n                                userDescriptor = _context.sent;\n\n                                entityName = userDescriptor._getDescriptor().sync_unique_name;\n\n                            case 13:\n                                user = new user_1.User(identity, entityName, this.services);\n                                user.on('updated', function (args) {\n                                    return _this2.emit('userUpdated', args);\n                                });\n                                user.on('userSubscribed', function () {\n                                    return _this2.handleSubscribeUser(user);\n                                });\n                                user.on('userUnsubscribed', function () {\n                                    return _this2.handleUnsubscribeUser(user);\n                                });\n                                _context.next = 19;\n                                return user._ensureFetched();\n\n                            case 19:\n                                return _context.abrupt(\"return\", user);\n\n                            case 20:\n                            case \"end\":\n                                return _context.stop();\n                        }\n                    }\n                }, _callee, this);\n            }));\n\n            function getUser(_x2) {\n                return _ref.apply(this, arguments);\n            }\n\n            return getUser;\n        }()\n        /**\n         * @returns {Promise<UserDescriptor>} User descriptor\n         */\n\n    }, {\n        key: \"getUserDescriptor\",\n        value: function () {\n            var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(identity) {\n                return _regenerator2.default.wrap(function _callee2$(_context2) {\n                    while (1) {\n                        switch (_context2.prev = _context2.next) {\n                            case 0:\n                                _context2.next = 2;\n                                return this.userDescriptorsPromise;\n\n                            case 2:\n                                return _context2.abrupt(\"return\", this.userDescriptors.getUserDescriptor(identity));\n\n                            case 3:\n                            case \"end\":\n                                return _context2.stop();\n                        }\n                    }\n                }, _callee2, this);\n            }));\n\n            function getUserDescriptor(_x3) {\n                return _ref2.apply(this, arguments);\n            }\n\n            return getUserDescriptor;\n        }()\n        /**\n         * @returns {Promise<Paginator<UserDescriptor>>} Users descriptors page for given channel sid\n         */\n\n    }, {\n        key: \"getChannelUserDescriptors\",\n        value: function () {\n            var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(channelSid) {\n                return _regenerator2.default.wrap(function _callee3$(_context3) {\n                    while (1) {\n                        switch (_context3.prev = _context3.next) {\n                            case 0:\n                                _context3.next = 2;\n                                return this.userDescriptorsPromise;\n\n                            case 2:\n                                return _context3.abrupt(\"return\", this.userDescriptors.getChannelUserDescriptors(channelSid));\n\n                            case 3:\n                            case \"end\":\n                                return _context3.stop();\n                        }\n                    }\n                }, _callee3, this);\n            }));\n\n            function getChannelUserDescriptors(_x4) {\n                return _ref3.apply(this, arguments);\n            }\n\n            return getChannelUserDescriptors;\n        }()\n        /**\n         * @returns {Promise<Array<User>>} returns list of subscribed User objects {@see User}\n         */\n\n    }, {\n        key: \"getSubscribedUsers\",\n        value: function () {\n            var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee4() {\n                var users;\n                return _regenerator2.default.wrap(function _callee4$(_context4) {\n                    while (1) {\n                        switch (_context4.prev = _context4.next) {\n                            case 0:\n                                _context4.next = 2;\n                                return this.services.session.getUsersData();\n\n                            case 2:\n                                _context4.next = 4;\n                                return this.myself._ensureFetched();\n\n                            case 4:\n                                users = [this.myself];\n\n                                this.subscribedUsers.forEach(function (user) {\n                                    return users.push(user);\n                                });\n                                return _context4.abrupt(\"return\", users);\n\n                            case 7:\n                            case \"end\":\n                                return _context4.stop();\n                        }\n                    }\n                }, _callee4, this);\n            }));\n\n            function getSubscribedUsers() {\n                return _ref4.apply(this, arguments);\n            }\n\n            return getSubscribedUsers;\n        }()\n    }]);\n    return Users;\n}(events_1.EventEmitter);\n\nexports.Users = Users;"]},"metadata":{},"sourceType":"script"}