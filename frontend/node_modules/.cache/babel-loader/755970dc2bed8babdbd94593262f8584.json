{"ast":null,"code":"\"use strict\";\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar uuid = require(\"uuid\");\n\nvar platform = require(\"platform\");\n\nvar responsecodes_1 = require(\"./interfaces/responsecodes\");\n\nvar logger_1 = require(\"./logger\");\n\nvar sessionerror_1 = require(\"./sessionerror\");\n\nvar deferred_1 = require(\"./util/deferred\");\n\nvar iso8601_duration_1 = require(\"iso8601-duration\");\n\nvar SDK_VERSION = require('./../package.json').version;\n\nvar SESSION_PURPOSE = 'com.twilio.rtd.ipmsg';\nvar log = logger_1.Logger.scope('Session');\n\nvar Command = function Command() {\n  (0, _classCallCheck3.default)(this, Command);\n};\n\nfunction hasAllPropertiesSet(obj, properties) {\n  return !properties.some(function (prop) {\n    return !obj.hasOwnProperty(prop);\n  });\n}\n/**\n *  Constructs the instance of Session\n *\n *  @classdesc Provides the interface to send the command to the server\n *  It is reliable, which means that it tracks the command object state\n *  and waits the answer from the server.\n */\n\n\nvar Session = function () {\n  function Session(services, config) {\n    (0, _classCallCheck3.default)(this, Session);\n    var platformInfo = typeof navigator !== 'undefined' ? platform.parse(navigator.userAgent) : platform;\n    this.services = services;\n    this.config = config;\n    this.sessionInfo = new deferred_1.Deferred();\n    this.currentContext = {};\n    this.pendingCommands = new _map2.default();\n    this.sessionStreamPromise = null;\n    this.endpointPlatform = ['js', SDK_VERSION, platformInfo.os, platformInfo.name, platformInfo.version].join('|');\n  }\n\n  (0, _createClass3.default)(Session, [{\n    key: \"handleContextUpdate\",\n    value: function handleContextUpdate(updatedContext) {\n      log.info('Session context updated');\n      log.debug('new session context:', updatedContext);\n      this.currentContext = updatedContext;\n\n      if (!hasAllPropertiesSet(updatedContext, ['identity', 'userInfo', 'links', 'myChannels', 'channels'])) {\n        return; // not enough data to proceed, wait\n      }\n\n      log.info('new session context accepted');\n      this.sessionInfo.set(updatedContext);\n    }\n  }, {\n    key: \"initialize\",\n    value: function initialize() {\n      var _this = this;\n\n      var context = {\n        type: 'IpMsgSession',\n        apiVersion: '3',\n        endpointPlatform: this.endpointPlatform\n      };\n      this.sessionStreamPromise = this.services.syncClient.list({\n        purpose: SESSION_PURPOSE,\n        context: context\n      }).then(function (list) {\n        log.info('Session created', list.sid);\n        list.on('itemAdded', function (args) {\n          return _this.processCommandResponse(args.item);\n        });\n        list.on('itemUpdated', function (args) {\n          return _this.processCommandResponse(args.item);\n        });\n        list.on('contextUpdated', function (args) {\n          return _this.handleContextUpdate(args.context);\n        });\n        return list;\n      }).catch(function (err) {\n        log.error('Failed to create session', err);\n        throw err;\n      });\n      return this.sessionStreamPromise;\n    }\n    /**\n     * Sends the command to the server\n     * @returns Promise the promise, which is being fulfilled only when service will reply\n     */\n\n  }, {\n    key: \"addCommand\",\n    value: function addCommand(action, params) {\n      return this.processCommand(action, params);\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: \"processCommand\",\n    value: function processCommand(action, params) {\n      var _this2 = this;\n\n      var createSessionIfNotFound = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;\n      var command = new Command();\n      command.request = params;\n      command.request.action = action;\n      command.commandId = uuid.v4();\n      log.info('Adding command: ', action, command.commandId);\n      log.debug('command arguments:', params, createSessionIfNotFound);\n      return new _promise2.default(function (resolve, reject) {\n        _this2.sessionStreamPromise.then(function (list) {\n          _this2.pendingCommands.set(command.commandId, {\n            resolve: resolve,\n            reject: reject,\n            commandId: command.commandId,\n            request: command.request\n          });\n\n          return list.push(command);\n        }).then(function () {\n          return log.debug('Command accepted by server', command.commandId);\n        }).catch(function (err) {\n          _this2.pendingCommands.delete(command.commandId);\n\n          log.error('Failed to add a command to the session', err);\n\n          if ((err.code == responsecodes_1.ResponseCodes.ACCESS_FORBIDDEN_FOR_IDENTITY || err.code === responsecodes_1.ResponseCodes.LIST_NOT_FOUND) && createSessionIfNotFound) {\n            log.info('recreating session...');\n\n            _this2.initialize();\n\n            resolve(_this2.processCommand(action, params, false)); // second attempt\n          } else {\n            reject(new Error('Can\\'t add command: ' + err.message));\n          }\n        });\n      });\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: \"processCommandResponse\",\n    value: function processCommandResponse(entity) {\n      if (entity.value.hasOwnProperty('response') && entity.value.hasOwnProperty('commandId') && this.pendingCommands.has(entity.value.commandId)) {\n        var value = entity.value;\n        var commandId = entity.value.commandId;\n\n        if (value.response.status === responsecodes_1.ResponseCodes.HTTP_200_OK) {\n          log.debug('Command succeeded: ', value);\n          var resolve = this.pendingCommands.get(commandId).resolve;\n          this.pendingCommands.delete(commandId);\n          resolve(value.response);\n        } else {\n          log.error('Command failed: ', value);\n          var reject = this.pendingCommands.get(commandId).reject;\n          this.pendingCommands.delete(commandId);\n          reject(new sessionerror_1.SessionError(value.response.statusText, value.response.status));\n        }\n      }\n    }\n  }, {\n    key: \"getSessionContext\",\n    value: function getSessionContext() {\n      return this.sessionStreamPromise.then(function (stream) {\n        return stream.getContext();\n      });\n    }\n  }, {\n    key: \"getSessionLinks\",\n    value: function () {\n      var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {\n        var info;\n        return _regenerator2.default.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return this.sessionInfo.promise;\n\n              case 2:\n                info = _context.sent;\n                return _context.abrupt(\"return\", {\n                  publicChannelsUrl: this.config.baseUrl + info.links.publicChannelsUrl,\n                  myChannelsUrl: this.config.baseUrl + info.links.myChannelsUrl,\n                  typingUrl: this.config.baseUrl + info.links.typingUrl,\n                  syncListUrl: this.config.baseUrl + info.links.syncListUrl,\n                  usersUrl: this.config.baseUrl + info.links.usersUrl,\n                  mediaServiceUrl: info.links.mediaServiceUrl\n                });\n\n              case 4:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function getSessionLinks() {\n        return _ref.apply(this, arguments);\n      }\n\n      return getSessionLinks;\n    }()\n  }, {\n    key: \"getChannelsId\",\n    value: function () {\n      var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {\n        var info;\n        return _regenerator2.default.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return this.sessionInfo.promise;\n\n              case 2:\n                info = _context2.sent;\n                return _context2.abrupt(\"return\", info.channels);\n\n              case 4:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function getChannelsId() {\n        return _ref2.apply(this, arguments);\n      }\n\n      return getChannelsId;\n    }()\n  }, {\n    key: \"getMyChannelsId\",\n    value: function () {\n      var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3() {\n        var info;\n        return _regenerator2.default.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.next = 2;\n                return this.sessionInfo.promise;\n\n              case 2:\n                info = _context3.sent;\n                return _context3.abrupt(\"return\", info.myChannels);\n\n              case 4:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function getMyChannelsId() {\n        return _ref3.apply(this, arguments);\n      }\n\n      return getMyChannelsId;\n    }()\n  }, {\n    key: \"getMaxUserInfosToSubscribe\",\n    value: function () {\n      var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee4() {\n        var info;\n        return _regenerator2.default.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                _context4.next = 2;\n                return this.sessionInfo.promise;\n\n              case 2:\n                info = _context4.sent;\n                return _context4.abrupt(\"return\", this.config.userInfosToSubscribeOverride || info.userInfosToSubscribe || this.config.userInfosToSubscribeDefault);\n\n              case 4:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function getMaxUserInfosToSubscribe() {\n        return _ref4.apply(this, arguments);\n      }\n\n      return getMaxUserInfosToSubscribe;\n    }()\n  }, {\n    key: \"getUsersData\",\n    value: function getUsersData() {\n      return this.sessionInfo.promise.then(function (info) {\n        return {\n          user: info.userInfo,\n          identity: info.identity\n        };\n      });\n    }\n  }, {\n    key: \"getConsumptionReportInterval\",\n    value: function () {\n      var _ref5 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee5() {\n        var context, consumptionIntervalToUse;\n        return _regenerator2.default.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                _context5.next = 2;\n                return this.getSessionContext();\n\n              case 2:\n                context = _context5.sent;\n                consumptionIntervalToUse = this.config.consumptionReportIntervalOverride || context.consumptionReportInterval || this.config.consumptionReportIntervalDefault;\n                _context5.prev = 4;\n                return _context5.abrupt(\"return\", iso8601_duration_1.toSeconds(iso8601_duration_1.parse(consumptionIntervalToUse)));\n\n              case 8:\n                _context5.prev = 8;\n                _context5.t0 = _context5[\"catch\"](4);\n                log.error('Failed to parse consumption report interval', consumptionIntervalToUse, 'using default value', this.config.consumptionReportIntervalDefault);\n                return _context5.abrupt(\"return\", iso8601_duration_1.toSeconds(iso8601_duration_1.parse(this.config.consumptionReportIntervalDefault)));\n\n              case 12:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this, [[4, 8]]);\n      }));\n\n      function getConsumptionReportInterval() {\n        return _ref5.apply(this, arguments);\n      }\n\n      return getConsumptionReportInterval;\n    }()\n  }, {\n    key: \"getHttpCacheInterval\",\n    value: function () {\n      var _ref6 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee6() {\n        var context, cacheIntervalToUse;\n        return _regenerator2.default.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                _context6.next = 2;\n                return this.getSessionContext();\n\n              case 2:\n                context = _context6.sent;\n                cacheIntervalToUse = this.config.httpCacheIntervalOverride || context.httpCacheInterval || this.config.httpCacheIntervalDefault;\n                _context6.prev = 4;\n                return _context6.abrupt(\"return\", iso8601_duration_1.toSeconds(iso8601_duration_1.parse(cacheIntervalToUse)));\n\n              case 8:\n                _context6.prev = 8;\n                _context6.t0 = _context6[\"catch\"](4);\n                log.error('Failed to parse cache interval', cacheIntervalToUse, 'using default value', this.config.httpCacheIntervalDefault);\n                return _context6.abrupt(\"return\", iso8601_duration_1.toSeconds(iso8601_duration_1.parse(this.config.httpCacheIntervalDefault)));\n\n              case 12:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this, [[4, 8]]);\n      }));\n\n      function getHttpCacheInterval() {\n        return _ref6.apply(this, arguments);\n      }\n\n      return getHttpCacheInterval;\n    }()\n  }, {\n    key: \"identity\",\n    get: function get() {\n      return this.sessionInfo.current.identity;\n    }\n  }, {\n    key: \"reachabilityEnabled\",\n    get: function get() {\n      return this.currentContext.reachabilityEnabled;\n    }\n  }]);\n  return Session;\n}();\n\nexports.Session = Session;","map":{"version":3,"sources":["/home/ascencion/sebrae_megahack/node_modules/twilio-chat/browser/session.js"],"names":["_regenerator","require","_regenerator2","_interopRequireDefault","_asyncToGenerator2","_asyncToGenerator3","_promise","_promise2","_map","_map2","_createClass2","_createClass3","_classCallCheck2","_classCallCheck3","obj","__esModule","default","Object","defineProperty","exports","value","uuid","platform","responsecodes_1","logger_1","sessionerror_1","deferred_1","iso8601_duration_1","SDK_VERSION","version","SESSION_PURPOSE","log","Logger","scope","Command","hasAllPropertiesSet","properties","some","prop","hasOwnProperty","Session","services","config","platformInfo","navigator","parse","userAgent","sessionInfo","Deferred","currentContext","pendingCommands","sessionStreamPromise","endpointPlatform","os","name","join","key","handleContextUpdate","updatedContext","info","debug","set","initialize","_this","context","type","apiVersion","syncClient","list","purpose","then","sid","on","args","processCommandResponse","item","catch","err","error","addCommand","action","params","processCommand","_this2","createSessionIfNotFound","arguments","length","undefined","command","request","commandId","v4","resolve","reject","push","delete","code","ResponseCodes","ACCESS_FORBIDDEN_FOR_IDENTITY","LIST_NOT_FOUND","Error","message","entity","has","response","status","HTTP_200_OK","get","SessionError","statusText","getSessionContext","stream","getContext","_ref","mark","_callee","wrap","_callee$","_context","prev","next","promise","sent","abrupt","publicChannelsUrl","baseUrl","links","myChannelsUrl","typingUrl","syncListUrl","usersUrl","mediaServiceUrl","stop","getSessionLinks","apply","_ref2","_callee2","_callee2$","_context2","channels","getChannelsId","_ref3","_callee3","_callee3$","_context3","myChannels","getMyChannelsId","_ref4","_callee4","_callee4$","_context4","userInfosToSubscribeOverride","userInfosToSubscribe","userInfosToSubscribeDefault","getMaxUserInfosToSubscribe","getUsersData","user","userInfo","identity","_ref5","_callee5","consumptionIntervalToUse","_callee5$","_context5","consumptionReportIntervalOverride","consumptionReportInterval","consumptionReportIntervalDefault","toSeconds","t0","getConsumptionReportInterval","_ref6","_callee6","cacheIntervalToUse","_callee6$","_context6","httpCacheIntervalOverride","httpCacheInterval","httpCacheIntervalDefault","getHttpCacheInterval","current","reachabilityEnabled"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar uuid = require(\"uuid\");\nvar platform = require(\"platform\");\nvar responsecodes_1 = require(\"./interfaces/responsecodes\");\nvar logger_1 = require(\"./logger\");\nvar sessionerror_1 = require(\"./sessionerror\");\nvar deferred_1 = require(\"./util/deferred\");\nvar iso8601_duration_1 = require(\"iso8601-duration\");\nvar SDK_VERSION = require('./../package.json').version;\nvar SESSION_PURPOSE = 'com.twilio.rtd.ipmsg';\nvar log = logger_1.Logger.scope('Session');\n\nvar Command = function Command() {\n    (0, _classCallCheck3.default)(this, Command);\n};\n\nfunction hasAllPropertiesSet(obj, properties) {\n    return !properties.some(function (prop) {\n        return !obj.hasOwnProperty(prop);\n    });\n}\n/**\n *  Constructs the instance of Session\n *\n *  @classdesc Provides the interface to send the command to the server\n *  It is reliable, which means that it tracks the command object state\n *  and waits the answer from the server.\n */\n\nvar Session = function () {\n    function Session(services, config) {\n        (0, _classCallCheck3.default)(this, Session);\n\n        var platformInfo = typeof navigator !== 'undefined' ? platform.parse(navigator.userAgent) : platform;\n        this.services = services;\n        this.config = config;\n        this.sessionInfo = new deferred_1.Deferred();\n        this.currentContext = {};\n        this.pendingCommands = new _map2.default();\n        this.sessionStreamPromise = null;\n        this.endpointPlatform = ['js', SDK_VERSION, platformInfo.os, platformInfo.name, platformInfo.version].join('|');\n    }\n\n    (0, _createClass3.default)(Session, [{\n        key: \"handleContextUpdate\",\n        value: function handleContextUpdate(updatedContext) {\n            log.info('Session context updated');\n            log.debug('new session context:', updatedContext);\n            this.currentContext = updatedContext;\n            if (!hasAllPropertiesSet(updatedContext, ['identity', 'userInfo', 'links', 'myChannels', 'channels'])) {\n                return; // not enough data to proceed, wait\n            }\n            log.info('new session context accepted');\n            this.sessionInfo.set(updatedContext);\n        }\n    }, {\n        key: \"initialize\",\n        value: function initialize() {\n            var _this = this;\n\n            var context = {\n                type: 'IpMsgSession',\n                apiVersion: '3',\n                endpointPlatform: this.endpointPlatform\n            };\n            this.sessionStreamPromise = this.services.syncClient.list({ purpose: SESSION_PURPOSE, context: context }).then(function (list) {\n                log.info('Session created', list.sid);\n                list.on('itemAdded', function (args) {\n                    return _this.processCommandResponse(args.item);\n                });\n                list.on('itemUpdated', function (args) {\n                    return _this.processCommandResponse(args.item);\n                });\n                list.on('contextUpdated', function (args) {\n                    return _this.handleContextUpdate(args.context);\n                });\n                return list;\n            }).catch(function (err) {\n                log.error('Failed to create session', err);\n                throw err;\n            });\n            return this.sessionStreamPromise;\n        }\n        /**\n         * Sends the command to the server\n         * @returns Promise the promise, which is being fulfilled only when service will reply\n         */\n\n    }, {\n        key: \"addCommand\",\n        value: function addCommand(action, params) {\n            return this.processCommand(action, params);\n        }\n        /**\n         * @private\n         */\n\n    }, {\n        key: \"processCommand\",\n        value: function processCommand(action, params) {\n            var _this2 = this;\n\n            var createSessionIfNotFound = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;\n\n            var command = new Command();\n            command.request = params;\n            command.request.action = action;\n            command.commandId = uuid.v4();\n            log.info('Adding command: ', action, command.commandId);\n            log.debug('command arguments:', params, createSessionIfNotFound);\n            return new _promise2.default(function (resolve, reject) {\n                _this2.sessionStreamPromise.then(function (list) {\n                    _this2.pendingCommands.set(command.commandId, { resolve: resolve, reject: reject, commandId: command.commandId, request: command.request });\n                    return list.push(command);\n                }).then(function () {\n                    return log.debug('Command accepted by server', command.commandId);\n                }).catch(function (err) {\n                    _this2.pendingCommands.delete(command.commandId);\n                    log.error('Failed to add a command to the session', err);\n                    if ((err.code == responsecodes_1.ResponseCodes.ACCESS_FORBIDDEN_FOR_IDENTITY || err.code === responsecodes_1.ResponseCodes.LIST_NOT_FOUND) && createSessionIfNotFound) {\n                        log.info('recreating session...');\n                        _this2.initialize();\n                        resolve(_this2.processCommand(action, params, false)); // second attempt\n                    } else {\n                        reject(new Error('Can\\'t add command: ' + err.message));\n                    }\n                });\n            });\n        }\n        /**\n         * @private\n         */\n\n    }, {\n        key: \"processCommandResponse\",\n        value: function processCommandResponse(entity) {\n            if (entity.value.hasOwnProperty('response') && entity.value.hasOwnProperty('commandId') && this.pendingCommands.has(entity.value.commandId)) {\n                var value = entity.value;\n                var commandId = entity.value.commandId;\n                if (value.response.status === responsecodes_1.ResponseCodes.HTTP_200_OK) {\n                    log.debug('Command succeeded: ', value);\n                    var resolve = this.pendingCommands.get(commandId).resolve;\n                    this.pendingCommands.delete(commandId);\n                    resolve(value.response);\n                } else {\n                    log.error('Command failed: ', value);\n                    var reject = this.pendingCommands.get(commandId).reject;\n                    this.pendingCommands.delete(commandId);\n                    reject(new sessionerror_1.SessionError(value.response.statusText, value.response.status));\n                }\n            }\n        }\n    }, {\n        key: \"getSessionContext\",\n        value: function getSessionContext() {\n            return this.sessionStreamPromise.then(function (stream) {\n                return stream.getContext();\n            });\n        }\n    }, {\n        key: \"getSessionLinks\",\n        value: function () {\n            var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {\n                var info;\n                return _regenerator2.default.wrap(function _callee$(_context) {\n                    while (1) {\n                        switch (_context.prev = _context.next) {\n                            case 0:\n                                _context.next = 2;\n                                return this.sessionInfo.promise;\n\n                            case 2:\n                                info = _context.sent;\n                                return _context.abrupt(\"return\", {\n                                    publicChannelsUrl: this.config.baseUrl + info.links.publicChannelsUrl,\n                                    myChannelsUrl: this.config.baseUrl + info.links.myChannelsUrl,\n                                    typingUrl: this.config.baseUrl + info.links.typingUrl,\n                                    syncListUrl: this.config.baseUrl + info.links.syncListUrl,\n                                    usersUrl: this.config.baseUrl + info.links.usersUrl,\n                                    mediaServiceUrl: info.links.mediaServiceUrl\n                                });\n\n                            case 4:\n                            case \"end\":\n                                return _context.stop();\n                        }\n                    }\n                }, _callee, this);\n            }));\n\n            function getSessionLinks() {\n                return _ref.apply(this, arguments);\n            }\n\n            return getSessionLinks;\n        }()\n    }, {\n        key: \"getChannelsId\",\n        value: function () {\n            var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {\n                var info;\n                return _regenerator2.default.wrap(function _callee2$(_context2) {\n                    while (1) {\n                        switch (_context2.prev = _context2.next) {\n                            case 0:\n                                _context2.next = 2;\n                                return this.sessionInfo.promise;\n\n                            case 2:\n                                info = _context2.sent;\n                                return _context2.abrupt(\"return\", info.channels);\n\n                            case 4:\n                            case \"end\":\n                                return _context2.stop();\n                        }\n                    }\n                }, _callee2, this);\n            }));\n\n            function getChannelsId() {\n                return _ref2.apply(this, arguments);\n            }\n\n            return getChannelsId;\n        }()\n    }, {\n        key: \"getMyChannelsId\",\n        value: function () {\n            var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3() {\n                var info;\n                return _regenerator2.default.wrap(function _callee3$(_context3) {\n                    while (1) {\n                        switch (_context3.prev = _context3.next) {\n                            case 0:\n                                _context3.next = 2;\n                                return this.sessionInfo.promise;\n\n                            case 2:\n                                info = _context3.sent;\n                                return _context3.abrupt(\"return\", info.myChannels);\n\n                            case 4:\n                            case \"end\":\n                                return _context3.stop();\n                        }\n                    }\n                }, _callee3, this);\n            }));\n\n            function getMyChannelsId() {\n                return _ref3.apply(this, arguments);\n            }\n\n            return getMyChannelsId;\n        }()\n    }, {\n        key: \"getMaxUserInfosToSubscribe\",\n        value: function () {\n            var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee4() {\n                var info;\n                return _regenerator2.default.wrap(function _callee4$(_context4) {\n                    while (1) {\n                        switch (_context4.prev = _context4.next) {\n                            case 0:\n                                _context4.next = 2;\n                                return this.sessionInfo.promise;\n\n                            case 2:\n                                info = _context4.sent;\n                                return _context4.abrupt(\"return\", this.config.userInfosToSubscribeOverride || info.userInfosToSubscribe || this.config.userInfosToSubscribeDefault);\n\n                            case 4:\n                            case \"end\":\n                                return _context4.stop();\n                        }\n                    }\n                }, _callee4, this);\n            }));\n\n            function getMaxUserInfosToSubscribe() {\n                return _ref4.apply(this, arguments);\n            }\n\n            return getMaxUserInfosToSubscribe;\n        }()\n    }, {\n        key: \"getUsersData\",\n        value: function getUsersData() {\n            return this.sessionInfo.promise.then(function (info) {\n                return {\n                    user: info.userInfo,\n                    identity: info.identity\n                };\n            });\n        }\n    }, {\n        key: \"getConsumptionReportInterval\",\n        value: function () {\n            var _ref5 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee5() {\n                var context, consumptionIntervalToUse;\n                return _regenerator2.default.wrap(function _callee5$(_context5) {\n                    while (1) {\n                        switch (_context5.prev = _context5.next) {\n                            case 0:\n                                _context5.next = 2;\n                                return this.getSessionContext();\n\n                            case 2:\n                                context = _context5.sent;\n                                consumptionIntervalToUse = this.config.consumptionReportIntervalOverride || context.consumptionReportInterval || this.config.consumptionReportIntervalDefault;\n                                _context5.prev = 4;\n                                return _context5.abrupt(\"return\", iso8601_duration_1.toSeconds(iso8601_duration_1.parse(consumptionIntervalToUse)));\n\n                            case 8:\n                                _context5.prev = 8;\n                                _context5.t0 = _context5[\"catch\"](4);\n\n                                log.error('Failed to parse consumption report interval', consumptionIntervalToUse, 'using default value', this.config.consumptionReportIntervalDefault);\n                                return _context5.abrupt(\"return\", iso8601_duration_1.toSeconds(iso8601_duration_1.parse(this.config.consumptionReportIntervalDefault)));\n\n                            case 12:\n                            case \"end\":\n                                return _context5.stop();\n                        }\n                    }\n                }, _callee5, this, [[4, 8]]);\n            }));\n\n            function getConsumptionReportInterval() {\n                return _ref5.apply(this, arguments);\n            }\n\n            return getConsumptionReportInterval;\n        }()\n    }, {\n        key: \"getHttpCacheInterval\",\n        value: function () {\n            var _ref6 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee6() {\n                var context, cacheIntervalToUse;\n                return _regenerator2.default.wrap(function _callee6$(_context6) {\n                    while (1) {\n                        switch (_context6.prev = _context6.next) {\n                            case 0:\n                                _context6.next = 2;\n                                return this.getSessionContext();\n\n                            case 2:\n                                context = _context6.sent;\n                                cacheIntervalToUse = this.config.httpCacheIntervalOverride || context.httpCacheInterval || this.config.httpCacheIntervalDefault;\n                                _context6.prev = 4;\n                                return _context6.abrupt(\"return\", iso8601_duration_1.toSeconds(iso8601_duration_1.parse(cacheIntervalToUse)));\n\n                            case 8:\n                                _context6.prev = 8;\n                                _context6.t0 = _context6[\"catch\"](4);\n\n                                log.error('Failed to parse cache interval', cacheIntervalToUse, 'using default value', this.config.httpCacheIntervalDefault);\n                                return _context6.abrupt(\"return\", iso8601_duration_1.toSeconds(iso8601_duration_1.parse(this.config.httpCacheIntervalDefault)));\n\n                            case 12:\n                            case \"end\":\n                                return _context6.stop();\n                        }\n                    }\n                }, _callee6, this, [[4, 8]]);\n            }));\n\n            function getHttpCacheInterval() {\n                return _ref6.apply(this, arguments);\n            }\n\n            return getHttpCacheInterval;\n        }()\n    }, {\n        key: \"identity\",\n        get: function get() {\n            return this.sessionInfo.current.identity;\n        }\n    }, {\n        key: \"reachabilityEnabled\",\n        get: function get() {\n            return this.currentContext.reachabilityEnabled;\n        }\n    }]);\n    return Session;\n}();\n\nexports.Session = Session;"]},"metadata":{},"sourceType":"script"}