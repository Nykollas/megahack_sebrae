{"ast":null,"code":"\"use strict\";\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar sessionerror_1 = require(\"../sessionerror\");\n\nvar ConsumptionReportRequest = function ConsumptionReportRequest() {\n  (0, _classCallCheck3.default)(this, ConsumptionReportRequest);\n};\n\nvar ConsumptionReportEntry = function ConsumptionReportEntry() {\n  (0, _classCallCheck3.default)(this, ConsumptionReportEntry);\n};\n\nvar ConsumptionHorizonPromise = function ConsumptionHorizonPromise() {\n  (0, _classCallCheck3.default)(this, ConsumptionHorizonPromise);\n};\n/**\n * @classdesc Provides consumption horizon management functionality\n */\n\n\nvar ConsumptionHorizon = function () {\n  function ConsumptionHorizon(services) {\n    (0, _classCallCheck3.default)(this, ConsumptionHorizon);\n    this.services = services;\n    this.consumptionHorizonRequests = new _map2.default();\n    this.consumptionHorizonUpdateTimer = null;\n  }\n\n  (0, _createClass3.default)(ConsumptionHorizon, [{\n    key: \"getReportInterval\",\n    value: function getReportInterval() {\n      return this.services.session.getConsumptionReportInterval().then(function (seconds) {\n        return seconds * 1000;\n      });\n    }\n  }, {\n    key: \"delayedSendConsumptionHorizon\",\n    value: function delayedSendConsumptionHorizon(delay) {\n      var _this = this;\n\n      if (this.consumptionHorizonUpdateTimer !== null) {\n        return;\n      }\n\n      this.sendConsumptionReport(true);\n      this.consumptionHorizonUpdateTimer = setTimeout(function () {\n        _this.sendConsumptionReport(false);\n      }, delay);\n    }\n  }, {\n    key: \"sendConsumptionReport\",\n    value: function sendConsumptionReport(keepTimer) {\n      var _this2 = this;\n\n      var reports = [];\n      var promises = new _map2.default();\n      this.consumptionHorizonRequests.forEach(function (request, channelSid) {\n        reports.push(request.entry);\n        promises.set(channelSid, request.promises);\n      });\n\n      if (reports.length > 0) {\n        this.services.session.addCommand('consumptionReportV2', {\n          report: reports\n        }).then(function (response) {\n          return _this2.processConsumptionReportResponse(response, promises);\n        }).catch(function (err) {\n          return _this2.processConsumptionReportError(err, promises);\n        });\n      }\n\n      if (!keepTimer) {\n        this.consumptionHorizonUpdateTimer = null;\n      }\n\n      this.consumptionHorizonRequests.clear();\n    }\n  }, {\n    key: \"processConsumptionReportResponse\",\n    value: function processConsumptionReportResponse(response, promises) {\n      if (response && response.report && Array.isArray(response.report) && response.report.length > 0) {\n        response.report.forEach(function (entry) {\n          var responseEntry = entry;\n\n          if (promises.has(responseEntry.channelSid)) {\n            var unreadMessagesCount = null;\n\n            if (typeof responseEntry.unreadMessagesCount !== 'undefined' && responseEntry.unreadMessagesCount != null) {\n              unreadMessagesCount = responseEntry.unreadMessagesCount;\n            }\n\n            promises.get(responseEntry.channelSid).forEach(function (promise) {\n              return promise.resolve(unreadMessagesCount);\n            });\n            promises.delete(responseEntry.channelSid);\n          }\n        });\n      }\n\n      this.processConsumptionReportError(new sessionerror_1.SessionError('Error while setting LastConsumedMessageIndex', null), promises);\n    }\n  }, {\n    key: \"processConsumptionReportError\",\n    value: function processConsumptionReportError(err, promises) {\n      promises.forEach(function (channelPromises) {\n        return channelPromises.forEach(function (promise) {\n          return promise.reject(err);\n        });\n      });\n    }\n    /**\n     * Updates consumption horizon value without any checks\n     */\n\n  }, {\n    key: \"updateLastConsumedMessageIndexForChannel\",\n    value: function updateLastConsumedMessageIndexForChannel(channelSid, messageIdx) {\n      var _this3 = this;\n\n      return new _promise2.default(function (resolve, reject) {\n        _this3.addPendingConsumptionHorizonRequest(channelSid, {\n          channelSid: channelSid,\n          messageIdx: messageIdx\n        }, {\n          resolve: resolve,\n          reject: reject\n        });\n\n        _this3.getReportInterval().then(function (delay) {\n          return _this3.delayedSendConsumptionHorizon(delay);\n        });\n      });\n    }\n    /**\n     * Move consumption horizon forward\n     */\n\n  }, {\n    key: \"advanceLastConsumedMessageIndexForChannel\",\n    value: function advanceLastConsumedMessageIndexForChannel(channelSid, messageIdx, currentChannelLastConsumedIndex) {\n      var _this4 = this;\n\n      var currentHorizon = this.consumptionHorizonRequests.get(channelSid);\n      return new _promise2.default(function (resolve, reject) {\n        if (currentHorizon && currentHorizon.entry) {\n          if (currentHorizon.entry.messageIdx >= messageIdx) {\n            _this4.addPendingConsumptionHorizonRequest(channelSid, currentHorizon.entry, {\n              resolve: resolve,\n              reject: reject\n            });\n          } else {\n            _this4.addPendingConsumptionHorizonRequest(channelSid, {\n              channelSid: channelSid,\n              messageIdx: messageIdx\n            }, {\n              resolve: resolve,\n              reject: reject\n            });\n          }\n        } else {\n          if (currentChannelLastConsumedIndex !== null && messageIdx < currentChannelLastConsumedIndex) {\n            _this4.addPendingConsumptionHorizonRequest(channelSid, {\n              channelSid: channelSid,\n              messageIdx: currentChannelLastConsumedIndex\n            }, {\n              resolve: resolve,\n              reject: reject\n            });\n          } else {\n            _this4.addPendingConsumptionHorizonRequest(channelSid, {\n              channelSid: channelSid,\n              messageIdx: messageIdx\n            }, {\n              resolve: resolve,\n              reject: reject\n            });\n          }\n        }\n\n        _this4.getReportInterval().then(function (delay) {\n          return _this4.delayedSendConsumptionHorizon(delay);\n        });\n      });\n    }\n  }, {\n    key: \"addPendingConsumptionHorizonRequest\",\n    value: function addPendingConsumptionHorizonRequest(channelSid, entry, promise) {\n      if (this.consumptionHorizonRequests.has(channelSid)) {\n        var request = this.consumptionHorizonRequests.get(channelSid);\n        request.entry = entry;\n        request.promises.push(promise);\n      } else {\n        this.consumptionHorizonRequests.set(channelSid, {\n          entry: entry,\n          promises: [promise]\n        });\n      }\n    }\n  }]);\n  return ConsumptionHorizon;\n}();\n\nexports.ConsumptionHorizon = ConsumptionHorizon;","map":{"version":3,"sources":["/home/ascencion/sebrae_megahack/node_modules/twilio-chat/browser/services/consumptionhorizon.js"],"names":["_promise","require","_promise2","_interopRequireDefault","_map","_map2","_createClass2","_createClass3","_classCallCheck2","_classCallCheck3","obj","__esModule","default","Object","defineProperty","exports","value","sessionerror_1","ConsumptionReportRequest","ConsumptionReportEntry","ConsumptionHorizonPromise","ConsumptionHorizon","services","consumptionHorizonRequests","consumptionHorizonUpdateTimer","key","getReportInterval","session","getConsumptionReportInterval","then","seconds","delayedSendConsumptionHorizon","delay","_this","sendConsumptionReport","setTimeout","keepTimer","_this2","reports","promises","forEach","request","channelSid","push","entry","set","length","addCommand","report","response","processConsumptionReportResponse","catch","err","processConsumptionReportError","clear","Array","isArray","responseEntry","has","unreadMessagesCount","get","promise","resolve","delete","SessionError","channelPromises","reject","updateLastConsumedMessageIndexForChannel","messageIdx","_this3","addPendingConsumptionHorizonRequest","advanceLastConsumedMessageIndexForChannel","currentChannelLastConsumedIndex","_this4","currentHorizon"],"mappings":"AAAA;;AAEA,IAAIA,QAAQ,GAAGC,OAAO,CAAC,+BAAD,CAAtB;;AAEA,IAAIC,SAAS,GAAGC,sBAAsB,CAACH,QAAD,CAAtC;;AAEA,IAAII,IAAI,GAAGH,OAAO,CAAC,2BAAD,CAAlB;;AAEA,IAAII,KAAK,GAAGF,sBAAsB,CAACC,IAAD,CAAlC;;AAEA,IAAIE,aAAa,GAAGL,OAAO,CAAC,mCAAD,CAA3B;;AAEA,IAAIM,aAAa,GAAGJ,sBAAsB,CAACG,aAAD,CAA1C;;AAEA,IAAIE,gBAAgB,GAAGP,OAAO,CAAC,sCAAD,CAA9B;;AAEA,IAAIQ,gBAAgB,GAAGN,sBAAsB,CAACK,gBAAD,CAA7C;;AAEA,SAASL,sBAAT,CAAgCO,GAAhC,EAAqC;AAAE,SAAOA,GAAG,IAAIA,GAAG,CAACC,UAAX,GAAwBD,GAAxB,GAA8B;AAAEE,IAAAA,OAAO,EAAEF;AAAX,GAArC;AAAwD;;AAE/FG,MAAM,CAACC,cAAP,CAAsBC,OAAtB,EAA+B,YAA/B,EAA6C;AAAEC,EAAAA,KAAK,EAAE;AAAT,CAA7C;;AACA,IAAIC,cAAc,GAAGhB,OAAO,CAAC,iBAAD,CAA5B;;AAEA,IAAIiB,wBAAwB,GAAG,SAASA,wBAAT,GAAoC;AAC/D,GAAC,GAAGT,gBAAgB,CAACG,OAArB,EAA8B,IAA9B,EAAoCM,wBAApC;AACH,CAFD;;AAIA,IAAIC,sBAAsB,GAAG,SAASA,sBAAT,GAAkC;AAC3D,GAAC,GAAGV,gBAAgB,CAACG,OAArB,EAA8B,IAA9B,EAAoCO,sBAApC;AACH,CAFD;;AAIA,IAAIC,yBAAyB,GAAG,SAASA,yBAAT,GAAqC;AACjE,GAAC,GAAGX,gBAAgB,CAACG,OAArB,EAA8B,IAA9B,EAAoCQ,yBAApC;AACH,CAFD;AAGA;;;;;AAKA,IAAIC,kBAAkB,GAAG,YAAY;AACjC,WAASA,kBAAT,CAA4BC,QAA5B,EAAsC;AAClC,KAAC,GAAGb,gBAAgB,CAACG,OAArB,EAA8B,IAA9B,EAAoCS,kBAApC;AAEA,SAAKC,QAAL,GAAgBA,QAAhB;AACA,SAAKC,0BAAL,GAAkC,IAAIlB,KAAK,CAACO,OAAV,EAAlC;AACA,SAAKY,6BAAL,GAAqC,IAArC;AACH;;AAED,GAAC,GAAGjB,aAAa,CAACK,OAAlB,EAA2BS,kBAA3B,EAA+C,CAAC;AAC5CI,IAAAA,GAAG,EAAE,mBADuC;AAE5CT,IAAAA,KAAK,EAAE,SAASU,iBAAT,GAA6B;AAChC,aAAO,KAAKJ,QAAL,CAAcK,OAAd,CAAsBC,4BAAtB,GAAqDC,IAArD,CAA0D,UAAUC,OAAV,EAAmB;AAChF,eAAOA,OAAO,GAAG,IAAjB;AACH,OAFM,CAAP;AAGH;AAN2C,GAAD,EAO5C;AACCL,IAAAA,GAAG,EAAE,+BADN;AAECT,IAAAA,KAAK,EAAE,SAASe,6BAAT,CAAuCC,KAAvC,EAA8C;AACjD,UAAIC,KAAK,GAAG,IAAZ;;AAEA,UAAI,KAAKT,6BAAL,KAAuC,IAA3C,EAAiD;AAC7C;AACH;;AACD,WAAKU,qBAAL,CAA2B,IAA3B;AACA,WAAKV,6BAAL,GAAqCW,UAAU,CAAC,YAAY;AACxDF,QAAAA,KAAK,CAACC,qBAAN,CAA4B,KAA5B;AACH,OAF8C,EAE5CF,KAF4C,CAA/C;AAGH;AAZF,GAP4C,EAoB5C;AACCP,IAAAA,GAAG,EAAE,uBADN;AAECT,IAAAA,KAAK,EAAE,SAASkB,qBAAT,CAA+BE,SAA/B,EAA0C;AAC7C,UAAIC,MAAM,GAAG,IAAb;;AAEA,UAAIC,OAAO,GAAG,EAAd;AACA,UAAIC,QAAQ,GAAG,IAAIlC,KAAK,CAACO,OAAV,EAAf;AACA,WAAKW,0BAAL,CAAgCiB,OAAhC,CAAwC,UAAUC,OAAV,EAAmBC,UAAnB,EAA+B;AACnEJ,QAAAA,OAAO,CAACK,IAAR,CAAaF,OAAO,CAACG,KAArB;AACAL,QAAAA,QAAQ,CAACM,GAAT,CAAaH,UAAb,EAAyBD,OAAO,CAACF,QAAjC;AACH,OAHD;;AAIA,UAAID,OAAO,CAACQ,MAAR,GAAiB,CAArB,EAAwB;AACpB,aAAKxB,QAAL,CAAcK,OAAd,CAAsBoB,UAAtB,CAAiC,qBAAjC,EAAwD;AAAEC,UAAAA,MAAM,EAAEV;AAAV,SAAxD,EAA6ET,IAA7E,CAAkF,UAAUoB,QAAV,EAAoB;AAClG,iBAAOZ,MAAM,CAACa,gCAAP,CAAwCD,QAAxC,EAAkDV,QAAlD,CAAP;AACH,SAFD,EAEGY,KAFH,CAES,UAAUC,GAAV,EAAe;AACpB,iBAAOf,MAAM,CAACgB,6BAAP,CAAqCD,GAArC,EAA0Cb,QAA1C,CAAP;AACH,SAJD;AAKH;;AACD,UAAI,CAACH,SAAL,EAAgB;AACZ,aAAKZ,6BAAL,GAAqC,IAArC;AACH;;AACD,WAAKD,0BAAL,CAAgC+B,KAAhC;AACH;AAtBF,GApB4C,EA2C5C;AACC7B,IAAAA,GAAG,EAAE,kCADN;AAECT,IAAAA,KAAK,EAAE,SAASkC,gCAAT,CAA0CD,QAA1C,EAAoDV,QAApD,EAA8D;AACjE,UAAIU,QAAQ,IAAIA,QAAQ,CAACD,MAArB,IAA+BO,KAAK,CAACC,OAAN,CAAcP,QAAQ,CAACD,MAAvB,CAA/B,IAAiEC,QAAQ,CAACD,MAAT,CAAgBF,MAAhB,GAAyB,CAA9F,EAAiG;AAC7FG,QAAAA,QAAQ,CAACD,MAAT,CAAgBR,OAAhB,CAAwB,UAAUI,KAAV,EAAiB;AACrC,cAAIa,aAAa,GAAGb,KAApB;;AACA,cAAIL,QAAQ,CAACmB,GAAT,CAAaD,aAAa,CAACf,UAA3B,CAAJ,EAA4C;AACxC,gBAAIiB,mBAAmB,GAAG,IAA1B;;AACA,gBAAI,OAAOF,aAAa,CAACE,mBAArB,KAA6C,WAA7C,IAA4DF,aAAa,CAACE,mBAAd,IAAqC,IAArG,EAA2G;AACvGA,cAAAA,mBAAmB,GAAGF,aAAa,CAACE,mBAApC;AACH;;AACDpB,YAAAA,QAAQ,CAACqB,GAAT,CAAaH,aAAa,CAACf,UAA3B,EAAuCF,OAAvC,CAA+C,UAAUqB,OAAV,EAAmB;AAC9D,qBAAOA,OAAO,CAACC,OAAR,CAAgBH,mBAAhB,CAAP;AACH,aAFD;AAGApB,YAAAA,QAAQ,CAACwB,MAAT,CAAgBN,aAAa,CAACf,UAA9B;AACH;AACJ,SAZD;AAaH;;AACD,WAAKW,6BAAL,CAAmC,IAAIpC,cAAc,CAAC+C,YAAnB,CAAgC,8CAAhC,EAAgF,IAAhF,CAAnC,EAA0HzB,QAA1H;AACH;AAnBF,GA3C4C,EA+D5C;AACCd,IAAAA,GAAG,EAAE,+BADN;AAECT,IAAAA,KAAK,EAAE,SAASqC,6BAAT,CAAuCD,GAAvC,EAA4Cb,QAA5C,EAAsD;AACzDA,MAAAA,QAAQ,CAACC,OAAT,CAAiB,UAAUyB,eAAV,EAA2B;AACxC,eAAOA,eAAe,CAACzB,OAAhB,CAAwB,UAAUqB,OAAV,EAAmB;AAC9C,iBAAOA,OAAO,CAACK,MAAR,CAAed,GAAf,CAAP;AACH,SAFM,CAAP;AAGH,OAJD;AAKH;AACD;;;;AATD,GA/D4C,EA4E5C;AACC3B,IAAAA,GAAG,EAAE,0CADN;AAECT,IAAAA,KAAK,EAAE,SAASmD,wCAAT,CAAkDzB,UAAlD,EAA8D0B,UAA9D,EAA0E;AAC7E,UAAIC,MAAM,GAAG,IAAb;;AAEA,aAAO,IAAInE,SAAS,CAACU,OAAd,CAAsB,UAAUkD,OAAV,EAAmBI,MAAnB,EAA2B;AACpDG,QAAAA,MAAM,CAACC,mCAAP,CAA2C5B,UAA3C,EAAuD;AAAEA,UAAAA,UAAU,EAAEA,UAAd;AAA0B0B,UAAAA,UAAU,EAAEA;AAAtC,SAAvD,EAA2G;AAAEN,UAAAA,OAAO,EAAEA,OAAX;AAAoBI,UAAAA,MAAM,EAAEA;AAA5B,SAA3G;;AACAG,QAAAA,MAAM,CAAC3C,iBAAP,GAA2BG,IAA3B,CAAgC,UAAUG,KAAV,EAAiB;AAC7C,iBAAOqC,MAAM,CAACtC,6BAAP,CAAqCC,KAArC,CAAP;AACH,SAFD;AAGH,OALM,CAAP;AAMH;AACD;;;;AAZD,GA5E4C,EA4F5C;AACCP,IAAAA,GAAG,EAAE,2CADN;AAECT,IAAAA,KAAK,EAAE,SAASuD,yCAAT,CAAmD7B,UAAnD,EAA+D0B,UAA/D,EAA2EI,+BAA3E,EAA4G;AAC/G,UAAIC,MAAM,GAAG,IAAb;;AAEA,UAAIC,cAAc,GAAG,KAAKnD,0BAAL,CAAgCqC,GAAhC,CAAoClB,UAApC,CAArB;AACA,aAAO,IAAIxC,SAAS,CAACU,OAAd,CAAsB,UAAUkD,OAAV,EAAmBI,MAAnB,EAA2B;AACpD,YAAIQ,cAAc,IAAIA,cAAc,CAAC9B,KAArC,EAA4C;AACxC,cAAI8B,cAAc,CAAC9B,KAAf,CAAqBwB,UAArB,IAAmCA,UAAvC,EAAmD;AAC/CK,YAAAA,MAAM,CAACH,mCAAP,CAA2C5B,UAA3C,EAAuDgC,cAAc,CAAC9B,KAAtE,EAA6E;AAAEkB,cAAAA,OAAO,EAAEA,OAAX;AAAoBI,cAAAA,MAAM,EAAEA;AAA5B,aAA7E;AACH,WAFD,MAEO;AACHO,YAAAA,MAAM,CAACH,mCAAP,CAA2C5B,UAA3C,EAAuD;AAAEA,cAAAA,UAAU,EAAEA,UAAd;AAA0B0B,cAAAA,UAAU,EAAEA;AAAtC,aAAvD,EAA2G;AAAEN,cAAAA,OAAO,EAAEA,OAAX;AAAoBI,cAAAA,MAAM,EAAEA;AAA5B,aAA3G;AACH;AACJ,SAND,MAMO;AACH,cAAIM,+BAA+B,KAAK,IAApC,IAA4CJ,UAAU,GAAGI,+BAA7D,EAA8F;AAC1FC,YAAAA,MAAM,CAACH,mCAAP,CAA2C5B,UAA3C,EAAuD;AAAEA,cAAAA,UAAU,EAAEA,UAAd;AAA0B0B,cAAAA,UAAU,EAAEI;AAAtC,aAAvD,EAAgI;AAAEV,cAAAA,OAAO,EAAEA,OAAX;AAAoBI,cAAAA,MAAM,EAAEA;AAA5B,aAAhI;AACH,WAFD,MAEO;AACHO,YAAAA,MAAM,CAACH,mCAAP,CAA2C5B,UAA3C,EAAuD;AAAEA,cAAAA,UAAU,EAAEA,UAAd;AAA0B0B,cAAAA,UAAU,EAAEA;AAAtC,aAAvD,EAA2G;AAAEN,cAAAA,OAAO,EAAEA,OAAX;AAAoBI,cAAAA,MAAM,EAAEA;AAA5B,aAA3G;AACH;AACJ;;AACDO,QAAAA,MAAM,CAAC/C,iBAAP,GAA2BG,IAA3B,CAAgC,UAAUG,KAAV,EAAiB;AAC7C,iBAAOyC,MAAM,CAAC1C,6BAAP,CAAqCC,KAArC,CAAP;AACH,SAFD;AAGH,OAjBM,CAAP;AAkBH;AAxBF,GA5F4C,EAqH5C;AACCP,IAAAA,GAAG,EAAE,qCADN;AAECT,IAAAA,KAAK,EAAE,SAASsD,mCAAT,CAA6C5B,UAA7C,EAAyDE,KAAzD,EAAgEiB,OAAhE,EAAyE;AAC5E,UAAI,KAAKtC,0BAAL,CAAgCmC,GAAhC,CAAoChB,UAApC,CAAJ,EAAqD;AACjD,YAAID,OAAO,GAAG,KAAKlB,0BAAL,CAAgCqC,GAAhC,CAAoClB,UAApC,CAAd;AACAD,QAAAA,OAAO,CAACG,KAAR,GAAgBA,KAAhB;AACAH,QAAAA,OAAO,CAACF,QAAR,CAAiBI,IAAjB,CAAsBkB,OAAtB;AACH,OAJD,MAIO;AACH,aAAKtC,0BAAL,CAAgCsB,GAAhC,CAAoCH,UAApC,EAAgD;AAAEE,UAAAA,KAAK,EAAEA,KAAT;AAAgBL,UAAAA,QAAQ,EAAE,CAACsB,OAAD;AAA1B,SAAhD;AACH;AACJ;AAVF,GArH4C,CAA/C;AAiIA,SAAOxC,kBAAP;AACH,CA3IwB,EAAzB;;AA6IAN,OAAO,CAACM,kBAAR,GAA6BA,kBAA7B","sourcesContent":["\"use strict\";\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar sessionerror_1 = require(\"../sessionerror\");\n\nvar ConsumptionReportRequest = function ConsumptionReportRequest() {\n    (0, _classCallCheck3.default)(this, ConsumptionReportRequest);\n};\n\nvar ConsumptionReportEntry = function ConsumptionReportEntry() {\n    (0, _classCallCheck3.default)(this, ConsumptionReportEntry);\n};\n\nvar ConsumptionHorizonPromise = function ConsumptionHorizonPromise() {\n    (0, _classCallCheck3.default)(this, ConsumptionHorizonPromise);\n};\n/**\n * @classdesc Provides consumption horizon management functionality\n */\n\n\nvar ConsumptionHorizon = function () {\n    function ConsumptionHorizon(services) {\n        (0, _classCallCheck3.default)(this, ConsumptionHorizon);\n\n        this.services = services;\n        this.consumptionHorizonRequests = new _map2.default();\n        this.consumptionHorizonUpdateTimer = null;\n    }\n\n    (0, _createClass3.default)(ConsumptionHorizon, [{\n        key: \"getReportInterval\",\n        value: function getReportInterval() {\n            return this.services.session.getConsumptionReportInterval().then(function (seconds) {\n                return seconds * 1000;\n            });\n        }\n    }, {\n        key: \"delayedSendConsumptionHorizon\",\n        value: function delayedSendConsumptionHorizon(delay) {\n            var _this = this;\n\n            if (this.consumptionHorizonUpdateTimer !== null) {\n                return;\n            }\n            this.sendConsumptionReport(true);\n            this.consumptionHorizonUpdateTimer = setTimeout(function () {\n                _this.sendConsumptionReport(false);\n            }, delay);\n        }\n    }, {\n        key: \"sendConsumptionReport\",\n        value: function sendConsumptionReport(keepTimer) {\n            var _this2 = this;\n\n            var reports = [];\n            var promises = new _map2.default();\n            this.consumptionHorizonRequests.forEach(function (request, channelSid) {\n                reports.push(request.entry);\n                promises.set(channelSid, request.promises);\n            });\n            if (reports.length > 0) {\n                this.services.session.addCommand('consumptionReportV2', { report: reports }).then(function (response) {\n                    return _this2.processConsumptionReportResponse(response, promises);\n                }).catch(function (err) {\n                    return _this2.processConsumptionReportError(err, promises);\n                });\n            }\n            if (!keepTimer) {\n                this.consumptionHorizonUpdateTimer = null;\n            }\n            this.consumptionHorizonRequests.clear();\n        }\n    }, {\n        key: \"processConsumptionReportResponse\",\n        value: function processConsumptionReportResponse(response, promises) {\n            if (response && response.report && Array.isArray(response.report) && response.report.length > 0) {\n                response.report.forEach(function (entry) {\n                    var responseEntry = entry;\n                    if (promises.has(responseEntry.channelSid)) {\n                        var unreadMessagesCount = null;\n                        if (typeof responseEntry.unreadMessagesCount !== 'undefined' && responseEntry.unreadMessagesCount != null) {\n                            unreadMessagesCount = responseEntry.unreadMessagesCount;\n                        }\n                        promises.get(responseEntry.channelSid).forEach(function (promise) {\n                            return promise.resolve(unreadMessagesCount);\n                        });\n                        promises.delete(responseEntry.channelSid);\n                    }\n                });\n            }\n            this.processConsumptionReportError(new sessionerror_1.SessionError('Error while setting LastConsumedMessageIndex', null), promises);\n        }\n    }, {\n        key: \"processConsumptionReportError\",\n        value: function processConsumptionReportError(err, promises) {\n            promises.forEach(function (channelPromises) {\n                return channelPromises.forEach(function (promise) {\n                    return promise.reject(err);\n                });\n            });\n        }\n        /**\n         * Updates consumption horizon value without any checks\n         */\n\n    }, {\n        key: \"updateLastConsumedMessageIndexForChannel\",\n        value: function updateLastConsumedMessageIndexForChannel(channelSid, messageIdx) {\n            var _this3 = this;\n\n            return new _promise2.default(function (resolve, reject) {\n                _this3.addPendingConsumptionHorizonRequest(channelSid, { channelSid: channelSid, messageIdx: messageIdx }, { resolve: resolve, reject: reject });\n                _this3.getReportInterval().then(function (delay) {\n                    return _this3.delayedSendConsumptionHorizon(delay);\n                });\n            });\n        }\n        /**\n         * Move consumption horizon forward\n         */\n\n    }, {\n        key: \"advanceLastConsumedMessageIndexForChannel\",\n        value: function advanceLastConsumedMessageIndexForChannel(channelSid, messageIdx, currentChannelLastConsumedIndex) {\n            var _this4 = this;\n\n            var currentHorizon = this.consumptionHorizonRequests.get(channelSid);\n            return new _promise2.default(function (resolve, reject) {\n                if (currentHorizon && currentHorizon.entry) {\n                    if (currentHorizon.entry.messageIdx >= messageIdx) {\n                        _this4.addPendingConsumptionHorizonRequest(channelSid, currentHorizon.entry, { resolve: resolve, reject: reject });\n                    } else {\n                        _this4.addPendingConsumptionHorizonRequest(channelSid, { channelSid: channelSid, messageIdx: messageIdx }, { resolve: resolve, reject: reject });\n                    }\n                } else {\n                    if (currentChannelLastConsumedIndex !== null && messageIdx < currentChannelLastConsumedIndex) {\n                        _this4.addPendingConsumptionHorizonRequest(channelSid, { channelSid: channelSid, messageIdx: currentChannelLastConsumedIndex }, { resolve: resolve, reject: reject });\n                    } else {\n                        _this4.addPendingConsumptionHorizonRequest(channelSid, { channelSid: channelSid, messageIdx: messageIdx }, { resolve: resolve, reject: reject });\n                    }\n                }\n                _this4.getReportInterval().then(function (delay) {\n                    return _this4.delayedSendConsumptionHorizon(delay);\n                });\n            });\n        }\n    }, {\n        key: \"addPendingConsumptionHorizonRequest\",\n        value: function addPendingConsumptionHorizonRequest(channelSid, entry, promise) {\n            if (this.consumptionHorizonRequests.has(channelSid)) {\n                var request = this.consumptionHorizonRequests.get(channelSid);\n                request.entry = entry;\n                request.promises.push(promise);\n            } else {\n                this.consumptionHorizonRequests.set(channelSid, { entry: entry, promises: [promise] });\n            }\n        }\n    }]);\n    return ConsumptionHorizon;\n}();\n\nexports.ConsumptionHorizon = ConsumptionHorizon;"]},"metadata":{},"sourceType":"script"}