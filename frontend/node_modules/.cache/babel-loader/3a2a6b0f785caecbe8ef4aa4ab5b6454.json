{"ast":null,"code":"\"use strict\";\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _getIterator2 = require(\"babel-runtime/core-js/get-iterator\");\n\nvar _getIterator3 = _interopRequireDefault(_getIterator2);\n\nvar _slicedToArray2 = require(\"babel-runtime/helpers/slicedToArray\");\n\nvar _slicedToArray3 = _interopRequireDefault(_slicedToArray2);\n\nvar _assign = require(\"babel-runtime/core-js/object/assign\");\n\nvar _assign2 = _interopRequireDefault(_assign);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar operation_retrier_1 = require(\"operation-retrier\");\n\nvar Network = function () {\n  function Network(config, services) {\n    var _this = this;\n\n    (0, _classCallCheck3.default)(this, Network);\n    this.config = config;\n    this.services = services;\n    this.cache = new _map2.default();\n    this.cacheLifetime = 0;\n    this.services.session.getHttpCacheInterval().then(function (seconds) {\n      _this.cacheLifetime = seconds * 1000;\n\n      _this.cleanupCache();\n    });\n  }\n\n  (0, _createClass3.default)(Network, [{\n    key: \"backoffConfig\",\n    value: function backoffConfig() {\n      return (0, _assign2.default)(this.config.backoffConfigDefault, this.config.backoffConfigOverride);\n    }\n  }, {\n    key: \"retryWhenThrottled\",\n    value: function retryWhenThrottled() {\n      if (typeof this.config.retryWhenThrottledOverride !== 'undefined') {\n        return this.config.retryWhenThrottledOverride;\n      }\n\n      if (typeof this.config.retryWhenThrottledDefault !== 'undefined') {\n        return this.config.retryWhenThrottledDefault;\n      }\n\n      return false;\n    }\n  }, {\n    key: \"isExpired\",\n    value: function isExpired(timestamp) {\n      return !this.cacheLifetime || Date.now() - timestamp > this.cacheLifetime;\n    }\n  }, {\n    key: \"cleanupCache\",\n    value: function cleanupCache() {\n      var _iteratorNormalCompletion = true;\n      var _didIteratorError = false;\n      var _iteratorError = undefined;\n\n      try {\n        for (var _iterator = (0, _getIterator3.default)(this.cache), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n          var _ref = _step.value;\n\n          var _ref2 = (0, _slicedToArray3.default)(_ref, 2);\n\n          var k = _ref2[0];\n          var v = _ref2[1];\n\n          if (this.isExpired(v.timestamp)) {\n            this.cache.delete(k);\n          }\n        }\n      } catch (err) {\n        _didIteratorError = true;\n        _iteratorError = err;\n      } finally {\n        try {\n          if (!_iteratorNormalCompletion && _iterator.return) {\n            _iterator.return();\n          }\n        } finally {\n          if (_didIteratorError) {\n            throw _iteratorError;\n          }\n        }\n      }\n\n      if (this.cache.size === 0) {\n        clearInterval(this.timer);\n      }\n    }\n  }, {\n    key: \"pokeTimer\",\n    value: function pokeTimer() {\n      var _this2 = this;\n\n      this.timer = this.timer || setInterval(function () {\n        return _this2.cleanupCache();\n      }, this.cacheLifetime * 2);\n    }\n  }, {\n    key: \"executeWithRetry\",\n    value: function executeWithRetry(request) {\n      var _this3 = this;\n\n      var retryWhenThrottled = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n      return new _promise2.default(function (resolve, reject) {\n        var codesToRetryOn = [502, 503, 504];\n\n        if (retryWhenThrottled) {\n          codesToRetryOn.push(429);\n        }\n\n        var retrier = new operation_retrier_1.Retrier(_this3.backoffConfig());\n        retrier.on('attempt', function () {\n          request().then(function (result) {\n            return retrier.succeeded(result);\n          }).catch(function (err) {\n            if (codesToRetryOn.indexOf(err.status) > -1) {\n              retrier.failed(err);\n            } else if (err.message === 'Twilsock disconnected') {\n              // Ugly hack. We must make a proper exceptions for twilsock\n              retrier.failed(err);\n            } else {\n              // Fatal error\n              retrier.removeAllListeners();\n              retrier.cancel();\n              reject(err);\n            }\n          });\n        });\n        retrier.on('succeeded', function (result) {\n          resolve(result);\n        });\n        retrier.on('cancelled', function (err) {\n          return reject(err);\n        });\n        retrier.on('failed', function (err) {\n          return reject(err);\n        });\n        retrier.start();\n      });\n    }\n  }, {\n    key: \"get\",\n    value: function () {\n      var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(url) {\n        var _this4 = this;\n\n        var cacheEntry, headers, response;\n        return _regenerator2.default.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                cacheEntry = this.cache.get(url);\n\n                if (!(cacheEntry && !this.isExpired(cacheEntry.timestamp))) {\n                  _context.next = 3;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", cacheEntry.response);\n\n              case 3:\n                headers = {};\n                _context.next = 6;\n                return this.executeWithRetry(function () {\n                  return _this4.services.transport.get(url, headers);\n                }, this.retryWhenThrottled());\n\n              case 6:\n                response = _context.sent;\n                this.cache.set(url, {\n                  response: response,\n                  timestamp: Date.now()\n                });\n                this.pokeTimer();\n                return _context.abrupt(\"return\", response);\n\n              case 10:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function get(_x2) {\n        return _ref3.apply(this, arguments);\n      }\n\n      return get;\n    }()\n  }]);\n  return Network;\n}();\n\nexports.Network = Network;","map":{"version":3,"sources":["/home/ascencion/sebrae_megahack/node_modules/twilio-chat/browser/services/network.js"],"names":["_regenerator","require","_regenerator2","_interopRequireDefault","_asyncToGenerator2","_asyncToGenerator3","_promise","_promise2","_getIterator2","_getIterator3","_slicedToArray2","_slicedToArray3","_assign","_assign2","_map","_map2","_classCallCheck2","_classCallCheck3","_createClass2","_createClass3","obj","__esModule","default","Object","defineProperty","exports","value","operation_retrier_1","Network","config","services","_this","cache","cacheLifetime","session","getHttpCacheInterval","then","seconds","cleanupCache","key","backoffConfig","backoffConfigDefault","backoffConfigOverride","retryWhenThrottled","retryWhenThrottledOverride","retryWhenThrottledDefault","isExpired","timestamp","Date","now","_iteratorNormalCompletion","_didIteratorError","_iteratorError","undefined","_iterator","_step","next","done","_ref","_ref2","k","v","delete","err","return","size","clearInterval","timer","pokeTimer","_this2","setInterval","executeWithRetry","request","_this3","arguments","length","resolve","reject","codesToRetryOn","push","retrier","Retrier","on","result","succeeded","catch","indexOf","status","failed","message","removeAllListeners","cancel","start","_ref3","mark","_callee","url","_this4","cacheEntry","headers","response","wrap","_callee$","_context","prev","get","abrupt","transport","sent","set","stop","_x2","apply"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _getIterator2 = require(\"babel-runtime/core-js/get-iterator\");\n\nvar _getIterator3 = _interopRequireDefault(_getIterator2);\n\nvar _slicedToArray2 = require(\"babel-runtime/helpers/slicedToArray\");\n\nvar _slicedToArray3 = _interopRequireDefault(_slicedToArray2);\n\nvar _assign = require(\"babel-runtime/core-js/object/assign\");\n\nvar _assign2 = _interopRequireDefault(_assign);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar operation_retrier_1 = require(\"operation-retrier\");\n\nvar Network = function () {\n    function Network(config, services) {\n        var _this = this;\n\n        (0, _classCallCheck3.default)(this, Network);\n\n        this.config = config;\n        this.services = services;\n        this.cache = new _map2.default();\n        this.cacheLifetime = 0;\n        this.services.session.getHttpCacheInterval().then(function (seconds) {\n            _this.cacheLifetime = seconds * 1000;\n            _this.cleanupCache();\n        });\n    }\n\n    (0, _createClass3.default)(Network, [{\n        key: \"backoffConfig\",\n        value: function backoffConfig() {\n            return (0, _assign2.default)(this.config.backoffConfigDefault, this.config.backoffConfigOverride);\n        }\n    }, {\n        key: \"retryWhenThrottled\",\n        value: function retryWhenThrottled() {\n            if (typeof this.config.retryWhenThrottledOverride !== 'undefined') {\n                return this.config.retryWhenThrottledOverride;\n            }\n            if (typeof this.config.retryWhenThrottledDefault !== 'undefined') {\n                return this.config.retryWhenThrottledDefault;\n            }\n            return false;\n        }\n    }, {\n        key: \"isExpired\",\n        value: function isExpired(timestamp) {\n            return !this.cacheLifetime || Date.now() - timestamp > this.cacheLifetime;\n        }\n    }, {\n        key: \"cleanupCache\",\n        value: function cleanupCache() {\n            var _iteratorNormalCompletion = true;\n            var _didIteratorError = false;\n            var _iteratorError = undefined;\n\n            try {\n                for (var _iterator = (0, _getIterator3.default)(this.cache), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n                    var _ref = _step.value;\n\n                    var _ref2 = (0, _slicedToArray3.default)(_ref, 2);\n\n                    var k = _ref2[0];\n                    var v = _ref2[1];\n\n                    if (this.isExpired(v.timestamp)) {\n                        this.cache.delete(k);\n                    }\n                }\n            } catch (err) {\n                _didIteratorError = true;\n                _iteratorError = err;\n            } finally {\n                try {\n                    if (!_iteratorNormalCompletion && _iterator.return) {\n                        _iterator.return();\n                    }\n                } finally {\n                    if (_didIteratorError) {\n                        throw _iteratorError;\n                    }\n                }\n            }\n\n            if (this.cache.size === 0) {\n                clearInterval(this.timer);\n            }\n        }\n    }, {\n        key: \"pokeTimer\",\n        value: function pokeTimer() {\n            var _this2 = this;\n\n            this.timer = this.timer || setInterval(function () {\n                return _this2.cleanupCache();\n            }, this.cacheLifetime * 2);\n        }\n    }, {\n        key: \"executeWithRetry\",\n        value: function executeWithRetry(request) {\n            var _this3 = this;\n\n            var retryWhenThrottled = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n\n            return new _promise2.default(function (resolve, reject) {\n                var codesToRetryOn = [502, 503, 504];\n                if (retryWhenThrottled) {\n                    codesToRetryOn.push(429);\n                }\n                var retrier = new operation_retrier_1.Retrier(_this3.backoffConfig());\n                retrier.on('attempt', function () {\n                    request().then(function (result) {\n                        return retrier.succeeded(result);\n                    }).catch(function (err) {\n                        if (codesToRetryOn.indexOf(err.status) > -1) {\n                            retrier.failed(err);\n                        } else if (err.message === 'Twilsock disconnected') {\n                            // Ugly hack. We must make a proper exceptions for twilsock\n                            retrier.failed(err);\n                        } else {\n                            // Fatal error\n                            retrier.removeAllListeners();\n                            retrier.cancel();\n                            reject(err);\n                        }\n                    });\n                });\n                retrier.on('succeeded', function (result) {\n                    resolve(result);\n                });\n                retrier.on('cancelled', function (err) {\n                    return reject(err);\n                });\n                retrier.on('failed', function (err) {\n                    return reject(err);\n                });\n                retrier.start();\n            });\n        }\n    }, {\n        key: \"get\",\n        value: function () {\n            var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(url) {\n                var _this4 = this;\n\n                var cacheEntry, headers, response;\n                return _regenerator2.default.wrap(function _callee$(_context) {\n                    while (1) {\n                        switch (_context.prev = _context.next) {\n                            case 0:\n                                cacheEntry = this.cache.get(url);\n\n                                if (!(cacheEntry && !this.isExpired(cacheEntry.timestamp))) {\n                                    _context.next = 3;\n                                    break;\n                                }\n\n                                return _context.abrupt(\"return\", cacheEntry.response);\n\n                            case 3:\n                                headers = {};\n                                _context.next = 6;\n                                return this.executeWithRetry(function () {\n                                    return _this4.services.transport.get(url, headers);\n                                }, this.retryWhenThrottled());\n\n                            case 6:\n                                response = _context.sent;\n\n                                this.cache.set(url, { response: response, timestamp: Date.now() });\n                                this.pokeTimer();\n                                return _context.abrupt(\"return\", response);\n\n                            case 10:\n                            case \"end\":\n                                return _context.stop();\n                        }\n                    }\n                }, _callee, this);\n            }));\n\n            function get(_x2) {\n                return _ref3.apply(this, arguments);\n            }\n\n            return get;\n        }()\n    }]);\n    return Network;\n}();\n\nexports.Network = Network;"]},"metadata":{},"sourceType":"script"}